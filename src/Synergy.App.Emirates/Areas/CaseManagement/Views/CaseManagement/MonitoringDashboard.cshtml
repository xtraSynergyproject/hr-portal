@using Synergy.App.DataModel
@using Synergy.App.ViewModel
@*@using Kendo.Mvc.UI*@
@using Synergy.App.Common

@{
    ViewBag.Title = "Monitoring Dashboard";

    Layout = null;
}
@model TemplateViewModel;
<style>

    .btn-filter-reset {
        color: #fff;
        background-color: #428bca;
        border-color: #428bca;
    }

    .banner-text {
        position: absolute;
        top: 35px;
        left: 30px;
    }

    .k-datepicker {
        width: 9em !important;
    }

    .cell-completed {
        background-image: linear-gradient(to right, #40FA06, #162636);
    }

    .cell-text-completed {
        color: #13b713;
    }

    .cell-pending {
        background-color: #007bff;
        background-image: linear-gradient(to right, #0379EF, #162636);
    }

    .cell-text-pending {
        color: #007bff;
    }

    .cell-info {
        background-color: #17a2b8;
    }

    .cell-text-info {
        color: #17a2b8;
    }

    .caticon {
        width: 100px;
        height: 100px;
        border-radius: 6px;
    }

    .summary-card-body {
        width: 400px;
    }

    .card-number-div {
        height: 100% !important;
    }

    .status-count {
        height: 100px;
    }
</style>

<script>

    //var templateId = "@ViewBag.TemplateId";
    var templateId = "";

    $(document).ready(function () {

        @*$("#DepartmentId").kendoDropDownList({
            optionLabel: "@ApplicationConstant.PlaceHolder_AllOption",
            dataTextField: "Name",
            dataValueField: "Id",
            filter: "contains",
            dataSource:
            {
                transport:
                {
                    read:
                    {
                        dataType: "json",
                        url: "/CHR/HRCore/GetAllOrganisation",
                    }
                }
            },
            filtering: function (ev) {
                var filterValue = ev.filter != undefined ? ev.filter.value : "";
                ev.preventDefault();

                this.dataSource.filter({
                    logic: "or",
                    filters: [
                        {
                            field: "Name",
                            operator: "contains",
                            value: filterValue
                        },
                    ]
                });
            }
        });*@

        @*$("#TemplateType").kendoDropDownList({
            dataTextField: "DisplayName",
            dataValueField: "Id",
            optionLabel: "@ApplicationConstant.PlaceHolder_AllOption",
            dataSource: {
                transport: {
                    read: {
                        url: "/Cms/NtsService/ReadServiceTemplate?templateCode=@ViewBag.TemplateCodes&portalNames=@ViewBag.PortalNames",
                    }
                }
            }
        });

        $("#UserId").kendoDropDownList({
            dataTextField: "Name",
            dataValueField: "Id",
            optionLabel: "@ApplicationConstant.PlaceHolder_AllOption",
            filter: "contains",
            dataSource: {
                transport: {
                    read: {
                        url: "/cms/User/GetUserIdNameList?portalId=@ViewBag.PortalId",
                    }
                }
            }
        });*@

        $("#FromDate").kendoDatePicker({ format: "@ApplicationConstant.DateAndTime.DefaultJqueryDateFormat",});
        $("#ToDate").kendoDatePicker({ format: "@ApplicationConstant.DateAndTime.DefaultJqueryDateFormat",});

        monitoringDashboardGrid();
        caseSummaryGrid();

    });

    //Grid
    var columnDefs = [
        {
            headerName: "Service Type",
            field: "TemplateId",
            cellRenderer: params => {
                return "<a style='cursor:pointer;color:blue;' href='javascript:OnClickTemplate(\"" + params.data.TemplateId + "\");'>" + params.data.TemplateName + " </a>";
            }
        },
        { field: "PendingCount", headerName:"Pending" },
        { field: "CompletedCount", headerName: "Completed" },

    ];

    function monitoringDashboardGrid(st, dt) {

        st = (st != "" && st != undefined) ? st : "";
        dt = (dt != "" && dt != undefined) ? dt : "";

        var url = "/CaseManagement/CaseManagement/ReadMonitoringDashboarGridData?templateCodes=@ViewBag.TemplateCodes&portalNames=@ViewBag.PortalNames&userId=@ViewBag.UserId&st=" + st + "&dt=" + dt + "&pageType=Monitoring";
        document.getElementById("monitoringdashboardGridView").innerHTML = "";
        gridConfig(
           "monitoringdashboardGridView",
           url,
           columnDefs,
           false,
           true,
           true,
           true,
           1,
           true,
           10);

    }
    var status = '@Html.Raw(EnumExtension.EnumToJson(typeof(EmailInboxTypeEnum)))';
    var statusObj = JSON.parse(status);

    function caseSummaryGrid(templatecode,deptId,tempId,userId,st,dt) {

        templatecode = (templatecode != "" && templatecode != undefined) ? templatecode : "@ViewBag.TemplateCodes";
        deptId = (deptId != "" && deptId != undefined) ? deptId : "";
        tempId = (tempId != "" && tempId != undefined) ? tempId : "";
        userId = (userId != "" && userId != undefined) ? userId : "";
        st = (st != "" && st != undefined) ? st : "";
        dt = (dt != "" && dt != undefined) ? dt : "";

        var url = "/Nts/ReadNtsEmailList?templateCodes=" + templatecode + "&portalNames=@ViewBag.PortalNames&userId=@ViewBag.UserId&deptId=" + deptId + "&tempId=" + tempId + "&st=" + st + "&dt=" + dt;

        var source ={
            datatype: "json",
            id: 'TargetId',
            url: url
        };
        var dataAdapter = new $.jqx.dataAdapter(source);
        $("#grid").jqxGrid(
            {
                width: '100%',// getWidth('Grid'),
                source: dataAdapter,
                columnsresize: true,
                showcolumnlines: false,
                showcolumnheaderlines: false,
                filterable: true,
                sortable: true,
                groupable: true,
                    columns : [
        {
                            datafield: "NtsNo", text: "Service/Task No", cellsrenderer: function (row, column, value) {
                var datarow = $("#grid").jqxGrid('getrowdata', row);
                return "<div class='p-2'><a href=\"javascript:OpenService('" + datarow.ServiceId + "','" + datarow.TemplateCode + "', '" + datarow.TargetId + "','" + datarow.TargetType+"')\">" + value + "</a></div>";
            }
        },
                        { datafield: "Subject" },
                        { datafield: "MessageUserDepartmentName",text:"Department" },
                        { datafield: "TemplateName", text: "Service Type" },
                        { datafield: "FromUserName", text: "Service Owner" },
        {
            datafield: "InboxStatus", text: "Service Status", cellclassname: function (row, columnfield, value) {
                if (value == "@((int)(EmailInboxTypeEnum.Completed))") {
                    return "cell-completed text-light";
                } else if (value == "@((int)(EmailInboxTypeEnum.Pending))") {
                    return "cell-pending text-light";
                } else if (value == "@((int)(EmailInboxTypeEnum.Drafted))") {
                    return "cell-info text-light";
                }
            }, cellsrenderer: function (row, column, value) {
                return "<div class='p-2'>" + statusObj[value]+"</div>";
                            }

        },
        {
            datafield: "CreatedDate",
                            text: "Start Date", cellsrenderer: function (row, column, value) {
                                return "<div class='p-2'>" +  moment(value).format('@ApplicationConstant.DateAndTime.DefaultJqueryDateTimeFormatForMoment') + "</div>";
                            }
        },
        {
            datafield: "DueDate",
            text: "Due Date", cellsrenderer: function (row, column, value) {
                                return "<div class='p-2'>" +  moment(value).format('@ApplicationConstant.DateAndTime.DefaultJqueryDateTimeFormatForMoment') + "</div>";
                            }
        }
                ]
            }
        );
    }

    function OnClickTemplate(tempId) {
        templateId = tempId;
        document.getElementById("serpendingCount").innerHTML = "";
        document.getElementById("sercompletedCount").innerHTML = "";
        document.getElementById("compendingCount").innerHTML = "";
        document.getElementById("comcompletedCount").innerHTML = "";

        @*templatecode = (templatecode != "" && templatecode != undefined) ? templatecode : "@ViewBag.TemplateCodes";*@
        //deptId = (deptId != "" && deptId != undefined) ? deptId : "";
        @*userId = (userId != "" && userId != undefined) ? userId : "@ViewBag.UserId";*@

        tempId = (tempId != "" && tempId != undefined) ? tempId : "";
        var st = kendo.toString($("#FromDate").data("kendoDatePicker").value(), 'yyyy/MM/dd');
        var dt = kendo.toString($("#ToDate").data("kendoDatePicker").value(), 'yyyy/MM/dd');

        caseSummaryGrid("@ViewBag.TemplateCodes", "", tempId, "", st, dt)

        var url = "/CaseManagement/CaseManagement/GetNtsEmailStatusCountByTemplate?templateCodes=@ViewBag.TemplateCodes&portalNames=@ViewBag.PortalNames&userId=@ViewBag.UserId&tempId=" + tempId + "&st=" + st + "&dt=" + dt + "&pageType=Monitoring";

        $.ajax({
                url: url,
                type: 'GET',
                data: {},
                dataType: 'json',
                success: function (result) {

                    if (result.success) {
                        document.getElementById("serpendingCount").innerHTML = result.serpending;
                        document.getElementById("sercompletedCount").innerHTML = result.sercompleted;
                        document.getElementById("compendingCount").innerHTML = result.compending;
                        document.getElementById("comcompletedCount").innerHTML = result.comcompleted;
                    }
                    else {

                        evt.preventDefault();
                        return false;
                    }
                },
                error: function (ert) {
                    ShowNotification(ert, "error");
                }
        });
    }



    function getIssueChart(temp,deptId,tempId,userId,st,dt) {

        deptId = (deptId != "" && deptId != undefined) ? deptId : "";
        tempId = (tempId != "" && tempId != undefined) ? tempId : "";
        userId = (userId != "" && userId != undefined) ? userId : "@ViewBag.UserId";
        st = (st != "" && st != undefined) ? st : "";
        dt = (dt != "" && dt != undefined) ? dt : "";

        var url = "/CaseManagement/CaseManagement/GetStatusChartByTemplateCode?tempCode=" + temp + "&userId=" + userId + "&deptId=" + deptId + "&tempId=" + tempId + "&st=" + st + "&dt=" + dt;
            $.ajax({
                type: 'GET',
                url: url,
                success: function (res) {
                    if (res) {

                        var chartid = "requestchart";
                        var vals = res.ItemValueSeries;
                        itcode = res.Code;
                        var chart = "#"+chartid;
                        var options = {
                            series: vals,
                            //title: {
                            //    text: "Task By Status"
                            //},
                            chart: {
                                id: chartid,
                                width: 240,
                                height: 230,
                                type: 'pie',
                                events: {
                                    dataPointSelection: function (event, chartContext, config) {

                                        var status = config.w.config.labels[config.dataPointIndex];
                                        var code = config.w.config.chart.id;
                                        var statusCode = '';
                                        if (status === 'Drafted') {
                                            statusCode = 'SERVICE_STATUS_DRAFT';
                                        } else if (status === 'Pending') {
                                            statusCode = 'SERVICE_STATUS_INPROGRESS,SERVICE_STATUS_OVERDUE';
                                        } else if (status === 'Overdue') {
                                            statusCode = 'SERVICE_STATUS_OVERDUE';
                                        } else if (status === 'Completed') {
                                            statusCode = 'SERVICE_STATUS_COMPLETE';
                                        } else if (status === 'Reject' || status === 'Canceled') {
                                            statusCode = 'SERVICE_STATUS_REJECT,SERVICE_STATUS_CANCEL';
                                        }
                                        getServiceList(statusCode, itcode);
                                    }
                                }
                            },
                            noData: {
                                text: "!No Data Found",
                                align: 'center',
                                verticalAlign: 'middle',
                                offsetX: 0,
                                offsetY: 0,
                                style: {
                                    color: "#363642",
                                    fontSize: '14px',
                                }
                            },
                            legend: {
                                position: 'bottom'
                            },
                            labels: res.ItemValueLabel,
                            //colors: ['#f10b0b', '#13b713', '#f2a818', '#008ffb', '#f2a818'],
                            colors: res.ItemStatusColor,
                            dataLabels: {
                                enabled: true,
                                style: {
                                    colors: ['#000']
                                },
                            },

                        };

                        document.getElementById(chartid).innerHTML = "";
                        var chart = new ApexCharts(document.querySelector(chart), options);
                        chart.render();
                    }
                }
            });

    }

    function GoToInbox(targetType1, targetType2) {
        var st = kendo.toString($("#FromDate").data("kendoDatePicker").value(), 'yyyy/MM/dd');
        var dt = kendo.toString($("#ToDate").data("kendoDatePicker").value(), 'yyyy/MM/dd');

        LoadPartailView('@Url.Action("NtsEmailPage", "Nts",new { area= "Core" })?userId=@ViewBag.UserId&portalNames=@ViewBag.PortalNames&returnPageName=@ViewBag.PageName&templateCodes=@ViewBag.TemplatesCodes&catCodes=@ViewBag.CategoryCodes&groupCodes=@ViewBag.GroupCodes&tempId=' + templateId + '&targetType1=' + targetType1 + '&targetType2=' + targetType2 + '&st=' + st + '&dt=' + dt, $('#cms-content'));
    }

    @*function OnOpen(id, templateCode, ntsType) {

        var portalId = $("#GlobalPortalId").val();
        var pageType = ntsType == "@((int)(NtsTypeEnum.Service))" ? "Service" : "Task";
        var title = ntsType == "@((int)(NtsTypeEnum.Service))" ? "Service Request" : "View Task";
        var url = '/Cms/Page?lo=Popup&popup=true&cbm=OnAfterCreate&source=Edit&dataAction=Edit&pageType=' + pageType + '&templateCodes=' + templateCode + '&portalId=' + portalId + '&recordId=' + id;
        var win = GetMainWindow();
        win.iframeOpenUrl = url;
        win.OpenWindow({ Title: title, Width: 1200, Height: 700 });
        return false;
    }*@

    function OpenService(id, templateCode, tid, ttype) {
        var portalId = $("#GlobalPortalId").val();
        var url = '/Cms/Page?lo=Popup&popup=true&cbm=OnAfterServiceCreate&source=View&dataAction=View&templateCodes=' + templateCode + '&portalId=' + portalId + '&recordId=' + id + '&targetId=' + tid + '&targetType=' + ttype;
        var win = GetMainWindow();
        win.iframeOpenUrl = url;
        win.OpenWindow({ Title: 'View', Width: 1200, Height: 700 });
        return false;
    }

    function OnCreateService() {
        var url = '/Cms/NtsService/SelectServiceTemplate?templateCode=@ViewBag.TemplateCodes&userId=@ViewBag.UserId&cbm=OnAfterServiceCreate&portalNames=@ViewBag.PortalNames';
        var win = GetMainWindow();
        win.iframeOpenUrl = url;
        win.OpenWindow({ Title: 'Select Service', Width: 1000, Height: 600, Position: 'Right1' });
        return false;
    }

    function OnFilter() {
        //var dept = $("#DepartmentId").data("kendoDropDownList").value();
        //var temp = $("#TemplateType").data("kendoDropDownList").value();
        //var user = $("#UserId").data("kendoDropDownList").value();
        var st = kendo.toString($("#FromDate").data("kendoDatePicker").value(), 'yyyy/MM/dd');
        var dt = kendo.toString($("#ToDate").data("kendoDatePicker").value(), 'yyyy/MM/dd');

        monitoringDashboardGrid(st, dt);
        OnClickTemplate(templateId);
        caseSummaryGrid();
    }

    function OnResetFilter() {
        $("#FromDate").data("kendoDatePicker").value("");
        $("#ToDate").data("kendoDatePicker").value("");
        monitoringDashboardGrid();
        OnClickTemplate(templateId);
        caseSummaryGrid();
    }

</script>


<div id="appWrapper" class="wrapper">
    <div class="page">
        <div class="page-inner">
            <div class="page-section">
                <div class="row no-gutters p-2">
                    <div class="col-lg-6 col-md-12">
                        <h5 class="text-dark">@ViewBag.Title</h5>
                    </div>
                    <div class="col-lg-6 col-md-12 text-right">
                        @if (ViewBag.AllowCreation != null && ViewBag.AllowCreation == true)
                        {
                            <button class="btn btn-primary btn-primary-grd" onclick="OnCreateService();">Create New Service</button>
                        }

                    </div>
                </div>
                @*<div class="row p-2 mb-2">
                        <div class="col-lg-4 col-md-4 col-sm-12">Department
                            <input id="DepartmentId" style="width:100%!important" />
                        </div>
                        <div class="col-lg-4 col-md-4 col-sm-12">Template
                            <input id="TemplateType" style="width:100%!important" />
                        </div>
                        <div class="col-lg-4 col-md-4 col-sm-12">User
                            <input id="UserId" style="width:100%!important" />
                        </div>
                    </div>*@
                <div class="row p-3 mb-3 ml-2 mr-2 jumbotron">
                    <div class="col-lg-4 col-md-4 col-sm-12">
                        From Date
                        <input id="FromDate" style="width:100%!important" />
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-12">
                        To Date
                        <input id="ToDate" style="width:100%!important" />
                    </div>

                    <div class="col-lg-4 col-md-4 col-sm-12" style="padding-top:20px;">
                        <button class="btn btn-primary btn-primary-grd" onclick="OnFilter();">Search</button>
                        <button class="btn btn-secondary" onclick="OnResetFilter();" style="margin-right:10px;">Reset</button>
                    </div>
                </div>
                <div class="row-12" style="padding:10px;">
                    <div id="monitoringdashboardGridView" style="width: 100%;height:250px" class="ag-theme-alpine"></div>
                </div>
                <div class="row" style="padding:10px;">
                    <div class="col-sm-12 col-md-2 col-lg-1"></div>
                    <div class="col-sm-12 col-md-6 col-lg-4">
                        <!-- .card -->
                        <div class="card">
                            <div class="card-header text-center bg-primary bg-primary-grd text-white">Service By Status</div><!-- .card-body -->
                            <div class="card-body chart-body" style="height:220px;">
                                <div class="row">
                                    <div class="col-6 cell-text-pending status-count">
                                        <div class="p-2 mt-3 row" style="text-align:center;cursor:pointer;" onclick="GoToInbox('@NtsEmailTargetTypeEnum.Service','@NtsEmailTargetTypeEnum.StepTask');">
                                            <div class="col-5 " style="font-size:2.5em;"><i class="fa fa-check-double text-warning"></i></div>
                                            <div class="col-7 text-dark" style="font-size:3em;" id="serpendingCount">@ViewBag.SerPenCount</div>
                                            <div class="col-12 cell-pending" style="height:8px; border-radius:4px;">&nbsp;</div>
                                            <div class="col-12 pt-2" style="font-size:.8em;">PENDING</div>
                                        </div>
                                    </div>
                                    <div class="col-6 cell-text-completed status-count">
                                        <div class="p-2  mt-3 row" style="text-align:center;cursor:pointer;" onclick="GoToInbox('@NtsEmailTargetTypeEnum.Service','@NtsEmailTargetTypeEnum.StepTask');">
                                            <div class="col-5 " style="font-size:2.5em;"><i class="fa fa-clipboard-check text-complete"></i></div>
                                            <div class="col-7 text-dark" style="font-size:3em;" id="sercompletedCount">@ViewBag.SerComCount</div>
                                            <div class="col-12 cell-completed" style="height:8px; border-radius:4px;">&nbsp;</div>
                                            <div class="col-12 pt-2" style="font-size:.8em;">COMPLETED</div>
                                        </div>
                                    </div>
                                </div>
                            </div><!-- /.card-body -->
                        </div><!-- /.card -->
                    </div>
                    <div class="col-sm-12 col-md-2 col-lg-2"></div>
                    <div class="col-sm-12 col-md-6 col-lg-4">
                        <!-- .card -->
                        <div class="card">
                            <div class="card-header text-center bg-success bg-success-grd text-white">Communication By Status</div><!-- .card-body -->
                            <div class="card-body chart-body" style="height:220px;">
                                <div class="row">
                                    <div class="col-6 cell-text-pending status-count">
                                        <div class="p-2  mt-3 row" style="text-align:center;cursor:pointer;" onclick="GoToInbox('@NtsEmailTargetTypeEnum.Service','@NtsEmailTargetTypeEnum.StepTask');">
                                            <div class="col-5" style="font-size:2.5em;"><i class="fa fa-check-double text-warning"></i></div>
                                            <div class="col-7 text-dark" style="font-size:3em;" id="compendingCount">@ViewBag.CommPenCount</div>
                                            <div class="col-12 cell-pending" style="height:8px; border-radius:4px;">&nbsp;</div>
                                            <div class="col-12 pt-2" style="font-size:.8em;">PENDING</div>
                                        </div>
                                    </div>
                                    <div class="col-6 cell-text-completed status-count">
                                        <div class="p-2 mt-3 row" style="text-align:center;cursor:pointer;" onclick="GoToInbox('@NtsEmailTargetTypeEnum.Service','@NtsEmailTargetTypeEnum.StepTask');">
                                            <div class="col-5" style="font-size:2.5em;"><i class="fa fa-clipboard-check text-complete"></i></div>
                                            <div class="col-7 text-dark" style="font-size:3em;" id="comcompletedCount">@ViewBag.CommComCount</div>
                                            <div class="col-12 cell-completed" style="height:8px; border-radius:4px;">&nbsp;</div>
                                            <div class="col-12 pt-2" style="font-size:.8em;">COMPLETED</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div><!-- /.card -->
                    </div>
                    <div class="col-sm-12 col-md-2 col-lg-1"></div>
                </div>

                <div style="padding:10px;">
                    <div class="row">
                        <div class="col-6"><h5 class="text-dark">Service Details</h5></div>
                        @*<div class="col-6"><div id="TemplateType" class="form-control" style="width:50%;float:right;"></div></div>*@
                    </div>
                    <hr />
                    <div class="row">
                        <div class="col-12 default">
                            <div id="grid">
                            </div>
                            @*<div id="casesummaryGridView" style="width: 100%;height:550px" class="ag-theme-alpine"></div>*@
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
