@inject IStringLocalizer<CMS.UI.Web.Areas.PortalAdmin.Controllers.UserGroupController> Resource
@using Synergy.App.ViewModel;
@using Synergy.App.Common;
@*@using Kendo.Mvc.UI;*@
@using Newtonsoft.Json;
@{
    ViewData["Title"] = "Manage User Group";
    /// Layout = "~/Areas/Core/Views/Shared/_PopupLayout.cshtml";
    Layout = ViewBag.Layout;
}

@model UserGroupViewModel

<style>

    .required {
        color: red;
    }
</style>

<script>

    $(document).ready(function () {

        $("#UserIds").kendoMultiSelect({
            dataTextField: "Name",
            dataValueField: "Id",
            dataSource: new kendo.data.DataSource({
                transport: {
                    read: {
                        url: "/PortalAdmin/User/GetUserIdNameList",
                        dataType: "json"
                    }
                },
            }),
            autoClose: false,
            placeholder: "Select User...",
            value: @Html.Raw(JsonConvert.SerializeObject(Model.UserIds)),
            valuePrimitive: true,
            serverFiltering: true,
            filter: '@FilterType.Contains',
            change: OnChange
        });

        var dataSource = new kendo.data.DataSource({
            transport: {
                read: {
                    url: "/PortalAdmin/User/GetUsersListView",
                    data: FilterDDl,
                    dataType: "json"
                }
            },
        });
         $("#AllowedPortal").kendoMultiSelect({
            dataTextField: "Name",
            dataValueField: "Id",
            dataSource: new kendo.data.DataSource({
                transport: {
                    read: {
                        url: "/PortalAdmin/UserGroup/GetAllowedPortals",
                        dataType: "json"
                    }
                },
            }),
            autoClose: false,
            placeholder: "Select Portal...",
            value: @Html.Raw(JsonConvert.SerializeObject(Model.AllowedPortalIds)),
            valuePrimitive: true,
            serverFiltering: true,
            filter: '@FilterType.Contains',
        });

        $("#UserlistView").kendoListView({
            dataSource: dataSource,
            template: kendo.template($("#template").html())
        });

        if ('@ViewBag.Success' == "True") {
            closeNavMemberGroup();
            window.parent.getDataUserGroup();
           // if (window.parent.$("#Teamgrid").data("kendoGrid").dataSource.read()) { }
        }
        else {
            var search = FilterDDl();
            $("#UserlistView").data("kendoListView").dataSource.read(search)
        }

    });

    function OnSave(evt) {

        var portals = $('#AllowedPortal').val();
        if (portals.length > 0) {
            return true;
        } else {
            $(".text-danger").removeClass("validation-summary-valid");
            $(".text-danger").addClass("validation-summary-errors");
            $(".text-danger").html("Select Portal");
            evt.preventDefault();
            window.scrollTo(0, 0);
            return false;

        }
    }

    var onAjaxSuccess = function (res) {

        if (res.success) {
            if ('@Model.DataAction'=='@DataActionEnum.Create')
            {
                ShowNotification("@SharedResource["SavedSuccessfully"]", "success");
            }
            if ('@Model.DataAction'=='@DataActionEnum.Edit')
            {
                ShowNotification("@SharedResource["UpdatedSuccessfully"]", "success");
            }
            var TemplateId = res.templateId;
            closeNavMemberGroup();
            //window.parent.$("#UserRolegrid").data("kendoGrid").dataSource.read();
        }
        else {
            console.log(res)
            showError(res.error);
        }
    };
    var showError = function (error) {
        //#validation-summary-manageform
        $("#validation-summary").html(error);
        $("#validation-summary").css("display", "block")
    }
   @* function OnChange(e)
    {
        var search = FilterDDl();
        $("#UserlistView").data("kendoListView").dataSource.read(search)
    }

    function FilterDDl() {
        ($("#UsersIds").val());
        var multiselect = $("#UserIds").data("kendoMultiSelect");
        var multiselectvalue = multiselect.value();
        return {
            selectedValues: multiselectvalue.join()
        };
    }*@
    @*$(document).ready(function () {
        var search = FilterDDl();
        $("#UserlistView").data("kendoListView").dataSource.read(search)
        if ('@ViewBag.Success' == "True") {
            closeNavMemberGroup();
            if (window.parent.$("#UserRolegrid").data("kendoGrid").dataSource.read()) { }
        }

    });*@
    @*$(document).ready(function () {
        if ('@ViewBag.Success' == "True") {
            closeNavMemberGroup();
            if (window.parent.$("#UserRolegrid").data("kendoGrid").dataSource.read()) { }
        }
        else {
            var search = FilterDDl();
            $("#UserlistView").data("kendoListView").dataSource.read(search)
        }
    });

    function closeNavMemberGroup() {

        var win = GetMainWindow();
        win.CloseWindow();
        return false;
    }*@
    function OnChange(e)
    {
        var search = FilterDDl();
        $("#UserlistView").data("kendoListView").dataSource.read(search);
    }

    function FilterDDl() {
       // ($("#UsersIds").val());
        var multiselect = $("#UserIds").data("kendoMultiSelect");
        var multiselectvalue = multiselect.value();
        return {
            selectedValues: multiselectvalue.join()
        };
    }

    function closeNavMemberGroup() {

        var win = GetMainWindow();
        win.CloseWindow({ MethodName:"RefreshGrid"});
        return false;
    }

</script>

<div class="row" style="margin-left:15px;">

    <form asp-controller="UserGroup" asp-action="ManageUserGroup" method="post" class="form-horizontal" id="myForm" data-ajax-begin="onAjaxBegin" data-ajax-complete="onAjaxComplete"
          data-ajax-failure="onAjaxFailed" data-ajax-success="onAjaxSuccess"
          data-ajax="true" data-ajax-method="POST">
        <div class="text-danger" style="width:300px;" asp-validation-summary="All" id="validation-summary"></div>

        <div class="row" style="padding:10px;margin-right:15px;">

            <div class="col-12 pad-10">
                <div class="form-label-group">
                    <input asp-for="Name" type="text" class="form-control" placeholder="Enter Name" required="required" autocomplete="off" />
                    <label for="Name">@SharedResource["Name"] <span class="required">*</span></label>
                </div>
            </div>
            <div class="col-12 pad-10">
                <div class="form-label-group">
                    <input asp-for="Code" type="text" class="form-control" placeholder="Enter Code" autocomplete="off" />
                    <label for="Code">@SharedResource["Code"]</label>
                </div>
            </div>

            <div class="col-12 pad-10">
                <div class="form-label-group">

                    <input asp-for="Description" type="text" class="form-control" placeholder="Description" autocomplete="off" />
                    <label for="SequenceOrder">@SharedResource["Description"]</label>
                </div>
            </div>

            @*<div class="col-12 pad-10">Status</div>
                <div class="col-12 pad-10">
                    @(Html.Kendo().DropDownListFor(x=>x.Status)
                            .DataTextField("Name")
                            .DataValueField("Id")
                            .DataSource(source =>
                            {
                            source.Read(read =>
                            {
                                read.Action("GetEnumIdNameList", "Home", new { @area = "", enumType = "StatusEnum" });
                            });
                            })
                            .Value(Model.Status.ToString())
                            .HtmlAttributes(new { @class = "form-control" })
                            )
                </div>*@
            <div class="col-12 pad-10">
                <label for="Users">@SharedResource["Users"] </label>

                <select asp-for="UserIds" id="UserIds" class="hr-xx-large"></select>
            </div>
            <div class="col-12 pad-10">
                <label>@Resource["SelectedUsers"] </label>

                <div id="UserlistView"></div>
            </div>

            <div class="col-12 pad-10">
                <label>Allowed Portals <span class="required">*</span></label>
                <br />

                <select asp-for="AllowedPortalIds" id="AllowedPortal" data-placeholder="--Select--" style="width:100%"></select>
            </div>


            <div class="cms-slidebar-footer">
                <button type="button" class="btn btn-light" onclick="closeNavMemberGroup();">@SharedResource["Close"]</button>
                <input type="submit" class="btn btn-primary" value="@SharedResource["Save"]" id="submitBtn" onclick="OnSave(event);" />
            </div>

        </div>
        @Html.HiddenFor(x => x.Id)
        @Html.HiddenFor(x => x.DataAction)
        @Html.HiddenFor(x => x.LegalEntityId)
        @Html.HiddenFor(x => x.PortalId)
    </form>
</div>
<script type="text/x-kendo-tmpl" id="template">
    <div class="row col-12" style="margin:5px;">
    @*<div class="col-3">
    <span>#:Id#</span>
    </div>*@
    <div class="col-9">
      <span>#:Name#</span>
    </div>
    </div>
</script>

<script type="text/javascript">


</script>