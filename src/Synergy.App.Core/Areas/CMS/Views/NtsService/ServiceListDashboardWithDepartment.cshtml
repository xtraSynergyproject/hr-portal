@using Synergy.App.ViewModel;
@*@using Kendo.Mvc.UI;*@
@using Synergy.App.Common;
@*@using Kendo.Mvc.Extensions;*@
@model EGovDashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
    //Layout = "~/Areas/Core/Views/Shared/_PopupLayout.cshtml";
    // Layout = "/Areas/Cms/Views/Shared/_LayoutCms.cshtml";
    Layout = null;

}
<link type="text/css" rel="stylesheet" href="~/css/cms/DashBoard.css" asp-append-version="true" />
<style>
    .summary-card {
        width: 400px;
        margin-right: 100px;
    }

    .summary-card-body {
        width: 400px;
    }

    .border-right {
        border-right: 1px solid #006699 !important;
    }
    .summary-card-header {
        width: 400px;
    }
    .card {        
         box-shadow:none !important; 
    }
</style>

<script type="text/javascript">
    function onBack()
    {
        window.location.href = "@ViewBag.ReturnUrl";
    }
    $('#left').click(function () {
        $(".k-listview-content").animate({scrollLeft: "-=1075px"}, "slow");
    });

    $('#right').click(function () {

        //event.preventDefault();
        $(".k-listview-content").animate({ scrollLeft: "+=1075px"}, "slow");
    });

    function CreateService() {
        var url = '@Url.Action("SelectServiceTemplate", "NtsService",new {area="Cms" })?categoryCode=@ViewBag.CategoryCodes&userId=' + '@ViewBag.UserId';
        var win = GetMainWindow();
        win.iframeOpenUrl = url;
        win.OpenWindow({ Title: 'Select Service', Width: 1000, Height: 600, Position: 'Right1' });
        return false;
    }

    function getList(tempcode, statusCode) {
        getEmployeeDashboardData(tempcode, statusCode);
    }

    function OpenService(serviceId, templateCode) {

        var portalId = $('#GlobalPortalId').val();
        var url = '/Cms/Page?lo=Popup&popup=true&cbm=OnAfterService&source=View&dataAction=View&templateCodes=' + templateCode +'&portalId=' + portalId + '&recordId=' + serviceId;

        var win = GetMainWindow();
        win.iframeOpenUrl = url;
        win.OpenWindow({ Title: 'View Service', Width: 1200, Height: 700 });
        return false;
    }

    function OpenTask(taskId, tempCode) {

        var id = taskId;
        var source = '@RequestSourceEnum.Edit.ToString()';
        var action = '@DataActionEnum.Edit.ToString()';

        var portalId = $('#GlobalPortalId').val();

        var url = '/Cms/Page?lo=Popup&pageType=Task&cbm=OnAfterService&source=' + source + '&dataAction=' + action + '&templateCodes=' + tempCode + '&portalId=' + portalId + '&recordId=' + id;
        var win = GetMainWindow();
        win.iframeOpenUrl = url;
        win.OpenWindow({ Title:  "Task", Width: 1200, Height: 600 });
        return false;
    }


    function OnAfterService() {
        $("#servicecount").data("kendoListView").dataSource.read();
        getEmployeeDashboardData();
    }

    var columnDefs = [
        {
            headerName: "Service No",
            field: "ServiceNo",
            cellRenderer: params => {
                return "<input type='button' class='btn btn-link' onclick='OpenService(\"" + params.data.Id + "\",\"" + params.data.TemplateCode + "\" )' value=\"" + params.value + "\" />";
            }
        },
        {
            headerName: "Department",
            field: "DepartmentName",
        },
        {
            headerName: "Service",
            field: "ServiceName",
        },
        {
            headerName: "Service Status",
            field: "WorkflowStatus",
        },
        {
            headerName: "Service Status",
            field: "ServiceStatusName",
            cellRenderer: params => {
                if (params.value == "Completed") {
                    return "<label class='text-success' style='font-weight:400;'>" + params.value + "</label>"
                }
                else if (params.value == "Draft") {
                    return "<label class='text-info' style='font-weight:400;'>" + params.value + "</label>"
                }
                else if (params.value == "In Progress") {
                    return "<label class='text-primary' style='font-weight:400;'>" + params.value + "</label>"
                }
                else if (params.value == "Overdue") {
                    return "<label class='text-warning' style='font-weight:400;'>" + params.value + "</label>"
                }
                else {
                    return "<label class='text-default' style='font-weight:400;'>" + params.value + "</label>"
                }
                //return "<label #if(\"" + params.value + "\"=='Completed'){# class='btn btn-success' #}else if(\"" + params.value + "\"=='In Progress'){# class='btn btn-primary' #}else if(\"" + params.value + "\"=='Overdue'){# class='btn btn-warning' #}else if(\"" + params.value + "\"=='Rejected'){# class='btn btn-danger' #}#>" + params.value + "</label>";
            }
        },
        {
            headerName: "Requested By",
            field: "OwnerDisplayName",
        },
        {
            headerName: "Requested Date",
            field: "CreatedDate",
            cellRenderer: params => {
                return moment(params.value).format('@ApplicationConstant.DateAndTime.DefaultJqueryDateTimeFormatForMoment');
                //var date = new Date(params.value);
                //return datefun(date);
            }
        },
        {
            headerName: "Due Date",
            field: "DueDate",
            cellRenderer: params => {
                return moment(params.value).format('@ApplicationConstant.DateAndTime.DefaultJqueryDateTimeFormatForMoment');
                //var date = new Date(params.value);
                //return datefun(date);
            }
        },

    ];

    function getEmployeeDashboardData(catcode, statusCode,deptId,tempId,userId) {
        document.getElementById("kGridView").innerHTML = "";

        var catcodes = '@ViewBag.CategoryCodes';
        if (catcode!=null) {
            catcodes = catcode;
        }
        var statuscodes = statusCode;
        if (statuscodes == undefined) {
            statuscodes = "";
        }
        if (deptId == undefined) {
            deptId = "";
        }
        if (tempId == undefined) {
            tempId = "";
        }
        if (userId == undefined) {
            userId = "";
        }
        /*alert(tempcodes);*/
        gridConfig(
            "kGridView",
            "/cms/NtsService/ReadServiceDataWithDepartment?categoryCodes=" + catcodes + "&templateCodes=@ViewBag.TemplateCodes&portalNames=@ViewBag.PortalNames&moduleCodes=@ViewBag.ModuleCodes&serviceStatus=" + statuscodes + "&departmentId=" + deptId + "&templateId=" + tempId + "&userId=" + userId,
            columnDefs,
            false,
            true,
            true,
            true,
            1,
            true,
            10);
    }


    function datefun(d) {
        let h = addZero(d.getHours());
        let m = addZero(d.getMinutes());
        return d.getDate() + "/" + (d.getMonth() + 1) + "/" + d.getFullYear() + " " + h + ":" + m;
    }

    function addZero(i) {
        if (i < 10) { i = "0" + i }
        return i;
    }

    function OnChange() {
        var dept = $("#DepartmentId").data("kendoDropDownList").value();
        var temp = $("#TemplateType").data("kendoDropDownList").value();
        var user = $("#UserId").data("kendoDropDownList").value();
        getEmployeeDashboardData(null, null, dept, temp, user);
        ListView(dept, temp, user);
        //var search = FilterDDl();
        //$("#servicecount").data("kendoListView").dataSource.read(search);
    }

    //function OnChange(e) {
    //    var search = Filter();
    //    $("#TemplatelistView").data("kendoListView").dataSource.read(search)
    //}

    function Filter() {

        var dept = $("#DepartmentId").data("kendoDropDownList").value();
        var temp = $("#TemplateType").data("kendoDropDownList").value();
        var user = $("#UserId").data("kendoDropDownList").value();
        return {
            departmentId: dept,
            templateId: temp,
            userId:user
        };
    }

    $(function () {

        $("#DepartmentId").kendoDropDownList({
            optionLabel: "@ApplicationConstant.PlaceHolder_AllOption",
            dataTextField: "Name",
            dataValueField: "Id",
            filter: "contains",
            change: OnChange,
            @*value: '@Model.DepartmentId',*@
            dataSource:
            {
                //serverFiltering: true,
                transport:
                {
                    read:
                    {
                        dataType: "json",
                        url: "/CHR/HRCore/GetAllOrganisation",
                    }
                }
            },
            filtering: function (ev) {
                var filterValue = ev.filter != undefined ? ev.filter.value : "";
                ev.preventDefault();

                this.dataSource.filter({
                    logic: "or",
                    filters: [
                        {
                            field: "Name",
                            operator: "contains",
                            value: filterValue
                        },
                    ]
                });
            }
        });

        $("#TemplateType").kendoDropDownList({
            dataTextField: "DisplayName",
            dataValueField: "Id",
            optionLabel: "@ApplicationConstant.PlaceHolder_AllOption",
            change: OnChange,
            dataSource: {
                transport: {
                    read: {
                        url: "/Cms/NtsService/ReadServiceTemplate?templateCode=@ViewBag.TemplateCodes&portalNames=@ViewBag.PortalNames",
                    }
                }
            }
        });

        $("#UserId").kendoDropDownList({
            dataTextField: "Name",
            dataValueField: "Id",
            optionLabel: "@ApplicationConstant.PlaceHolder_AllOption",
            filter: "contains",
            change: OnChange,
            dataSource: {
                transport: {
                    read: {
                        url: "/cms/User/GetUserIdNameList?portalId=@ViewBag.PortalId",
                    }
                }
            }
        });

        ListView();
        getEmployeeDashboardData();

        $.contextMenu({
            selector: '#tree-menu1',
            trigger: 'left',
            build: function ($trigger, e) {

                var id = $trigger.data('idvalue');

                //var portalName = $trigger.data('portal-name');

                switch (0) {
                    case 0:
                        return {
                            callback: function (key, options) {
                                switch (key) {
                                    case 'edit':
                                        break;
                                    case 'delete':
                                        break;
                                    default:
                                }
                            },
                            items: {
                                "edit": { name: "Edit", icon: "fas fa-edit" },
                                "delete": { name: "Delete", icon: "fas fa-trash" },
                            }
                        };
                }
            }
        });

    });

    function ListView(deptId, tempId, userId) {

        if (deptId == undefined) {
            deptId = "";
        }
        if (tempId == undefined) {
            tempId = "";
        }
        if (userId == undefined) {
            userId = "";
        }

        document.getElementById("servicecount").innerHTML = "";

        var url = "/cms/NtsService/ReadServiceListCountWithDepartment?categoryCodes=@ViewBag.CategoryCodes&templateCodes=@ViewBag.TemplateCodes&moduleCodes=@ViewBag.ModuleCodes&portalNames=@ViewBag.PortalNames&departmentId="+deptId+"&templateId="+tempId+"&userId="+userId;
        var dataSource = new kendo.data.DataSource({
            transport: {
                read: {
                    url: url,
                    dataType: "json"
                }
            },
        });

        $("#servicecount").kendoListView({
            dataSource: dataSource,
            template: kendo.template($("#templateservicecount").html()),
             dataBound: function () {
                 var data = $("#servicecount").data("kendoListView").dataSource.data();
                 for (var i = 0; i < data.length; i++) {
                     console.log(data[i]);
                     var vals = [data[i].CreatedByMeInProgreessOverDueCount, data[i].CreatedByMeCompleteCount, data[i].CreatedOrRequestedByMeRejectCancelCloseCount];
                     var chart = "#chart_" + data[i].TemplateCode;
                     var options = {
                         series: vals,
                         chart: {
                             id: data[i].TemplateCode,
                             width: 250,
                             height: 250,
                             type: 'pie',
                             events: {
                                 dataPointSelection: function (event, chartContext, config) {
                                     var status=config.w.config.labels[config.dataPointIndex];
                                     var code = config.w.config.chart.id;
                                     var statusCode = '';
                                     debugger;
                                     if (status ==='Pending') {
                                         statusCode = 'SERVICE_STATUS_INPROGRESS,SERVICE_STATUS_OVERDUE';
                                     } else if (status === 'Completed') {
                                         statusCode = 'SERVICE_STATUS_COMPLETE';
                                     } else if (status === 'Rejected') {
                                         statusCode = 'SERVICE_STATUS_REJECT,SERVICE_STATUS_CANCEL';
                                     }
                                     getList(code, statusCode);

                                 }
                             }
                         },
                         legend: {
                             position: 'bottom'
                         },
                         labels: ['Pending', 'Completed', 'Rejected'],
                         colors: ['#007bff','#28a745','#dc3545'],

                     };
                     var chart = new ApexCharts(document.querySelector(chart), options);
                     chart.render();
                 }

            }

        });
    }


    function onReset() {
        getEmployeeDashboardData();
    }

</script>


<div class="col-12" style="padding:10px;margin-top:20px;">

    <div>        
        <div class="row">
            <div class="col-2">
                <h5 style="font-weight:bold;color:black">DASHBOARD</h5>
            </div>
            <div class="col-3">                
                <input id="DepartmentId" class="form-control" style="width:100%!important" />                
            </div>
            <div class="col-3">
                <input id="TemplateType" class="form-control" style="width:100%!important" />
                
            </div>
            <div class="col-3">
                <input id="UserId" class="form-control" style="width:100%!important" />
            </div>
            <div class="col-1">
                <button style="float:right" id="right" class="scrollbtn"><i class="fas fa-chevron-right"></i></button>
                <button style="float:right" id="left" class="scrollbtn"><i class="fas fa-chevron-left"></i></button>
            </div>            

            @*<div class="d-flex flex-row flex-nowrap overflow-hidden" id="paymentdues">

            </div>*@
        </div>
        @*<div class="row">
            <div class="col-12">
                <button style="float:right" id="right" class="scrollbtn"><i class="fas fa-chevron-right"></i></button>
                <button style="float:right" id="left" class="scrollbtn"><i class="fas fa-chevron-left"></i></button>
            </div>
        </div>*@
        <div>
            <div id="servicecount" class="servicecount">
            </div>
        </div>
        <div class="row pl-4">
            @if (ViewBag.EnableCreate)
            {
                <button class="btn btn-primary" style="margin-right:10px;" onclick="CreateService()">Create Service</button>
            }
            @*<button class="btn btn-secondary" onclick="onReset()">Clear Filter</button>*@
        </div>
    </div>

    @*Grid view*@
    <div class="col-12 p-2">
        <div id="kGridView" style="width: 100%;height:550px" class="ag-theme-alpine"></div>
    </div>
</div>

<script type="text/x-kendo-tmpl" id="templateservicecount">
       <div class="card text-center summary-card">
        <div class="card-header summary-card-header" style="font-weight:500">
            #=DisplayName#
        </div>
        <div class="card-body row summary-card-body" >
            <div class="col-5 row border-right" >
                <div class="col-12" style="text-align:center">
                    <img class="caticon" src="/cms/Document/GetImageMongo?id=#=IconFileId#" onerror="OnDocumentError(this);">
                </div>
                <div class="col-12" style="text-align:center"><div style="font-weight:bold;font-size:25px;">#=TotalCount#</div></div>
            </div>
            <div class="col-7">
                <div  id="chart_#=TemplateCode#">
                </div>
            </div>
        </div>
    </div>
</script>