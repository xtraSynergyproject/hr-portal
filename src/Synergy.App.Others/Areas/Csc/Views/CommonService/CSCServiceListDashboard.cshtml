@inject IStringLocalizer<Synergy.App.WebUtility.Resources.Areas.Csc.Controllers.CommonServiceController> Resource
@using Synergy.App.ViewModel;
@*@using Kendo.Mvc.UI;*@
@using Synergy.App.Common;
@*@using Kendo.Mvc.Extensions;*@
@model EGovDashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
    var d = Resource["My Service Request"];
    //Layout = "~/Areas/Core/Views/Shared/_PopupLayout.cshtml";
    // Layout = "/Areas/Cms/Views/Shared/_LayoutCms.cshtml";
    Layout = null;

}
<link type="text/css" rel="stylesheet" href="~/css/cms/DashBoard.css" asp-append-version="true" />
<style>
    .summary-card {
        width: 400px;
        margin-right: 100px;
    }

    .summary-card-body {
        width: 400px;
    }

    .border-right {
        border-right: 1px solid #006699 !important;
    }

    .summary-card-header {
        width: 400px;
    }
</style>

<script type="text/javascript">
    function onBack()
    {
        window.location.href = "@ViewBag.ReturnUrl";
    }
    $('#left').click(function () {

        //event.preventDefault();
        $(".k-listview-content").animate({scrollLeft: "-=1075px"}, "slow");
    });

    $('#right').click(function () {

        //event.preventDefault();
        $(".k-listview-content").animate({ scrollLeft: "+=1075px"}, "slow");
    });

    function CreateService() {
        var url = '@Url.Action("CSCSelectServiceTemplate", "CommonService",new {area="CSC" })?categoryCode=@ViewBag.CategoryCodes&userId=' + '@ViewBag.UserId' + '&cbm=OnAfterService';
        var win = GetMainWindow();
        win.iframeOpenUrl = url;
        win.OpenWindow({ Title: '@Html.Raw(SharedResource["Select Service"])', Width: 1000, Height: 600, Position: 'Right1' });
        return false;
    }

    function getList(tempcode, statusCode) {
        //var search = { templateCodes: tempcode, taskStatus: statusCode };
        //$("#kGridView").data("kendoGrid").dataSource.read(search);
        getEmployeeDashboardData(tempcode, statusCode);
    }

    function OpenService(serviceId, templateCode) {

        var portalId = $('#GlobalPortalId').val();
        var url = '/Cms/Page?lo=Popup&popup=true&cbm=OnAfterService&source=View&dataAction=View&templateCodes=' + templateCode +'&portalId=' + portalId + '&recordId=' + serviceId;

        var win = GetMainWindow();
        win.iframeOpenUrl = url;
        win.OpenWindow({ Title: '@Html.Raw(SharedResource["ViewService"])', Width: 1200, Height: 700 });
        return false;
    }

     function OpenTask(taskId, tempCode) {

        var id = taskId;
        var source = '@RequestSourceEnum.Edit.ToString()';
        var action = '@DataActionEnum.Edit.ToString()';

        var portalId = $('#GlobalPortalId').val();

         var url = '/Cms/Page?lo=Popup&pageType=Task&cbm=OnAfterService&source=' + source + '&dataAction=' + action + '&templateCodes=' + tempCode + '&portalId=' + portalId + '&recordId=' + id;
        var win = GetMainWindow();
        win.iframeOpenUrl = url;
        win.OpenWindow({ Title:  '@Html.Raw(SharedResource["Task"])', Width: 1200, Height: 600 });
        return false;
    }


    function GenerateCertificate(serviceId) {
        debugger;
		var win = GetMainWindow();
		win.iframeOpenUrl = '/Cms/FastReport?rptName=CSC_BirthCertificate&lo=@LayoutModeEnum.Popup&rptUrl=Csc/query/GetCSCBirthCertificateReport?serviceId='+serviceId;
        win.OpenWindow({ Title: '@Html.Raw(Resource["Birth Certificate"])', Width: 700, Height: 800 });
		return false;
    }

    function OnAfterService() {

        $("#servicecount").data("kendoListView").dataSource.read();
        /*$("#kGridView").data("kendoGrid").dataSource.read();*/
        getEmployeeDashboardData();
        //Dependent();
    }

    var columnDefs = [
        {
            headerName: "@Html.Raw(SharedResource["Download"])",
            field: "ServiceNo",
            minWidth: 180,
            cellRenderer: params => {
                debugger;
                if (params.data.ServiceStatusCode == "SERVICE_STATUS_COMPLETE") {
                    return "<input type='button' class='btn btn-link' onclick='GenerateCertificate(\"" + params.data.Id + "\")' value='Download Certificate' />";
                }
            }
        },
        {
            headerName: "@Html.Raw(SharedResource["Action"])",
            field: "ServiceNo",
            minWidth: 160,
            cellRenderer: params => {
                return "<input type='button' class='btn btn-link' onclick='OpenService(\"" + params.data.Id + "\",\"" + params.data.TemplateCode + "\" )' value='Open Request' />";
            }
        },
        {
            headerName: "@Html.Raw(SharedResource["ServiceNo"])",
            minWidth: 120,
            field: "ServiceNo",
        },
        {
            headerName: "@Html.Raw(SharedResource["Service"])",
            field: "ServiceName",
        },
        {
            headerName: "@Html.Raw(SharedResource["Workflow Status"])",
            field: "WorkflowStatus",
        },
        {
            headerName: "@Html.Raw(SharedResource["ServiceStatus"])",
            maxWidth: 150,
            field: "ServiceStatusName",
            cellRenderer: params => {
                if (params.data.ServiceStatusCode == "SERVICE_STATUS_COMPLETE") {
                    return "<label class='text-success' style='font-weight:400;'>" + params.value + "</label>"
                }
                else if (params.data.ServiceStatusCode == "SERVICE_STATUS_INPROGRESS") {
                    return "<label class='text-primary' style='font-weight:400;'>" + params.value + "</label>"
                }
                else if (params.data.ServiceStatusCode == "SERVICE_STATUS_DRAFT") {
                    return "<label class='text-info' style='font-weight:400;'>" + params.value + "</label>"
                }
                else if (params.data.ServiceStatusCode == "SERVICE_STATUS_OVERDUE") {
                    return "<label class='text-warning' style='font-weight:400;'>" + params.value + "</label>"
                }
                else {
                    return "<label class='text-danger' style='font-weight:400;'>" + params.value + "</label>"
                }
                //return "<label #if(\"" + params.value + "\"=='Completed'){# class='btn btn-success' #}else if(\"" + params.value + "\"=='In Progress'){# class='btn btn-primary' #}else if(\"" + params.value + "\"=='Overdue'){# class='btn btn-warning' #}else if(\"" + params.value + "\"=='Rejected'){# class='btn btn-danger' #}#>" + params.value + "</label>";
            }
        },
        {
            headerName: "@Html.Raw(SharedResource["RequestedBy"])",
            field: "OwnerDisplayName",
        },
        {
            headerName: "@Html.Raw(SharedResource["RequestedDate"])",
            maxWidth: 150,
            field: "CreatedDate",
            cellRenderer: params => {
                var date = new Date(params.value);
                /*return date.getDate() + "/" + (date.getMonth() + 1) + "/" + date.getFullYear();*/
                return date.getDate() + "." + (date.getMonth() + 1) + "." + date.getFullYear();
            }
        },
        {
            headerName: "@Html.Raw(SharedResource["DueDate"])",
            maxWidth: 120,
            field: "DueDate",
            cellRenderer: params => {
                var date = new Date(params.value);
                return date.getDate() + "." + (date.getMonth() + 1) + "." + date.getFullYear();
            }
        },
        //{
        //    headerName: "Service Status",
        //    field: "ServiceStatusName",
        //},

    ];

    $(function () {

        var dataSource = new kendo.data.DataSource({
            transport: {
                read: {
                    url: "/CSC/CommonService/ReadServiceListCount?categoryCodes="+'@ViewBag.CategoryCodes' + "&isIncluded=true",
                    dataType: "json"
                }
            },
        });

        $("#servicecount").kendoListView({
            dataSource: dataSource,
            template: kendo.template($("#templateservicecount").html()),
            dataBound: function () {
                debugger;
                 var data = $("#servicecount").data("kendoListView").dataSource.data();
                 for (var i = 0; i < data.length; i++) {
                     console.log(data[i]);
                     var vals = [data[i].CreatedByMeInProgreessOverDueCount, data[i].CreatedByMeCompleteCount, data[i].CreatedOrRequestedByMeRejectCancelCloseCount];
                     var chart = "#chart_" + data[i].TemplateCode;
                     var options = {
                         series: vals,
                         chart: {
                             id: data[i].TemplateCode,
                             width: 250,
                             height: 250,
                             type: 'pie',
                             events: {
                                 dataPointSelection: function (event, chartContext, config) {
                                     debugger;
                                     var status=config.w.config.labels[config.dataPointIndex];
                                     var code = config.w.config.chart.id;
                                     var statusCode = '';
                                     if (status ==='Pending') {
                                         statusCode = 'SERVICE_STATUS_INPROGRESS,SERVICE_STATUS_OVERDUE';
                                     } else if (status === 'Completed') {
                                         statusCode = 'SERVICE_STATUS_COMPLETE';
                                     } else if (status === 'Rejected') {
                                         statusCode = 'SERVICE_STATUS_REJECT,SERVICE_STATUS_CANCEL';
                                     }
                                     getList(code, statusCode);

                                 }
                             }
                         },
                         legend: {
                             position: 'bottom'
                         },
                         labels: ['Pending', 'Completed', 'Rejected'],
                         colors: ['#007bff','#28a745','#dc3545'],

                     };
                     var chart = new ApexCharts(document.querySelector(chart), options);
                     chart.render();
                 }

            }

        });

        getEmployeeDashboardData();

        $.contextMenu({
            selector: '#tree-menu1',
            trigger: 'left',
            build: function ($trigger, e) {

                var id = $trigger.data('idvalue');

                //var portalName = $trigger.data('portal-name');

                switch (0) {
                    case 0:
                        return {
                            callback: function (key, options) {
                                switch (key) {
                                    case 'edit':
                                        break;
                                    case 'delete':
                                        break;
                                    default:
                                }
                            },
                            items: {
                                "edit": { name: "Edit", icon: "fas fa-edit" },
                                "delete": { name: "Delete", icon: "fas fa-trash" },

                            }
                        };
                }
            }
        });

    });

    function getEmployeeDashboardData(catcode, statusCode) {
        debugger;
        document.getElementById("kGridView").innerHTML = "";

        var catcodes = '@ViewBag.CategoryCodes';
        if (catcode!=null) {
            catcodes = catcode;
        }
        var statuscodes = statusCode;
        if (statuscodes == undefined) {
            statuscodes = "";
        }
        /*alert(tempcodes);*/
        gridConfig(
            "kGridView",
            "/cms/NtsService/ReadServiceData?categoryCodes=" + catcodes + "&serviceStatus=" + statuscodes,
            columnDefs,
            false,
            true,
            true,
            true,
            1,
            true,
            10);
    }
    function onReset() {
        //HideLoader($("#global-overlay"));
        //    window.parent.LoadPartailView1("/EGOV/EGovernment/EmployeeDashboard", 'EmployeeDashboard');
        getEmployeeDashboardData();
    }

</script>



<div class="col-12" style="padding:10px;margin-top:20px;">

    <div>

        <div class="row">
            <div class="col-6">
                <h5 style="font-weight:bold;color:black">@SharedResource["My Service Request"]</h5>
            </div>

            <div class="col-5" hidden>
                <button style="float:right" id="right" class="scrollbtn"><i class="fas fa-chevron-right"></i></button>
                <button style="float:right" id="left" class="scrollbtn"><i class="fas fa-chevron-left"></i></button>
            </div>
            @*<div class="col-1">
                    <input type="button" value="Back" onclick="onBack()" class="btnservice btn-primary" />
                </div>*@

            <div class="d-flex flex-row flex-nowrap overflow-hidden" id="paymentdues">

            </div>
        </div>
        <div>
            <div id="servicecount" class="servicecount">

            </div>
        </div>
        <div class="row pl-4">
            @if (ViewBag.EnableCreate)
            {
                <button class="btn btn-primary" style="margin-right:10px;" onclick="CreateService()">@SharedResource["CreateService"]</button>
            }
            <button class="btn btn-secondary" onclick="onReset()">@SharedResource["Clear Filter"]</button>
        </div>
    </div>

    @*Grid view*@
    <div class="col-12 p-2">
        <div id="kGridView" style="width: 100%;height:550px" class="ag-theme-alpine"></div>
    </div>
</div>

<script type="text/x-kendo-tmpl" id="templateservicecount">
       <div class="card text-center summary-card">
        <div class="card-header summary-card-header" style="font-weight:500">
            #=DisplayName#
        </div>
        <div class="card-body row summary-card-body" >
            <div class="col-5 row border-right" >
                <div class="col-12" style="text-align:center">
                    <img class="caticon" src="/cms/Document/GetImageMongo?id=#=IconFileId#" onerror="OnDocumentError(this);">
                </div>
                <div class="col-12" style="text-align:center"><div style="font-weight:bold;font-size:25px;">#=TotalCount#</div></div>
            </div>
            <div class="col-7">
                <div  id="chart_#=TemplateCode#">
                </div>
            </div>
        </div>
    </div>
</script>