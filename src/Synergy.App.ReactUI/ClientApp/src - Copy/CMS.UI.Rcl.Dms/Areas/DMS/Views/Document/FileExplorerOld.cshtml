@inject IStringLocalizer<CMS.UI.Web.Areas.DMS.Controllers.DocumentController> Resource
@using CMS.UI.ViewModel;
@using CMS.Common;

@{
    ViewData["Title"] = "File Manager";
    Layout = null;
}


<script src="~/js/fancytree/jquery.fancytree.filter.js"></script>
<script src="~/js/fancytree/jquery.fancytree.edit.js"></script>
<script src="~/js/fancytree/jquery.fancytree.dnd.js"></script>


<style>
    .splitter-container {
        height: 75vh !important;
        width: 100%;
    }

    .left {
        min-width: 400px;
        max-width: 600px;
    }

    .splitter-container .right_panel {
        overflow: unset;
    }

    .splitter-container .left_panel {
        overflow: auto;
    }

    .belowHead-nav {
        width: 99%;
        padding: 0;
        margin: 10px auto -9px;
        background-color: #fafafa;
        border-color: #e0e0e0 !important;
        border: 1px solid;
        border-bottom: 0px solid;
    }

    .belowHead-main {
        width: 99%;
        height: 76vh;
        padding: 0;
        margin: 10px auto;
        background-color: white;
        border-color: #e0e0e0 !important;
        border: 1px solid;
    }

    .R-block {
        width: 25%;
        float: right;
        /*padding: 4px;*/
        /*margin: 2px -85px -4px 0px;*/
        display: flex;
    }

    .R-body-block {
        width: 100%;
        /*margin: 0px 6px;*/
        border-bottom-color: #e0e0e0 !important;
        border-bottom: 1px solid;
        height: 34px;
    }

    .L-block {
        width: 40%;
        float: left;
        padding: 4px;
        margin: 0;
    }


    .L-menu-block {
        width: 100%;
        float: left;
        padding: 4px;
        margin: 0;
    }

    .Content-block {
        width: 100%;
        height: 71vh;
        clear: both;
        padding: 4px;
        /*margin: 6px;*/
    }

    .fa-workspace:before {
        content: "\f07b";
        color: cornflowerblue;
    }

    .fa-folder:before {
        content: "\f07b";
        color: #ffcf20 !important;
    }

    .fa-file-alt:before {
        /* content: "\e30d";*/
        /*color: #266cb7 !important;*/
        /*font-size:24px;*/
    }

    .nav-count {
        background: #ffa828;
        border-radius: 30%;
        padding: 0px 5px;
        color: white;
        font-weight: 600;
        margin-right: 8px;
        margin-top: 5px;
    }

    #tree {
        height: 75vh;
        /*overflow-y: scroll;*/
    }

    ul.fancytree-container {
        border: unset;
    }

    body {
        background: unset;
    }

    .tree-search-wrap {
        float: right;
        padding: 0px 16px 0 16px;
        position: absolute;
        right: 0;
        top: 0;
        width: 300px;
    }

    .e-icons {
        color: rgba(0,0,0,0.54);
    }

    .fa-search {
        font-size: 14px;
        margin: 4px 0;
        padding: 5px;
        /*position: absolute;*/
        z-index: 1;
        cursor: pointer;
    }

    .e-input-group input.e-input {
        border-color: rgba(0,0,0,0.42);
        border: none;
        font-family: "Roboto","Segoe UI","GeezaPro","DejaVu Serif","sans-serif","-apple-system","BlinkMacSystemFont" !important;
        font-size: 13px !important;
        font-weight: 400 !important;
    }

    #treetableDiv {
        height: 70vh;
        overflow-y: scroll;
    }

    #treetable {
        font-size: 13px;
        line-height: 1;
    }

        #treetable td {
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }

        .sort-up:after {
            content: "▲";
        }

        .sort-down:after {
            content: "▼";
        }

        

    .tree-address .tree-address-ul {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        list-style: none;
        margin: 0;
        padding: 3px 8px;
        visibility: visible;
    }

    .tree-address .e-address-list-item {
        color: rgba(0,0,0,0.54);
    }

    .tree-address .tree-address-list-item {
        display: inline-block;
        height: 27px;
    }

    .tree-address .tree-list-text {
        cursor: pointer;
        font-size: 14px;
        line-height: 27px;
        padding: 4px 4px 5px;
        text-decoration: none;
        color: rgba(0,0,0,0.54);
    }

    .tree-address-list-item:hover {
        background: #eee;
        color: rgba(0,0,0,0.87);
    }

    .tree-address-list-item:last-child {
        color: black;
        pointer-events: none;
    }

    .tree-address-ul .fa-angle-right {
        padding: 5px !important;
        font-size: 16px !important;
    }

    #treetable th {
        background-color: antiquewhite !important;
        color: gray;
        overflow: hidden;
        white-space: nowrap;
        text-transform: uppercase;
        font-family: sans-serif;
        font-size: 11px;
    }
    /*#treetable td {
        background-color: white;
        overflow: hidden;
        white-space: nowrap;
    }*/
    #treetable tr:nth-child(odd) {
        background-color: white;
    }

    #treetable td {
        border: unset;
    }

    /* #treetable th {
        border: unset;
        border-right: 1px ridge lightgray !important;
    }*/

    .tree-toolbar-left {
        display: flex;
    }

    .tree-tbar-btn {
        box-shadow: none;
        border: none;
        font-weight: 400;
        overflow: hidden;
        text-align: center;
        text-decoration: none;
        text-transform: none;
    }

    .tree-btn-icon {
        display: inline-block;
        font-size: 12px;
        margin-top: -2px;
        vertical-align: middle;
        width: 1em;
    }

    .tree-icons {
        font-family: "e-icons";
        font-style: normal;
        font-variant: normal;
        font-weight: normal;
        line-height: 1;
        text-transform: none;
    }

    .tree-control {
        font-size: 12px;
        font-weight: normal;
    }

    .tree-btn {
        border: 1px solid;
        display: inline-block;
        font-size: 14px;
        justify-content: center;
        line-height: 1.143em;
        padding: 6px 12px 4px;
        text-align: center;
        text-decoration: none;
        vertical-align: middle;
        white-space: nowrap;
        background-color: #fafafa;
        border-color: transparent;
    }

    .tree-btn-text {
        color: #424242;
        font-weight: 400;
        margin-left: 5px;
    }

    .tree-hidden {
        display: none;
    }

    .fancytree-ext-filter span.fancytree-title mark {
        background-color: #E09090;
    }

    .fancytree-plain span.fancytree-active,
    .fancytree-plain span.fancytree-selected {
        background-color: #e0e0e0 !important;
        border-color: #e0e0e0 !important;
    }

        .fancytree-plain span.fancytree-active span.fancytree-title,
        .fancytree-plain span.fancytree-selected span.fancytree-title {
            background-color: unset;
            border-color: unset;
            border: none;
        }

    .fancytree-plain.fancytree-container.fancytree-treefocus span.fancytree-active,
    .fancytree-plain.fancytree-container.fancytree-treefocus span.fancytree-selected {
        background-color: #e0e0e0 !important;
        border-color: #e0e0e0 !important;
    }

        .fancytree-plain.fancytree-container.fancytree-treefocus span.fancytree-active span.fancytree-title,
        .fancytree-plain.fancytree-container.fancytree-treefocus span.fancytree-selected span.fancytree-title {
            background-color: unset;
            border-color: unset;
        }

    .fancytree-plain span.fancytree-node:hover {
        background-color: #eee;
        border-color: #eee;
    }

        .fancytree-plain span.fancytree-node:hover span.fancytree-title {
            background-color: unset;
            border-color: unset;
            border: none;
        }

    table.fancytree-ext-table tbody tr.fancytree-active {
        background-color: #e0e0e0 !important;
        outline: 1px solid #DEDEDE;
    }

    table.fancytree-ext-table tbody tr.fancytree-focused span.fancytree-title {
        outline: 1px dotted black;
    }

    /*.context-menu-item.icon-workspace {

    }*/
    .display-hide {
        display: none;
    }

    #Empty-div {
        text-align: center;
        vertical-align: middle;
        padding: 15%;
        color: #424242;
        font-size: 18px;
        font-weight: 600;
    }
    /*switch*/
    .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        -webkit-transition: .4s;
        transition: .4s;
    }

        .slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

    input:checked + .slider {
        background-color: #2196F3;
    }

    input:focus + .slider {
        box-shadow: 0 0 1px #2196F3;
    }

    input:checked + .slider:before {
        -webkit-transform: translateX(26px);
        -ms-transform: translateX(26px);
        transform: translateX(26px);
    }

    /* Rounded sliders */
    .slider.round {
        border-radius: 34px;
    }

        .slider.round:before {
            border-radius: 50%;
        }

    @@media only screen and (max-width: 600px) {
        #L-div {
            display: none;
        }

        .splitter-container.left_panel, .vsplitter {
            display: none;
        }
        /*.splitter_panel.right_panel {
            position: initial !important;
            width:100%;
        }*/
    }

    .e-control-wrapper {
        border-color: rgba(0,0,0,0.42);
        border: 1px solid;
        border-width: 0 0 1px 0;
        background: transparent;
        color: rgba(0,0,0,0.87);
        position: relative;
        width: 100%;
        display: inline-flex;
        vertical-align: middle;
        border-radius: 0;
        line-height: 1.4 !important;
        margin-bottom: 4px;
        height: auto;
        min-height: 28px;
        box-sizing: content-box;
        content: '';
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>
<style>
   

        .tablesorter-ice .header, .tablesorter-ice .tablesorter-header {
            background-color: #f6f8f9;
            background-position: center right;
            background-repeat: no-repeat;
            background-image: url(data:image/gif;base64,R0lGODlhDAAMAMQAAAJEjAJCiwJBigJAiANFjgNGjgNEjQRIkQRHkANIkAVMlAVQmAZWnQZUnAdYoAhdpAhZoAlhqQlepQliqQppsApmrQxutgtutQtutAxwtwxwtg1yug1zugxtsw1yuP8A/yH5BAEAAB8ALAAAAAAMAAwAAAUx4Cd+3GiOW4ado2d9VMVm1xg9ptadTsP+QNZEcjoQTBDGCAFgLRSfQgCYMAiCn8EvBAA7);            
            white-space: normal;
            cursor: pointer
        }

        .tablesorter-ice .headerSortUp, .tablesorter-ice .tablesorter-headerAsc, .tablesorter-ice .tablesorter-headerSortUp {
            color: #333;
            background-color: #ebedee;
            background-position: center right;
            background-repeat: no-repeat;
            background-image: url(data:image/gif;base64,R0lGODlhDAAMANUAAAJCiwNHkANFjgNEjQRIkQNJkQRMlARKkwRKkgVPlwZSmgdaogdYnwhfpghcowlhqgliqglgqAlgpwljqwporwpmrQplrAtsswtqsgtrsgtqsQxttAtvtQtttAxyuQxwtwxxtwxvtg10uw1zuQ1xuP8A/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAACUALAAAAAAMAAwAAAY6wJKwJBoahyNQ6Dj0fDoZCpPEuWgqk4jxs8FQLI+Gg8Esm5kQydFQMC7IwkOAqUiUCAIzIjA4lwBlQQA7)
        }

        .tablesorter-ice .headerSortDown, .tablesorter-ice .tablesorter-headerDesc, .tablesorter-ice .tablesorter-headerSortDown {
            color: #333;
            background-color: #ebedee;
            background-position: center right;
            background-repeat: no-repeat;
            background-image: url(data:image/gif;base64,R0lGODlhDAAMANUAAAE/iAJBigNFjgNEjQNFjQNDiwRHkQRHjwNHjwROlgRMlQRMlARJkgRKkgZQmAVPlgZWnQZSmgZRmAdXoAdXnwdUnAdbogdZoQhbowlhqAlepglkrAliqQtstAtqsQxyugxyuQxwuAxxuAxxtwxwtgxvtQ10vA12vA10u/8A/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAACkALAAAAAAMAAwAAAY6wJQwdRoah6bP6DhEiVIdDxNEGm4yxlDpiJkwv2AmR2OhVCSJBsJ4gUQeCwOB6VAwBAXwYRAIpwBfQQA7)
        }

        .tablesorter-ice thead .sorter-false {
            background-image: none;
            cursor: default;
            /*padding: 4px*/
        }

        .tablesorter-ice tfoot .tablesorter-headerAsc, .tablesorter-ice tfoot .tablesorter-headerDesc, .tablesorter-ice tfoot .tablesorter-headerSortDown, .tablesorter-ice tfoot .tablesorter-headerSortUp {
            background-color: #ebedee
        }

       /* .tablesorter-ice td {
            color: #333
        }*/

        .tablesorter-ice tbody > tr.even:hover > td, .tablesorter-ice tbody > tr.hover > td, .tablesorter-ice tbody > tr.odd:hover > td, .tablesorter-ice tbody > tr:hover > td {
            background-color: #ebf2fa
        }

        .tablesorter-ice .tablesorter-processing {
            background-position: center center !important;
            background-repeat: no-repeat !important;
            background-image: url(data:image/gif;base64,R0lGODlhFAAUAKEAAO7u7lpaWgAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh+QQBCgACACwAAAAAFAAUAAACQZRvoIDtu1wLQUAlqKTVxqwhXIiBnDg6Y4eyx4lKW5XK7wrLeK3vbq8J2W4T4e1nMhpWrZCTt3xKZ8kgsggdJmUFACH5BAEKAAIALAcAAAALAAcAAAIUVB6ii7jajgCAuUmtovxtXnmdUAAAIfkEAQoAAgAsDQACAAcACwAAAhRUIpmHy/3gUVQAQO9NetuugCFWAAAh+QQBCgACACwNAAcABwALAAACE5QVcZjKbVo6ck2AF95m5/6BSwEAIfkEAQoAAgAsBwANAAsABwAAAhOUH3kr6QaAcSrGWe1VQl+mMUIBACH5BAEKAAIALAIADQALAAcAAAIUlICmh7ncTAgqijkruDiv7n2YUAAAIfkEAQoAAgAsAAAHAAcACwAAAhQUIGmHyedehIoqFXLKfPOAaZdWAAAh+QQFCgACACwAAAIABwALAAACFJQFcJiXb15zLYRl7cla8OtlGGgUADs=) !important
        }
        
    
   
</style>

<div class="control-section">
    <div class="belowHead-nav">
        <div class="row">
            <div class="col-12 col-md-6">
                <div class="L-block">
                    <div class="tree-toolbar-left">
                        <div class="tree-toolbar-item" aria-disabled="false" title="Paste">
                            <button class="tree-tbar-btn tree-control tree-btn " type="button" id="filemanager_tb_workspace" onclick="OnCreateWorkspace()" tabindex="-1" aria-label="Paste" style="width: auto;">
                                <span class="fa fa-workspace" style="font-size:18px"></span>
                                <span class="tree-btn-text">New Workspace</span>
                            </button>
                        </div>
                        <div class="tree-toolbar-item tree-hidden" aria-disabled="false" title="Copy">
                            <button class="tree-tbar-btn tree-control tree-btn" type="button" id="filemanager_tb_copy" onclick="OnCopy()" tabindex="-1" aria-label="Copy" style="width: auto;">
                                <span class="fal fa-copy"></span>
                                <span class="tree-btn-text">Copy</span>
                            </button>
                        </div>
                        <div class="tree-toolbar-item tree-hidden" aria-disabled="false" title="Cut">
                            <button class="tree-tbar-btn tree-control tree-btn" type="button" id="filemanager_tb_cut" onclick="OnCut()" tabindex="-1" aria-label="Cut" style="width: auto;">
                                <span class="fal fa-cut"></span>
                                <span class="tree-btn-text">Cut</span>
                            </button>
                        </div>
                        <div class="tree-toolbar-item tree-hidden" aria-disabled="false" title="Delete">
                            <button class="tree-tbar-btn tree-control tree-btn" type="button" id="filemanager_tb_delete" onclick="OnDelete()" tabindex="-1" aria-label="Delete" style="width: auto;">
                                <span class="fal fa-trash-alt"></span>
                                <span class="tree-btn-text">Delete</span>
                            </button>
                        </div>
                        <div class="tree-toolbar-item tree-hidden" aria-disabled="false" title="Archive">
                            <button class="tree-tbar-btn tree-control tree-btn" type="button" id="filemanager_tb_archive" onclick="OnArchive()" tabindex="-1" aria-label="Archive" style="width: auto;">
                                <span class="fal fa-trash"></span>
                                <span class="tree-btn-text">Archive</span>
                            </button>
                        </div>
                        <div class="tree-toolbar-item" aria-disabled="false" title="Refresh">
                            <button class="tree-tbar-btn tree-control tree-btn" type="button" id="filemanager_tb_refresh" onclick="OnRefresh()" tabindex="-1" aria-label="Refresh" style="width: auto;">
                                <span class="fal fa-refresh"></span>
                                <span class="tree-btn-text">Refresh</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6">

                <div class="R-block">

                    <div style=" padding: 10px; color: black;"><span>FILE VIEW</span></div>
                    <div>
                        <label class="switch" style="margin:0px">
                            <input type="checkbox" id="view-matadata" title="file view On/Off" onchange="OnViewChange()">
                            <span class="slider round"></span>
                        </label>
                    </div>



                </div>
            </div>
        </div>
    </div>
    <div class="belowHead-main">
        <div class="splitter-container">
            <div class="left" id="L-div">
                <div class="L-menu-block">
                    <div id="tree"></div>
                </div>
            </div>
            <div class="right">
                <div class="R-body-block">
                    <div class="row">
                        <div class="col-12 col-md-8">
                            <div id="breadcrum" class="tree-address">
                                <ul class="tree-address-ul">
                                </ul>
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="tree-search-wrap">

                                <span class="e-input-group e-control-wrapper">
                                    <input id="filemanager_search" autocomplete="off" aria-label="Search" class="e-input e-searchClass" type="text" role="textbox" name="filemanager_search" placeholder="Search" aria-placeholder="Search" value="" style="width:200px">
                                    <span class="fa fa-search tree-icons" aria-label="search" id="btnSearch"></span>
                                    <span class="fa fa-remove e-icons" aria-label="close" id="btnResetSearch" role="button" style="margin: 8px 0px 0 16px; font-size: 16px;"></span>
                                </span>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="Content-block">
                    <div class="row">
                        <div class="col-12">
                            <div id="treetableDiv" style="display:none">
                                <table id="treetable" width="100%" class="table tablesorter" style="table-layout: fixed;">
                                    <colgroup>
                                        <col width="30" />
                                        <col />
                                        <col />
                                        <col />
                                        <col />
                                        <col />
                                        <col />
                                    </colgroup>
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" id="btnToggleSelect" title="Select All" onchange="onSelecAllchange()" /></th>
                                            <th>Name</th>
                                            <th id="size-th" style="display:none">Size</th>
                                            <th >Note No</th>
                                            <th >Created By</th>
                                            <th >Created Date</th>
                                            <th >Modified Date</th>
                                            <th >Workflow Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td></td>
                                            <td></td>
                                            <td class="size-td" style="display:none"></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div id="Empty-div" class="display-hide">No Record Found !</div>
                            </div>
                            <!-- Add a <table> element where the tree should appear: -->

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<script>

    var CLIPBOARD = null;
    var viewmode = localStorage.getItem("viewmode");
    $(document).ready(function () {
        if (viewmode != null && viewmode == "file") {
            $("#view-matadata").attr("checked", true);
        }
        $("#tree").fancytree({
            extensions: ['contextMenu','edit','dnd'],
            source: $.ajax({
                url: "/Dms/Document/GetSoureceFolders",
                dataType: "json",
                data: { key: '@ViewBag.Key'}
            }),
            lazyLoad: function (event, data) {

                var node = data.node;
                // Issue an Ajax request to load child nodes
                data.result = {
                    url: "/Dms/Document/GetChildFolders",
                    data: { key: node.key }
                }
            },
            dnd: {
                preventVoidMoves: true, // Prevent dropping nodes 'before self', etc.
                preventRecursiveMoves: true, // Prevent dropping nodes on own descendants
                autoExpandMS: 400,
                draggable: {
                    //zIndex: 1000,
                    // appendTo: "body",
                    // helper: "clone",
                    scroll: false,
                    revert: "invalid"
                },
                dragStart: function (node, data) {
                    if (node.data.Workspace == true || node.data.CanCopy == false) {
                        return false;
                    }
                    if (data.originalEvent.shiftKey) {
                        console.log("dragStart with SHIFT");
                    }
                    // allow dragging `node`:
                    return true;
                },
                dragEnter: function (node, data) {
                    // Prevent dropping a parent below another parent (only sort
                    // nodes under the same parent)
                    /* 					if(node.parent !== data.otherNode.parent){
                                            return false;
                                        }
                                        // Don't allow dropping *over* a node (would create a child)
                                        return ["before", "after"];
                    */
                    return true;
                },
                dragDrop: function (node, data) {
                    var flag = confirm('@Resource["Doyoureallywanttomove?"]');
                    if (!flag) {
                        return false;
                    }
                    if (node.data.Workspace == true && data.otherNode.data.Document == true) {
                        ShowNotification("You can not move document to workspace!", "danger");
                        return false;
                    }
                    else if (node.data.Document == true) {
                        ShowNotification("You can not move document to under document!", "danger");
                        return false;
                    }
                    ShowLoader($('.control-section'));
                    //if (!data.otherNode) {
                    //    // It's a non-tree draggable
                    //    var title = $(data.draggable.element).text() + " (" + (count)++ + ")";
                    //    node.addNode({ title: title }, data.hitMode);
                    //    return;
                    //}
                    //data.otherNode.moveTo(node, data.hitMode);
                    CLIPBOARD = { mode: 'cut', data: data.otherNode, action: "context" };
                    OnPaste(node);
                }
            },
            edit: {
                triggerStart: ["clickActive", "f2", "mac+enter", "shift+click"],
                beforeEdit: function (event, data) {
                    var node = data.node;
                    // Return false to prevent edit mode
                    if (node.data.Workspace == true && node.data.CanCreateWorkspace == true) {
                        return true;
                    }
                    else if (node.folder == true && node.data.CanRename == true) {
                        return true;
                    }
                    else {
                        return false;
                    }
                },
                edit: function (event, data) {
                    // Editor was opened (available as data.input)
                },
                save: function (event, data) {
                    ShowLoader($('.control-section'));
                    // Save data.input.val() or return false to keep editor open
                    var node = data.node;
                    var title = data.input.val();
                    rename(title, node.key);
                    // Simulate to start a slow ajax request...
                    setTimeout(function () {
                        // Let's pretend the server returned a slightly modified
                        // title:
                        node.setTitle(node.title);
                        var span = $(node.span);
                        var elm = span[0].lastElementChild;
                        if (node.data.Count != undefined) {
                            $("<span class='nav-count pull-right'>" + node.data.Count + "</span>").insertAfter(elm);
                        }
                        span.find("> span.fancytree-title").css({
                            fontSize: "13px",
                            height: "32px",
                            lineHeight: "32px",
                            padding: "0px 10px 0px 10px",
                            fontFamily: "Roboto,Segoe UI, GeezaPro, DejaVu Serif, sans-serif, -apple-system, BlinkMacSystemFont"
                        });
                        span.find("> span.fancytree-custom-icon").css({
                            fontSize: "18px",
                            marginTop: "8px"
                        });
                        span.find("> span.fancytree-expander").css({
                            marginTop: "8px"
                        });
                        HideLoader($('.control-section'));
                    }, 2000);
                    // We return true, so ext-edit will set the current user input
                    // as title
                    return true;
                },
                close: function (event, data) {
                    // Editor was removed
                    if (!data.save) {
                        // Since we started an async request, mark the node as preliminary
                        var node = data.node;
                        var span = $(node.span);
                        var elm = span[0].lastElementChild;
                        if (node.data.Count != undefined) {
                            $("<span class='nav-count pull-right'>" + node.data.Count + "</span>").insertAfter(elm);
                        }
                        span.find("> span.fancytree-title").css({
                            fontSize: "13px",
                            height: "32px",
                            lineHeight: "32px",
                            padding: "0px 10px 0px 10px",
                            fontFamily: "Roboto,Segoe UI, GeezaPro, DejaVu Serif, sans-serif, -apple-system, BlinkMacSystemFont"
                        });
                        span.find("> span.fancytree-custom-icon").css({
                            fontSize: "18px",
                            marginTop: "8px"
                        });
                        span.find("> span.fancytree-expander").css({
                            marginTop: "8px"
                        });

                    }
                }
            },
            renderNode: function (event, data) {
                var node = data.node;
                if (node != null && node.key != "_1") {
                    if (node.data.Workspace) {
                        node.icon = "fa fa-workspace";
                        node.tooltip = true;
                        node.renderTitle();
                    }
                    else if (node.folder) {
                        node.icon = "fa fa-folder";
                        node.tooltip = true;
                        node.renderTitle();
                    }
                    var span = $(node.span);
                    var elm = span[0].lastElementChild;
                    if (node.data.Count != undefined) {
                        $("<span class='nav-count pull-right'>" + node.data.Count + "</span>").insertAfter(elm);
                    }
                    span.find("> span.fancytree-title").css({
                        fontSize: "13px",
                        height: "32px",
                        lineHeight: "32px",
                        padding: "0px 10px 0px 10px",
                        fontFamily: "Roboto,Segoe UI, GeezaPro, DejaVu Serif, sans-serif, -apple-system, BlinkMacSystemFont"
                    });
                    span.find("> span.fancytree-custom-icon").css({
                        fontSize: "18px",
                        marginTop: "8px"
                    });
                    span.find("> span.fancytree-expander").css({
                        marginTop: "8px"
                    });

                }
                if ('@ViewBag.Key' != "" && '@ViewBag.Key' != null && node.isActive()) {
                    renderTreeTable(node.key);
                    CreateBreadCrum(data);
                }

            },
            select: function (event, data) {
                //var parentNode = data.node.getParent(),
                //    topNode = data.node.getParentList()[0];
            },
            dblclick: function (event, data) {
                var node = data.node;
                var checked = $("#view-matadata").is(':checked');
                if (checked) {
                    var newSourceOption = {
                        url: "/Dms/Document/GetChildFoldersAndFiles",
                        type: 'POST',
                        dataType: "json",
                        data: { key: node.key }
                    };
                    renderTreeTable(node.key, newSourceOption);
                }
                else {
                    renderTreeTable(node.key);
                }

                CreateBreadCrum(data);

            },
            contextMenu: {
                menu: function (node) {

                    return {
                        'workspace': {
                            'name': 'Workspace',
                            'items': {
                                'CreateWorkspace': { 'name': 'Create Workspace', 'icon': 'add', 'disabled': node.data.Workspace==false || node.data.CanCreateWorkspace ==false  },
                                'EditWorkspace': { 'name': 'Edit Workspace', 'icon': 'edit', 'disabled': node.data.Workspace == false || node.data.CanCreateWorkspace == false },
                            }
                        },
                        'folder': {
                            'name': 'Folder',
                            'items': {
                                'CreateFolder': { 'name': 'Create Folder', 'icon': 'add', 'disabled': node.data.Document == true || node.data.CanCreateSubFolder==false},
                                'EditFolder': { 'name': 'Edit Folder', 'icon': 'edit', 'disabled': node.folder==false || node.data.CanRename==false },
                            }
                        },
                        'upload': {
                            'name': 'Upload',
                            'items': {
                                'UploadFolder': { 'name': 'Upload Folder', 'icon': 'fas fa-folder-upload', 'disabled': node.data.Document == true || node.data.CanCreateSubFolder==false },
                                'UploadFiles': { 'name': 'Upload Files', 'icon': 'fas fa-upload', 'disabled': node.folder == false || node.data.CanCreateDocument==false },
                            }
                        },
                        'document': {
                            'name': 'Document',
                            'items': {
                                'CreateDocument': { 'name': 'Create Document', 'icon': 'add', 'disabled': node.folder == false || node.data.CanCreateDocument==false },
                                'EditDocument': { 'name': 'Edit Document', 'icon': 'edit', 'disabled': node.data.Document==false || node.data.WorkflowServiceId != null || node.data.CanEditDocument==false  },
                            }
                        },
                        //'sep1': '---------',
                        'permission': {
                            'name': 'Permission',
                            'items': {
                                'ManagePermission': { 'name': 'Manage Permission', 'icon': 'fas fa-tasks', 'disabled': node.data.CanManagePermission==false },
                                'ViewPermission': { 'name': 'View Permission', 'icon': 'fas fa-eye' },
                            }
                        },
                        //'Workflow': {
                        //    'name': 'Workflow',
                        //    'items': {
                        //        'ViewWorkflow': { 'name': 'View Workflow', 'disabled': node.data.Document==false || node.data.WorkflowTemplateCode == null || node.data.CanEditDocument == false || node.data.DocumentApprovalStatusType != "Approve Through DMS" },
                        //        'RaiseApprovalRequest': { 'name': 'Raise Approval Request', 'disabled': node.data.Document==false || node.data.WorkflowTemplateCode == null || node.data.CanEditDocument == false || node.data.StatusName == "NOTE_STATUS_DRAFT" || node.data.DocumentApprovalStatusType != "Approve Through DMS" || node.data.WorkflowServiceId != null },
                        //        'ViewApprovalRequest': { 'name': 'View Approval Request', 'disabled': node.data.Document==false || node.data.WorkflowServiceId == null },
                        //        'Re-RaiseApprovalRequest': { 'name': 'Re Raise Approval Request', 'disabled': node.data.Document == false || node.data.WorkflowServiceStatus != "SERVICE_STATUS_COMPLETE" || node.data.WorkflowServiceStatus != "SERVICE_STATUS_CANCEL" }
                        //    }
                        //},
                        'action': {
                            'name': 'Action',
                            'items': {
                                'cut': { 'name': 'Cut', 'icon': 'cut', 'disabled': node.data.Workspace == true || node.data.CanCopy == false },
                                'copy': { 'name': 'Copy', 'icon': 'copy', 'disabled': node.data.Workspace == true || node.data.CanCopy == false },
                                'paste': { 'name': 'Paste', 'icon': 'paste', 'disabled': CLIPBOARD == null || node.data.Document == true },
                                'delete': { 'name': 'Delete', 'icon': 'delete', 'disabled': node.data.Workspace == true || node.data.CanDelete == false || node.data.WorkflowServiceStatus == "SERVICE_STATUS_INPROGRESS" || node.data.WorkflowServiceStatus == "SERVICE_STATUS_OVERDUE" },
                                'Archive': { 'name': 'Archive', 'icon': 'delete', 'disabled': node.data.Workspace == true || node.data.CanArchive == false || node.data.WorkflowServiceStatus == "SERVICE_STATUS_INPROGRESS" || node.data.WorkflowServiceStatus == "SERVICE_STATUS_OVERDUE" },

                            }
                        },
                        'download': {
                            'name': 'Download',
                            'items': {
                                'DownloadAll': { 'name': 'Download All', 'icon': 'fas fa-folder-download', 'disabled': /*node.data.Workspace == true ||*/ node.data.Document == true /*|| node.data.CanCopy == false*/ },
                            }
                        },
                        'ViewDetails': { 'name': 'View Details', 'icon': 'view' },
                        //'Preview': { 'name': 'Preview', 'icon': 'view', 'disabled': true },
                        //'DownloadFile': { 'name': 'Download', 'icon': 'download', 'disabled': true },

                        //'quit': { 'name': 'Quit', 'icon': 'quit' },

                    }
                },
                actions: function (node, action, options) {
                    switch (action) {
                        case "CreateWorkspace":
                            var win = GetMainWindow();
                            win.iframeOpenUrl = '@Url.Action("Create", "Workspace", new { @area="Dms"})?parentId='+node.key+'&dataAction=Create';
                            win.OpenWindow({ Title: '@Html.Raw(Resource["ManageWorkspace"])', Width: 450, Height: 750, Position: 'Right' });
                            return false;
                            break;
                        case "EditWorkspace":
                            var win = GetMainWindow();
                            win.iframeOpenUrl = '@Url.Action("Create", "Workspace", new { @area="Dms"})?workspaceId=' + node.key+'&dataAction=Edit';
                            win.OpenWindow({ Title: '@Html.Raw(Resource["ManageWorkspace"])', Width: 450, Height: 750, Position: 'Right' });
                            return false;
                            break;
                        case "CreateFolder":
                            var win = GetMainWindow();
                            win.iframeOpenUrl = '/Dms/Document/ManageFolder?parentId=' + node.key;
                            win.OpenWindow({ Title: '@Html.Raw(Resource["CreateFolder"])', Width: 450, Height: 750, Position: 'Right' });
                            return false;
                            break;
                        case "EditFolder":
                            var win = GetMainWindow();
                            win.iframeOpenUrl = '/Dms/Document/ManageFolder?id=' + node.key;
                            win.OpenWindow({ Title: '@Html.Raw(Resource["EditFolder"])', Width: 450, Height: 750, Position: 'Right' });
                            return false;
                            break;
                        case "UploadFolder":
                            var win = GetMainWindow();
                            win.iframeOpenUrl = '/dms/Document/UploadFolder?parentId=' + node.key;
                            win.OpenWindow({ Title: '@Html.Raw(Resource["UploadFolder"])', Width: 450, Height: 750, Position: 'Right' });
                            return false;
                            break;
                        case "UploadFiles":
                            var win = GetMainWindow();
                            win.iframeOpenUrl = '/dms/Document/UploadFile?parentId=' + node.key;
                            win.OpenWindow({ Title: '@Html.Raw(Resource["UploadFiles"])', Width: 450, Height: 750, Position: 'Right' });
                            return false;
                            break;
                        case "CreateDocument":
                            var url = '/Dms/DocumentPermission/DMSTemplate?parentId=' + node.key;
                            var win = GetMainWindow();
                            win.iframeOpenUrl = url;
                            win.OpenWindow({ Title: '@Html.Raw(Resource["CreateDocument"])', Width: 1200, Height: 650 });
                            return false;
                            break;
                        case "EditDocument":
                            var portalId = $('#GlobalPortalId').val();
                            var url = '/Cms/Page?lo=Popup&cbm=refreshFileManager&pageType=Note&source=View&dataAction=View&templateCodes=' + node.data.TemplateCode + '&recordId=' + node.key + '&portalId=' + portalId ;
                            var win = GetMainWindow();
                            win.iframeOpenUrl = url;
                            win.OpenWindow({ Title: '@Html.Raw(SharedResource["Edit"])', Width: 1200, Height: 650 });
                            return false;
                            break;
                        case "ManagePermission":
                            var url = '/Dms/DocumentPermission/Index?noteId=' + node.key + '&workspaceId=' + node.data.WorkspaceId + '&parentId=' + node.data.parentId + '&isSelfWorkspace=' + node.data.IsSelfWorkspace + '&folderType=' + node.data.FolderType + '&fileId=' + node.data.FileId;
                            var win = GetMainWindow();
                            win.iframeOpenUrl = url;
                            win.OpenWindow({ Title: '@Html.Raw(Resource["ManagePermission"])', Width: 1100, Height: 600 });
                            return false;
                            break;
                        case "ViewPermission":
                            var url = '/Dms/DocumentPermission/ViewPermission?noteId=' + node.key + '&workspaceId=' + node.data.WorkspaceId + '&parentId=' + node.data.parentId;
                            var win = GetMainWindow();
                            win.iframeOpenUrl = url;
                            win.OpenWindow({ Title: '@Html.Raw(Resource["ViewPermission"])', Width: 1100, Height: 600 });
                            return false;
                            break;
                        @*case "ViewWorkflow":
                            var ServiceId = node.data.WorkflowServiceId;
                            workflowTemplateCode = null;
                            isTemplate = false;
                            if (ServiceId == null) {
                                ServiceId = null;
                                workflowTemplateCode = node.data.WorkflowTemplateCode;
                                isTemplate = true;
                            }
                            if (ServiceId == null && workflowTemplateCode == null) {
                                kendo.alert("Work flow not found");
                                return false;
                            } else {
                                var url = '/Cms/NtsService/ServiceDiagram?id=' + ServiceId + "&templateCode=" + workflowTemplateCode + "&isTemplate=" + isTemplate;
                                var win = GetMainWindow();
                                win.iframeOpenUrl = url;
                                win.OpenWindow({ Title: '@Html.Raw(Resource["ViewWorkflow"])', Width: 1200, Height: 600 });
                                return false;
                            }
                            break;
                        case "RaiseApprovalRequest":
                            var portalId = "";
                            if (window.parent == "" || window.parent == undefined) {
                                portalId = $("#GlobalPortalId").val();
                            }
                            else {
                                portalId = window.parent.$("#GlobalPortalId").val();
                            }
                            var templateCode = node.data.WorkflowTemplateCode;
                            var noteId = node.key;
                            var udfs = encodeURIComponent( 'documentId='+noteId);
                            var prms = encodeURIComponent( 'referenceId='+noteId);
                            var url = '/Cms/Page?lo=Popup&cbm=refreshFileManager&source=Create&dataAction=Create&templateCodes=' + templateCode + '&portalId=' + portalId + '&udfs=' + udfs + '&prms=' + prms;
                            LoadCmsPartialView(url, 'Service', true, 1000, 600, '@Html.Raw(Resource["ApprovalRequest"])');
                            return false;
                            break;
                        case "ViewApprovalRequest":
                            var portalId = $('#GlobalPortalId').val();
                            var serviceId = node.data.WorkflowServiceId;
                            var templateCode = node.data.WorkflowTemplateCode;
                            var url = '/Cms/Page?lo=Popup&popup=true&cbm=refreshFileManager&source=View&dataAction=View&templateCodes=' + templateCode +'&portalId=' + portalId + '&recordId=' + serviceId;
                            var win = GetMainWindow();
                            win.iframeOpenUrl = url;
                            win.OpenWindow({ Title: '@Html.Raw(Resource["ViewApprovalRequest"])', Width: 1200, Height: 600 });
                            return false;
                            break;*@
                        case "cut":
                            CLIPBOARD = { mode: 'cut', data: node, action: "context" };
                            ShowNotification("Cut", "success");
                            break;
                        case "copy":
                            CLIPBOARD = { mode: 'copy', data: node, action: "context" };
                            ShowNotification("Copy", "success");
                            break;
                        case "paste":
                            ShowLoader($('.control-section'));
                            OnPaste(node);
                            break;
                        case "delete":
                            var flag = confirm(node.data.Document==true ?'@Resource["DoyoureallywanttoDelete?"]' : "Do you really want to delete ? all the child folder and document inside this will be deleted ");
                            if (flag) {
                                var id = node.key;
                                $.ajax({
                                    url: '@Url.Action("DeleteFolder", "Document", new { @area="DMS"})?id=' + id,
                                    type: 'POST',
                                    data: {},
                                    dataType: 'json',
                                    success: function (result) {
                                        if (result.success) {
                                            ShowNotification("@Resource["DeletedSuccessfully"]", "success");
                                            //RefreshSelectedParentNode();
                                            RefreshWholeFileManager();
                                        }
                                        else {
                                            kendo.alert(result.errors);
                                        }
                                    },
                                    error: function (ert) {

                                    }
                                });

                                return false;
                            }
                            break;
                        case "Archive":
                            var flag = confirm('@Resource["DoyoureallywanttoArchive?"]');
                            if (flag) {
                                var id = node.key;
                                $.ajax({
                                    url: '@Url.Action("ArchiveNote", "Document", new { @area="DMS"})?id=' + id,
                                    type: 'POST',
                                    data: {},
                                    dataType: 'json',
                                    success: function (result) {
                                        if (result.success) {
                                            ShowNotification("@Resource["ArchivedSuccessfully"]", "success");
                                            RefreshSelectedParentNode();
                                        }
                                        else {
                                            kendo.alert(result.errors);
                                        }
                                    },
                                    error: function (ert) {

                                    }
                                });

                                return false;
                            }
                            break;
                        case "ViewDetails":
                            var portalId = $('#GlobalPortalId').val();
                            var url = '/Cms/Page?lo=Popup&pageType=Note&source=View&dataAction=View&disabledEdit=true&templateCodes=' + node.data.TemplateCode+'&recordId=' + node.key + '&portalId=' + portalId;
                            var win = GetMainWindow();
                            win.iframeOpenUrl = url;
                            win.OpenWindow({ Title: '@Html.Raw(Resource["Details"])', Width: 1200, Height: 650 });
                            return false;
                            break;
                        case "DownloadAll":
                            var url = '/Dms/Document/DownloadAll?noteid=' + node.key + '&name=' + node.title;
                            window.open(url, '_blank');
                            return false;
                            break;
                        @*case "Preview":
                            var win = GetMainWindow();
                            win.iframeOpenUrl = '@Url.Action("PreviewAttachment", "Cms", new { @area = "" })?ntsType=NTS_Service&Id=' + node.key + '&canEdit=' + node.data.CanEditDocument;
                            win.OpenWindow({ Title: '@Html.Raw(Resource["PreviewAttachment"])', Width: 1000, Height: 700 });
                            return false;
                            break;
                        case "DownloadFile":
                            url = '/cms/Document/GetFileMongo?fileId=' + node.key;
                            window.open(url, '_blank');
                            return false;
                            break;*@
                        default:
                    }

                }
            }
        });
        if ('@ViewBag.Key' ==null || '@ViewBag.Key'==undefined ||'@ViewBag.Key'=='') {
            renderTreeTable();
            
        }
        $("#filemanager_search").keyup(function (e) {
            //tree = $('#treetable').fancytree('getTree');
            //match = $(this).val();
            //debugger;
            ////tree.filterNodes(match);
            //tree.filterBranches(function (node) {
            //    return node.title === match;
            //});

            //opts = {
            //    autoApply: true,
            //    autoExpand: false,
            //    counter: true,
            //    fuzzy: false,
            //    hideExpandedCounter: true,
            //    hideExpanders: false,
            //    highlight: true,
            //    leavesOnly: false,
            //    nodata: true,
            //    mode: "dimm"
            //};
            //filterFunc =tree.filterNodes;
            //match = $(this).val();
            //if (e && e.which === $.ui.keyCode.ESCAPE || $.trim(match) === "") {
            //    $("#btnResetSearch").trigger("click");
            //    return;
            //}
            //debugger;
            //// Pass a string to perform case insensitive matching
            //filterFunc.call(tree, match, {});

            ////tree.applyFilter(match);
            //$("#btnResetSearch").attr("disabled", false);
        }).focus();
        $("#btnResetSearch").click(function (e) {
            $("#filemanager_search").val("");            
        }).attr("disabled", true);
        $("#btnSearch").click(function (e) {
            var node = $("#tree").fancytree("getActiveNode");
            var id = node != null ? node.key : "";
            var match=$("#filemanager_search").val();
            var win = GetMainWindow();
            win.iframeOpenUrl = '@Url.Action("DocumentSearchResult", "Document", new { @area = "Dms" })?serachstr=' + match + '&parentId=' + id;
            win.OpenWindow({ Title: 'Document Search Result', Width: 1000, Height: 700 });
            return true;
        });
        
    });
    function renderTreeTable(id, source) {
        $("#treetableDiv").show();
        var tree = $('#treetable')[0].classList.contains('fancytree-container');
        if (!tree) {
            $("#treetable").fancytree({
                extensions: ["table", "contextMenu", "filter", "edit", 'dnd'],
                //quicksearch: true,
                checkbox: true,
                selectMode: 2,
                table: {
                    indentation: 20,      // indent 20px per node level
                    nodeColumnIdx: 1,     // render the node title into the 2nd column
                    checkboxColumnIdx: 0  // render the checkboxes into the 1st column
                },
                source: $.ajax({
                    url: id == null ? "/Dms/Document/GetSoureceFolders" : "/Dms/Document/GetChildFoldersAndDocuments",
                    dataType: "json",
                    data: { key: id, activeId: '@ViewBag.Key', viewMode: viewmode }
                }),
                //lazyLoad: function (event, data) {
                //    debugger;
                //    var node = data.node;
                //    // Issue an Ajax request to load child nodes
                //    //data.result = {
                //    //    url: "/Dms/Document/GetChildFoldersAndDocuments",
                //    //    data: { key: node.key }
                //    //}
                //    if (!node.data.Document && !node.data.File) {

                //        var checked = $("#view-matadata").is(':checked');
                //        if (checked) {
                //            var newSourceOption = {
                //                url: "/Dms/Document/GetChildFoldersAndFiles",
                //                type: 'POST',
                //                dataType: "json",
                //                data: { key: node.key }
                //            };
                //            renderTreeTable(node.key, newSourceOption);
                //        }
                //        else {
                //            renderTreeTable(node.key);
                //        }
                //    }

                //},
                dnd: {
                    preventVoidMoves: true, // Prevent dropping nodes 'before self', etc.
                    preventRecursiveMoves: true, // Prevent dropping nodes on own descendants
                    autoExpandMS: 400,
                    draggable: {
                        //zIndex: 1000,
                        // appendTo: "body",
                        // helper: "clone",
                        scroll: false,
                        revert: "invalid"
                    },

                    dragStart: function (node, data) {
                        if (node.data.Workspace == true || node.data.CanCopy == false) {
                            return false;
                        }
                        return true;
                    },
                    dragEnter: function (node, data) {
                        // Prevent dropping a parent below another parent (only sort
                        // nodes under the same parent)
                        /* 					if(node.parent !== data.otherNode.parent){
                                                return false;
                                            }
                                            // Don't allow dropping *over* a node (would create a child)
                                            return ["before", "after"];
                        */
                        return true;
                    },
                    dragDrop: function (node, data) {
                        var flag = confirm('@Resource["Doyoureallywanttomove?"]');
                        if (!flag) {
                            return false;
                        }
                        if (node.data.Workspace == true && data.otherNode.data.Document == true) {
                            ShowNotification("You can not move document to workspace!", "danger");
                            return false;
                        }
                        else if (node.data.Document == true) {
                            ShowNotification("You can not move document to under document!", "danger");
                            return false;
                        }

                        ShowLoader($('.control-section'));
                       // CLIPBOARD = { mode: 'cut', data: data.otherNode, action: "context" };
                        var nodest = $('#treetable').fancytree('getTree').getSelectedNodes();
                        if (nodest.length > 0) {
                            CLIPBOARD = { mode: 'cut', data: nodest, action: "toolbar" };
                        }
                        //data.otherNode.moveTo(node, data.hitMode);
                        //OnPaste(node);
                        OnDropPaste(node);
                    }
                },
                edit: {
                    triggerStart: ["clickActive", "f2", "mac+enter", "shift+click"],
                    beforeEdit: function (event, data) {
                        var node = data.node;
                        // Return false to prevent edit mode
                        if (node.data.Workspace == true && node.data.CanCreateWorkspace == true) {
                            return true;
                        }
                        else if (node.folder == true && node.data.CanRename == true) {
                            return true;
                        }
                        else {
                            return false;
                        }
                    },
                    edit: function (event, data) {
                        // Editor was opened (available as data.input)
                    },
                    save: function (event, data) {
                        ShowLoader($('.control-section'));
                        // Save data.input.val() or return false to keep editor open
                        var node = data.node;
                        var title = data.input.val();
                        rename(title, node.key);
                        // Simulate to start a slow ajax request...
                        setTimeout(function () {
                            // Let's pretend the server returned a slightly modified
                            // title:
                            node.setTitle(node.title);
                            var span = $(node.span);
                            span.find("> span.fancytree-custom-icon").css({
                                fontSize: "18px",
                                marginTop: "0px"
                            });
                            span.find("> span.fancytree-expander").hide();
                            HideLoader($('.control-section'));
                        }, 2000);
                        // We return true, so ext-edit will set the current user input
                        // as title
                        return true;
                    },
                    close: function (event, data) {
                        // Editor was removed
                        if (!data.save) {
                            // Since we started an async request, mark the node as preliminary
                            var node = data.node;
                            var span = $(node.span);
                            span.find("> span.fancytree-custom-icon").css({
                                fontSize: "18px",
                                marginTop: "0px"
                            });
                            span.find("> span.fancytree-expander").hide();
                        }
                    }
                },
                init: function (event, data) {
                    if (data.tree.count() == 0) {
                        $('#Empty-div').removeClass('display-hide');
                    } else {
                        $('#Empty-div').addClass('display-hide');
                    }
                },
                select: function (event, data) {
                    var node = data.node;
                    if (data.targetType === 'checkbox') {
                        //data.node.toggleSelected();
                        var nodes = $('#treetable').fancytree('getTree').getSelectedNodes();
                        if (nodes.length > 0) {
                            $(".tree-hidden").show();

                            if (node.data.Workspace == true || node.data.CanCopy == false) {
                                $("#filemanager_tb_copy").hide();
                                $("#filemanager_tb_cut").hide();
                            }
                            if (node.data.Workspace == true || node.data.CanDelete == false || node.data.WorkflowServiceStatus == "SERVICE_STATUS_INPROGRESS" || node.data.WorkflowServiceStatus == "SERVICE_STATUS_OVERDUE") {
                                $("#filemanager_tb_delete").hide();
                            }
                            if (node.data.Workspace == true || node.data.CanArchive == false || node.data.WorkflowServiceStatus == "SERVICE_STATUS_INPROGRESS" || node.data.WorkflowServiceStatus == "SERVICE_STATUS_OVERDUE") {
                                $("#filemanager_tb_archive").hide();
                            }
                        }
                        else {
                            $("#filemanager_tb_archive").show();
                            $("#filemanager_tb_delete").show();
                            $("#filemanager_tb_copy").show();
                            $("#filemanager_tb_cut").show();
                            $(".tree-hidden").hide();
                        }
                    }
                },
                click: function (event, data) {

                    //var nodes = $('#treetable').fancytree('getTree').getSelectedNodes();
                    //if (nodes.length > 0) {
                    //    //$(".context-menu-root").find('li').addClass("context-menu-disabled");
                    //    $(".context-menu-list").hide();
                    //}
                },
                dblclick: function (event, data) {
                    var node = data.node;
                    if (node.data.Document) {
                        var portalId = $('#GlobalPortalId').val();
                        var url = '/Cms/Page?lo=Popup&pageType=Note&source=View&dataAction=View&disabledEdit=true&templateCodes=' + node.data.TemplateCode + '&recordId=' + node.key + '&portalId=' + portalId;
                        var win = GetMainWindow();
                        win.iframeOpenUrl = url;
                        win.OpenWindow({ Title: '@Html.Raw(Resource["Details"])', Width: 1200, Height: 650 });
                    }
                    else if (node.data.File && node.data.FileId != null) {
                        var win = GetMainWindow();
                        win.iframeOpenUrl = '@Url.Action("PreviewAttachment", "Cms", new { @area = "" })?ntsType=NTS_Service&Id=' + node.data.FileId + '&canEdit=' + node.data.CanEditDocument;
                        win.OpenWindow({ Title: '@Html.Raw(Resource["PreviewAttachment"])', Width: 1000, Height: 700 });
                        return true;
                    }
                    if (!node.data.Document && !node.data.File) {
                        debugger;
                        ShowLoader($('.control-section'));
                        ExpandTree(node);
                        var checked = $("#view-matadata").is(':checked');
                        if (checked) {
                            var newSourceOption = {
                                url: "/Dms/Document/GetChildFoldersAndFiles",
                                type: 'POST',
                                dataType: "json",
                                data: { key: node.key }
                            };
                            renderTreeTable(node.key, newSourceOption);
                        }
                        else {
                            renderTreeTable(node.key);
                        }
                        var finalBread = $(".tree-address-ul")[0];
                        if (finalBread.children.length == 0) {
                            var li = document.createElement("li");
                            li.id = node.key;
                            li.className = "tree-address-list-item";
                            li.onclick = function () {
                                ShowLoader($('.control-section'));
                                ExpandTree(node);
                                renderTreeTable(node.key);
                                var lis = document.getElementsByClassName("tree-address-list-item");
                                for (var i = 0; i < lis.length; i++) {
                                    var sibling = this.nextElementSibling;
                                    if (sibling != null) {
                                        sibling.remove();
                                    }
                                    else {
                                        break;
                                    }
                                }
                                setTimeout(function () {
                                    HideLoader($('.control-section'));
                                }, 2000);
                            };
                            var a = document.createElement("a");
                            a.className = "tree-list-text";
                            a.innerText = node.title;
                            li.append(a);
                            finalBread.append(li);
                        }
                        else {
                            var elm = finalBread.lastElementChild;
                            var li = document.createElement("li");
                            li.id = node.key;
                            li.className = "tree-address-list-item";
                            li.onclick = function () {
                                ShowLoader($('.control-section'));
                                ExpandTree(node);
                                renderTreeTable(node.key);
                                var lis = document.getElementsByClassName("tree-address-list-item");
                                for (var i = 0; i < lis.length; i++) {
                                    var sibling = this.nextElementSibling;
                                    if (sibling != null) {
                                        sibling.remove();
                                    }
                                    else {
                                        break;
                                    }
                                }
                                setTimeout(function () {
                                    HideLoader($('.control-section'));
                                }, 2000);
                            };
                            var span = document.createElement("span");
                            span.className = "fa fa-angle-right";
                            li.append(span);
                            var a = document.createElement("a");
                            a.className = "tree-list-text";
                            a.innerText = node.title;
                            li.append(a);
                            $(li).insertAfter(elm);
                        }
                        setTimeout(function () {
                            HideLoader($('.control-section'));
                        }, 2000);
                    }

                },
                renderNode: function (event, data) {
                    // Optionally tweak data.node.span
                    var node = data.node;
                    var checked = $("#view-matadata").is(':checked');
                    if (checked) {
                        $("#size-th").show();
                        $(".size-td").show();
                    }
                    else {
                        $("#size-th").hide();
                        $(".size-td").hide();
                    }
                    $tdList = $(node.tr).find(">td");
                    // (index #0 is rendered by fancytree by adding the checkbox)
                    //$tdList.eq(1).text(node.getIndexHier()).addClass("alignRight");
                    // (index #2 is rendered by fancytree)
                    $tdList.eq(2).text(node.data.FileSize);
                    $tdList.eq(3).text(node.data.NoteNo);
                    $tdList.eq(4).text(node.data.CreatedBy);
                    $tdList.eq(5).text(ConvertDateS(node.data.CreatedDate));
                    $tdList.eq(6).text(ConvertDateS(node.data.UpdatedDate));
                    $tdList.eq(7).text(node.data.WorkflowServiceStatusName);
                    if (node != null && node.key != "_1") {
                        if (node.data.Workspace) {
                            node.icon = "fa fa-workspace";
                            node.tooltip = true;
                            node.renderTitle();
                        }
                        else if (node.folder) {
                            node.icon = "fa fa-folder";
                            node.tooltip = true;
                            node.renderTitle();
                        }
                        else if (node.data.File) {
                            if (node.title.toLowerCase().search('.pdf') != -1) {
                                node.icon = "fal fa-file-pdf";
                                node.tooltip = true;
                                node.renderTitle();
                            }
                            else if (node.title.toLowerCase().search('.xls') != -1 || node.title.toLowerCase().search('.xlsx') != -1) {
                                node.icon = "fal fa-file-excel";
                                node.tooltip = true;
                                node.renderTitle();
                            }
                            else if (node.title.toLowerCase().search('.csv') != -1) {
                                node.icon = "fal fa-file-csv";
                                node.tooltip = true;
                                node.renderTitle();
                            }
                            else if (node.title.toLowerCase().search('.ppt') != -1) {
                                node.icon = "fal fa-file-powerpoint";
                                node.tooltip = true;
                                node.renderTitle();
                            }
                            else if (node.title.toLowerCase().search('.txt') != -1) {
                                node.icon = "fal fa-file";
                                node.tooltip = true;
                                node.renderTitle();
                            }
                            else if (node.title.toLowerCase().search('.doc') != -1) {
                                node.icon = "fal fa-file-word";
                                node.tooltip = true;
                                node.renderTitle();
                            }
                            else if (node.title.toLowerCase().search('.mp4') != -1) {
                                node.icon = "fal fa-file-video";
                                node.tooltip = true;
                                node.renderTitle();
                            }
                            else if (node.title.toLowerCase().search('.mp3') != -1) {
                                node.icon = "fal fa-file-music";
                                node.tooltip = true;
                                node.renderTitle();
                            }
                            else if (node.title.toLowerCase().search('.jpg') != -1) {
                                node.icon = "fal fa-file-image";
                                node.tooltip = true;
                                node.renderTitle();
                            }
                            else {
                                node.icon = "fal fa-file";
                                node.tooltip = true;
                                node.renderTitle();
                            }

                        }
                        else if (node.data.Document) {
                            node.icon = "fal fa-file-alt";
                            node.tooltip = true;
                            node.renderTitle();

                        }

                        var span = $(node.span);
                        span.find("> span.fancytree-custom-icon").css({
                            fontSize: "18px",
                            marginTop: "0px"
                        });
                        span.find("> span.fancytree-expander").hide();

                    }
                    $("#treetable").trigger("update");
                    
                },
                contextMenu: {
                    menu: function (node) {
                        if(node.selected){
                            return {
                                'Message': { 'name': "Use toolbar menu for multiselect operation."} };
                        }
                        else{
                            return {
                                'workspace': {
                                    'name': 'Workspace',
                                    'items': {
                                        'CreateWorkspace': { 'name': 'Create Workspace', 'icon': 'add', 'disabled': node.data.Workspace == false || node.data.CanCreateWorkspace == false },
                                        'EditWorkspace': { 'name': 'Edit Workspace', 'icon': 'edit', 'disabled': node.data.Workspace == false || node.data.CanCreateWorkspace == false },
                                    }
                                },
                                'folder': {
                                    'name': 'Folder',
                                    'items': {
                                        'CreateFolder': { 'name': 'Create Folder', 'icon': 'add', 'disabled': node.data.Document == true || node.data.CanCreateSubFolder == false },
                                        'EditFolder': { 'name': 'Edit Folder', 'icon': 'edit', 'disabled': node.folder == false || node.data.CanRename == false },
                                    }
                                },
                                'upload': {
                                    'name': 'Upload',
                                    'items': {
                                        'UploadFolder': { 'name': 'Upload Folder', 'icon': 'fas fa-folder-upload', 'disabled': node.data.Document == true || node.data.CanCreateSubFolder == false },
                                        'UploadFiles': { 'name': 'Upload Files', 'icon': 'fas fa-upload', 'disabled': node.folder == false || node.data.CanCreateDocument == false },
                                    }
                                },
                                'document': {
                                    'name': 'Document',
                                    'items': {
                                        'CreateDocument': { 'name': 'Create Document', 'icon': 'add', 'disabled': node.folder == false || node.data.CanCreateDocument == false },
                                        'EditDocument': { 'name': 'Edit Document', 'icon': 'edit', 'disabled': node.data.Document == false || node.data.WorkflowServiceId != null || node.data.CanEditDocument == false },
                                    }
                                },
                                //'sep1': '---------',
                                'permission': {
                                    'name': 'Permission',
                                    'items': {
                                        'ManagePermission': { 'name': 'Manage Permission', 'icon': 'fas fa-tasks', 'disabled': node.data.CanManagePermission == false },
                                        'ViewPermission': { 'name': 'View Permission', 'icon': 'fas fa-eye' },
                                    }
                                },
                                'Workflow': {
                                    'name': 'Workflow',
                                    'items': {
                                        'ViewWorkflow': { 'name': 'View Workflow', 'icon': 'fas fa-eye', 'disabled': node.data.Document == false || node.data.WorkflowTemplateCode == null || node.data.CanEditDocument == false || node.data.DocumentApprovalStatusType != "Approve Through DMS" },
                                        'RaiseApprovalRequest': { 'name': 'Raise Approval Request', 'icon': 'fas fa-fist-raised', 'disabled': node.data.Document == false || node.data.WorkflowTemplateCode == null || node.data.CanEditDocument == false || node.data.StatusName == "NOTE_STATUS_DRAFT" || node.data.DocumentApprovalStatusType != "Approve Through DMS" || node.data.WorkflowServiceId != null },
                                        'ViewApprovalRequest': { 'name': 'View Approval Request', 'icon': 'fas fa-eye', 'disabled': node.data.Document == false || node.data.WorkflowServiceId == null },
                                        'Re-RaiseApprovalRequest': { 'name': 'Re Raise Approval Request', 'icon': 'fas fa-fist-raised', 'disabled': node.data.Document == false || node.data.WorkflowServiceStatus != "SERVICE_STATUS_COMPLETE" || node.data.WorkflowServiceStatus != "SERVICE_STATUS_CANCEL" }
                                    }
                                },
                                'action': {
                                    'name': 'Action',
                                    'items': {
                                        'cut': { 'name': 'Cut', 'cmd': 'cut', 'icon': 'cut', 'disabled': node.data.Workspace == true || node.data.CanCopy == false },
                                        'copy': { 'name': 'Copy', 'cmd': 'copy', 'icon': 'copy', 'disabled': node.data.Workspace == true || node.data.CanCopy == false },
                                        'paste': { 'name': 'Paste', 'cmd': 'paste', 'icon': 'paste', 'disabled': CLIPBOARD == null || node.data.Document == true },
                                        'delete': { 'name': 'Delete', 'icon': 'delete', 'disabled': node.data.Workspace == true || node.data.CanDelete == false || node.data.WorkflowServiceStatus == "SERVICE_STATUS_INPROGRESS" || node.data.WorkflowServiceStatus == "SERVICE_STATUS_OVERDUE" },
                                        'Archive': { 'name': 'Archive', 'icon': 'delete', 'disabled': node.data.Workspace == true || node.data.CanArchive == false || node.data.WorkflowServiceStatus == "SERVICE_STATUS_INPROGRESS" || node.data.WorkflowServiceStatus == "SERVICE_STATUS_OVERDUE" },

                                    }
                                },
                                'download': {
                                    'name': 'Download',
                                    'items': {
                                        'DownloadFile': { 'name': 'Download', 'icon': 'fas fa-download', 'disabled': node.data.Workspace == true || node.data.Folder == true /*|| node.data.CanCopy == false*/ || node.data.FileId == null || node.data.FileId == "" || node.data.FileId == "[]" },
                                        'DownloadAll': { 'name': 'Download All', 'icon': 'fas fa-folder-download', 'disabled': /*node.data.Workspace == true ||*/ node.data.Document == true /*|| node.data.CanCopy == false*/ },
                                    }
                                },
                                'ViewDetails': { 'name': 'View Details', 'icon': 'view' },
                                'Preview': { 'name': 'Preview Attachment', 'icon': 'view', 'disabled': node.data.Workspace == true || node.data.Folder == true || node.data.FileId == null || node.data.FileId == "" || node.data.FileId == "[]" },

                            }
                    }

                    },
                    actions: function (node, action, options) {
                        switch (action) {
                            case "CreateWorkspace":
                                var win = GetMainWindow();
                                win.iframeOpenUrl = '@Url.Action("Create", "Workspace", new { @area="Dms"})?parentId=' + node.key + '&dataAction=Create';
                                win.OpenWindow({ Title: '@Html.Raw(Resource["ManageWorkspace"])', Width: 450, Height: 750, Position: 'Right' });
                                return false;
                                break;
                            case "EditWorkspace":
                                var win = GetMainWindow();
                                win.iframeOpenUrl = '@Url.Action("Create", "Workspace", new { @area="Dms"})?workspaceId=' + node.key + '&dataAction=Edit';
                                win.OpenWindow({ Title: '@Html.Raw(Resource["ManageWorkspace"])', Width: 450, Height: 750, Position: 'Right' });
                                return false;
                                break;
                            case "CreateFolder":
                                var win = GetMainWindow();
                                win.iframeOpenUrl = '/Dms/Document/ManageFolder?parentId=' + node.key;
                                win.OpenWindow({ Title: '@Html.Raw(Resource["CreateFolder"])', Width: 450, Height: 750, Position: 'Right' });
                                return false;
                                break;
                            case "EditFolder":
                                var win = GetMainWindow();
                                win.iframeOpenUrl = '/Dms/Document/ManageFolder?id=' + node.key;
                                win.OpenWindow({ Title: '@Html.Raw(Resource["EditFolder"])', Width: 450, Height: 750, Position: 'Right' });
                                return false;
                                break;
                            case "UploadFolder":
                                var win = GetMainWindow();
                                win.iframeOpenUrl = '/dms/Document/UploadFolder?parentId=' + node.key;
                                win.OpenWindow({ Title: '@Html.Raw(Resource["UploadFolder"])', Width: 450, Height: 750, Position: 'Right' });
                                return false;
                                break;
                            case "UploadFiles":
                                var win = GetMainWindow();
                                win.iframeOpenUrl = '/dms/Document/UploadFile?parentId=' + node.key;
                                win.OpenWindow({ Title: '@Html.Raw(Resource["UploadFiles"])', Width: 450, Height: 750, Position: 'Right' });
                                return false;
                                break;
                            case "CreateDocument":
                                var url = '/Dms/DocumentPermission/DMSTemplate?parentId=' + node.key;
                                var win = GetMainWindow();
                                win.iframeOpenUrl = url;
                                win.OpenWindow({ Title: '@Html.Raw(Resource["CreateDocument"])', Width: 1200, Height: 650 });
                                return false;
                                break;
                            case "EditDocument":
                                var portalId = $('#GlobalPortalId').val();
                                var url = '/Cms/Page?lo=Popup&cbm=refreshFileManager&pageType=Note&source=View&dataAction=View&templateCodes=' + node.data.TemplateCode + '&recordId=' + node.key + '&portalId=' + portalId;
                                var win = GetMainWindow();
                                win.iframeOpenUrl = url;
                                win.OpenWindow({ Title: '@Html.Raw(SharedResource["Edit"])', Width: 1200, Height: 650 });
                                return false;
                                break;
                            case "ManagePermission":
                                debugger;
                                var url = '/Dms/DocumentPermission/Index?noteId=' + node.key + '&workspaceId=' + node.data.WorkspaceId + '&parentId=' + node.data.parentId + '&isSelfWorkspace=' + node.data.IsSelfWorkspace + '&folderType=' + node.data.FolderType + '&fileId=' + node.data.FileId;
                                var win = GetMainWindow();
                                win.iframeOpenUrl = url;
                                win.OpenWindow({ Title: '@Html.Raw(Resource["ManagePermission"])', Width: 1100, Height: 600 });
                                return false;
                                break;
                            case "ViewPermission":
                                var url = '/Dms/DocumentPermission/ViewPermission?noteId=' + node.key + '&workspaceId=' + node.data.WorkspaceId + '&parentId=' + node.data.parentId;
                                var win = GetMainWindow();
                                win.iframeOpenUrl = url;
                                win.OpenWindow({ Title: '@Html.Raw(Resource["ViewPermission"])', Width: 1100, Height: 600 });
                                return false;
                                break;
                            case "ViewWorkflow":
                                var ServiceId = node.data.WorkflowServiceId;
                                workflowTemplateCode = null;
                                isTemplate = false;
                                if (ServiceId == null) {
                                    ServiceId = null;
                                    workflowTemplateCode = node.data.WorkflowTemplateCode;
                                    isTemplate = true;
                                }
                                if (ServiceId == null && workflowTemplateCode == null) {
                                    kendo.alert("Work flow not found");
                                    return false;
                                } else {
                                    var url = '/Cms/NtsService/ServiceDiagram?id=' + ServiceId + "&templateCode=" + workflowTemplateCode + "&isTemplate=" + isTemplate;
                                    var win = GetMainWindow();
                                    win.iframeOpenUrl = url;
                                    win.OpenWindow({ Title: '@Html.Raw(Resource["ViewWorkflow"])', Width: 1200, Height: 600 });
                                    return false;
                                }
                                break;
                            case "RaiseApprovalRequest":
                                var portalId = "";
                                if (window.parent == "" || window.parent == undefined) {
                                    portalId = $("#GlobalPortalId").val();
                                }
                                else {
                                    portalId = window.parent.$("#GlobalPortalId").val();
                                }
                                var templateCode = node.data.WorkflowTemplateCode;
                                var noteId = node.key;
                                var udfs = encodeURIComponent('documentId=' + noteId);
                                var prms = encodeURIComponent('referenceId=' + noteId);
                                var url = '/Cms/Page?lo=Popup&cbm=refreshFileManager&source=Create&dataAction=Create&templateCodes=' + templateCode + '&portalId=' + portalId + '&udfs=' + udfs + '&prms=' + prms;
                                LoadCmsPartialView(url, 'Service', true, 1000, 600, '@Html.Raw(Resource["ApprovalRequest"])');
                                return false;
                                break;
                            case "ViewApprovalRequest":
                                var portalId = $('#GlobalPortalId').val();
                                var serviceId = node.data.WorkflowServiceId;
                                var templateCode = node.data.WorkflowTemplateCode;
                                var url = '/Cms/Page?lo=Popup&popup=true&cbm=refreshFileManager&source=View&dataAction=View&templateCodes=' + templateCode + '&portalId=' + portalId + '&recordId=' + serviceId;
                                var win = GetMainWindow();
                                win.iframeOpenUrl = url;
                                win.OpenWindow({ Title: '@Html.Raw(Resource["ViewApprovalRequest"])', Width: 1200, Height: 600 });
                                return false;
                                break;
                            case "cut":
                                CLIPBOARD = { mode: 'cut', data: node, action: "context" };
                                ShowNotification("Cut", "success");
                                break;
                            case "copy":
                                CLIPBOARD = { mode: 'copy', data: node, action: "context" };
                                ShowNotification("Copy", "success");
                                break;
                            case "paste":
                                ShowLoader($('.control-section'));
                                OnPaste(node);
                                break;
                            case "delete":
                                var flag = confirm(node.data.Document==true ?'@Resource["DoyoureallywanttoDelete?"]' : "Do you really want to delete ? all the child folder and document inside this will be deleted ");
                                if (flag) {
                                    $.ajax({
                                        url: '@Url.Action("DeleteFolder", "Document", new { @area="DMS"})?id=' + node.key,
                                        type: 'POST',
                                        data: {},
                                        dataType: 'json',
                                        success: function (result) {
                                            if (result.success) {
                                                ShowNotification("@Resource["DeletedSuccessfully"]", "success");
                                                //RefreshFileManager();
                                                RefreshWholeFileManager();
                                            }
                                            else {
                                                kendo.alert(result.errors);
                                            }
                                        },
                                        error: function (ert) {

                                        }
                                    });
                                    return false;
                                }
                                break;
                            case "Archive":
                                var flag = confirm('@Resource["DoyoureallywanttoArchive?"]');
                                if (flag) {
                                    $.ajax({
                                        url: '@Url.Action("ArchiveNote", "Document", new { @area="DMS"})?id=' + node.key,
                                        type: 'POST',
                                        data: {},
                                        dataType: 'json',
                                        success: function (result) {
                                            if (result.success) {
                                                ShowNotification("@Resource["ArchivedSuccessfully"]", "success");
                                                RefreshFileManager();
                                            }
                                            else {
                                                kendo.alert(result.errors);
                                            }
                                        },
                                        error: function (ert) {

                                        }
                                    });
                                    return false;
                                }
                                break;
                            case "ViewDetails":
                                var portalId = $('#GlobalPortalId').val();
                                var url = '/Cms/Page?lo=Popup&pageType=Note&source=View&dataAction=View&disabledEdit=true&templateCodes=' + node.data.TemplateCode + '&recordId=' + node.key + '&portalId=' + portalId;
                                var win = GetMainWindow();
                                win.iframeOpenUrl = url;
                                win.OpenWindow({ Title: '@Html.Raw(Resource["Details"])', Width: 1200, Height: 650 });
                                return false;
                                break;
                            case "DownloadFile":
                                var url = '/cms/Document/GetFileMongo?fileId=' + node.data.FileId;
                                window.open(url, '_blank');
                                return false;
                                break;
                            case "DownloadAll":
                                var url = '/Dms/Document/DownloadAll?noteid=' + node.key+ '&name='+node.title;
                                window.open(url, '_blank');
                                return false;
                                break;
                            case "Preview":
                                debugger;
                                var abc = node.data.FileId;
                                var win = GetMainWindow();
                                win.iframeOpenUrl = '@Url.Action("PreviewAttachment", "Cms", new { @area = "" })?ntsType=NTS_Service&Id=' + node.data.FileId + '&canEdit=' + node.data.CanEditDocument;
                                win.OpenWindow({ Title: '@Html.Raw(Resource["PreviewAttachment"])', Width: 1000, Height: 700 });
                                return false;
                                break;
                            default:
                        }

                    }
                }
            });
        }
        else if (source == null) {
            var checked = $("#view-matadata").is(':checked');
            var newSourceOption = {
                url: id == null ? "/Dms/Document/GetSoureceFolders" : checked == true ? "/Dms/Document/GetChildFoldersAndFiles" :  "/Dms/Document/GetChildFoldersAndDocuments",
                type: 'POST',
                dataType: "json",
                data: { key: id }
            };
            var tree = $('#treetable').fancytree('getTree');
            tree.reload(newSourceOption);
        }
        else {
            var tree = $('#treetable').fancytree('getTree');
            tree.reload(source);
        }
        
    }
    function CreateBreadCrum(data) {
        var node = data.node;
        $(".tree-address-ul").empty();
        var parentList = data.node.getParentList();
        if (parentList.length == 0) {
            var bread = $(".tree-address-ul")[0];
            if (bread.children.length == 0) {
                var li = document.createElement("li");
                li.id = node.key;
                li.className = "tree-address-list-item";
                li.onclick = function () {
                    ExpandTree(node);
                    renderTreeTable(node.key);
                    var lis = document.getElementsByClassName("tree-address-list-item");
                    for (var i = 0; i < lis.length; i++) {
                        var sibling = this.nextElementSibling;
                        if (sibling != null) {
                            sibling.remove();
                        }
                        else {
                            break;
                        }
                    }
                };
                var a = document.createElement("a");
                a.className = "tree-list-text";
                a.innerText = node.title;
                li.append(a);
                bread.append(li);
            }
        }
        else {
            parentList.forEach(function (item, index) {
                var bread = $(".tree-address-ul")[0];
                if (bread.children.length == 0) {
                    var li = document.createElement("li");
                    li.id = item.key;
                    li.className = "tree-address-list-item";
                    li.onclick = function () {
                        ExpandTree(item);
                        renderTreeTable(item.key);
                        var lis = document.getElementsByClassName("tree-address-list-item");
                        for (var i = 0; i < lis.length; i++) {
                            var sibling = this.nextElementSibling;
                            if (sibling != null) {
                                sibling.remove();
                            }
                            else {
                                break;
                            }
                        }
                    };
                    var a = document.createElement("a");
                    a.className = "tree-list-text";
                    a.innerText = item.title;
                    li.append(a);
                    bread.append(li);
                }
                else {
                    var elm = bread.lastElementChild;
                    var li = document.createElement("li");
                    li.id = item.key;
                    li.className = "tree-address-list-item";
                    li.onclick = function () {
                        ExpandTree(item);
                        renderTreeTable(item.key);
                        var lis = document.getElementsByClassName("tree-address-list-item");
                        for (var i = 0; i < lis.length; i++) {
                            var sibling = this.nextElementSibling;
                            if (sibling != null) {
                                sibling.remove();
                            }
                            else {
                                break;
                            }
                        }
                    };
                    var span = document.createElement("span");
                    span.className = "fa fa-angle-right";
                    li.append(span);
                    var a = document.createElement("a");
                    a.className = "tree-list-text";
                    a.innerText = item.title;
                    li.append(a);
                    $(li).insertAfter(elm);
                }
            });
            var finalBread = $(".tree-address-ul")[0];
            var elm = finalBread.lastElementChild;
            var li = document.createElement("li");
            li.id = node.key;
            li.className = "tree-address-list-item";
            li.onclick = function () {
                ExpandTree(node);
                renderTreeTable(node.key);
                var lis = document.getElementsByClassName("tree-address-list-item");
                for (var i = 0; i < lis.length; i++) {
                    var sibling = this.nextElementSibling;
                    if (sibling != null) {
                        sibling.remove();
                    }
                    else {
                        break;
                    }
                }
            };
            var span = document.createElement("span");
            span.className = "fa fa-angle-right";
            li.append(span);
            var a = document.createElement("a");
            a.className = "tree-list-text";
            a.innerText = node.title;
            li.append(a);
            $(li).insertAfter(elm);


        }
    }
    function ConvertDateS(date) {
        if (date != undefined && date != null) {
            var d = new Date(date).toLocaleDateString("en-GB", {
                day: "numeric",
                month: "numeric",
                year: "numeric"
            }).split("/").join("-");
            return d;
        }
        return "";
    }
    function RefreshWholeFileManager() {
        var newSourceOption = {
            url: "/Dms/Document/GetSoureceFolders",
            dataType: "json",
        };
        var tree = $('#tree').fancytree('getTree');
        tree.reload(newSourceOption);
        renderTreeTable();
    }
    function RefreshFileManager() {
        //var newSourceOption = {
        //    url: "/Dms/Document/GetSoureceFolders",
        //    dataType: "json",
        //};
        //var tree = $('#tree').fancytree('getTree');
        //tree.reload(newSourceOption);
        //debugger;
        var node = $("#tree").fancytree("getActiveNode");
        node.resetLazy();
        node.load(false);
        node.setExpanded(true);
        var checked = $("#view-matadata").is(':checked');
        if (checked) {
            var newSourceOption = {
                url: "/Dms/Document/GetChildFoldersAndFiles",
                type: 'POST',
                dataType: "json",
                data: { key: node.key }
            };
            renderTreeTable(node.key, newSourceOption);
        }
        else {
            renderTreeTable(node.key);
        }

    }
    function RefreshSelectedParentNode() {
        //debugger;
        var node = $("#tree").fancytree("getActiveNode").parent;
        node.resetLazy();
        node.load(false);
        node.setActive();
        node.setExpanded(true);
        var checked = $("#view-matadata").is(':checked');
        if (checked) {
            var newSourceOption = {
                url: "/Dms/Document/GetChildFoldersAndFiles",
                type: 'POST',
                dataType: "json",
                data: { key: node.key }
            };
            renderTreeTable(node.key, newSourceOption);
        }
        else {
            renderTreeTable(node.key);
        }
    }
    function ExpandTree(rnode) {
        var newSourceOption = {
            url: "/Dms/Document/GetSoureceFolders",
            type: 'POST',
            dataType: "json",
            data: { key: rnode.key }
        };
        var tree = $("#tree").fancytree('getTree');
        tree.reload(newSourceOption);
    }
    function refreshFileManager() {
        //var newSourceOption = {
        //    url: "/Dms/Document/GetSoureceFolders",
        //    dataType: "json",
        //};
        //var tree = $('#tree').fancytree('getTree');
        //tree.reload(newSourceOption);
        var node = $("#tree").fancytree("getActiveNode");
        node.resetLazy();
        node.load(false);
        node.setExpanded(true);
        var checked = $("#view-matadata").is(':checked');
        if (checked) {
            var newSourceOption = {
                url: "/Dms/Document/GetChildFoldersAndFiles",
                type: 'POST',
                dataType: "json",
                data: { key: node.key }
            };
            renderTreeTable(node.key, newSourceOption);
        }
        else {
            renderTreeTable(node.key);
        }
    }
    function OnRefresh() {
        var node = $("#tree").fancytree("getActiveNode");
        if (node != null) {
            node.resetLazy();
            node.load(false);
            node.setExpanded(true);
            var checked = $("#view-matadata").is(':checked');
            if (checked) {
                var newSourceOption = {
                    url: "/Dms/Document/GetChildFoldersAndFiles",
                    type: 'POST',
                    dataType: "json",
                    data: { key: node.key }
                };
                renderTreeTable(node.key, newSourceOption);
            }
            else {
                renderTreeTable(node.key);
            }
        }
        else {
            var newSourceOption = {
                url: "/Dms/Document/GetSoureceFolders",
                dataType: "json",
            };
            var tree = $('#tree').fancytree('getTree');
            tree.reload(newSourceOption);
            renderTreeTable();
        }

        //$("#filemanager_tb_refresh").css("background-color","lightgrey");
    }
    function OnCreateWorkspace() {
        var win = GetMainWindow();
        win.iframeOpenUrl = '@Url.Action("Create", "Workspace", new { @area="Dms"})?dataAction=Create';
        win.OpenWindow({ Title: '@Html.Raw(Resource["ManageWorkspace"])', Width: 450, Height: 750, Position: 'Right'});
        return false;
    }
    function OnDelete() {
         var flag = confirm('@Resource["DoyoureallywanttoDelete?"]');
        if (flag) {
            var id = "";
            var nodes = $('#treetable').fancytree('getTree').getSelectedNodes();
            if (nodes.length > 0) {
                for (var i = 0; i < nodes.length; i++) {
                    id += nodes[i].key + ",";
                    if (i == nodes.length - 1) {
                        $.ajax({
                            url: '@Url.Action("DeleteMultipleNote", "Document", new { @area="DMS"})?ids=' + id,
                            type: 'POST',
                            data: {},
                            dataType: 'json',
                            success: function (result) {
                                if (result.success) {
                                    ShowNotification("@Resource["DeletedSuccessfully"]", "success");
                                    RefreshFileManager();
                                }
                                else {
                                    kendo.alert(result.errors);
                                }
                            },
                            error: function (ert) {

                            }
                        });
                    }
                }
            }
            return false;
        }
    }
    function OnArchive() {
        var flag = confirm('@Resource["DoyoureallywanttoArchive?"]');
        if (flag) {
            var id = "";
            var nodes = $('#treetable').fancytree('getTree').getSelectedNodes();
            if (nodes.length > 0) {
                for (var i = 0; i < nodes.length; i++) {
                    id += nodes[i].key + ",";
                    if (i == nodes.length - 1) {
                        $.ajax({
                            url: '@Url.Action("ArchiveMultipleNote", "Document", new { @area="DMS"})?ids=' + id,
                            type: 'POST',
                            data: {},
                            dataType: 'json',
                            success: function (result) {
                                if (result.success) {
                                    ShowNotification("@Resource["ArchivedSuccessfully"]", "success");
                                    RefreshFileManager();
                                }
                                else {
                                    kendo.alert(result.errors);
                                }
                            },
                            error: function (ert) {

                            }
                        });
                    }
                }
            }
            return false;
        }
    }
    function OnCopy() {
        ShowNotification("Copy", "success");
        var nodes = $('#treetable').fancytree('getTree').getSelectedNodes();
        if (nodes.length > 0) {
            CLIPBOARD = { mode: 'copy', data: nodes, action: "toolbar" };
        }
    }
    function OnCut() {
        ShowNotification("Cut", "success");
        var nodes = $('#treetable').fancytree('getTree').getSelectedNodes();
        if (nodes.length > 0) {
            CLIPBOARD = { mode: 'cut', data: nodes, action:"toolbar" };
        }
    }
    function OnPaste(target) {
        var cmd = CLIPBOARD.mode;
        var source = CLIPBOARD.data;
        var action = CLIPBOARD.action;
        if (action == "toolbar") {
            var ids = "";
            if (source.length > 0) {
                for (var i = 0; i < source.length; i++) {
                    ids += source[i].key + ",";
                    if (i == source.length - 1) {
                        if (cmd == "copy") {
                            $.ajax({
                                url: '@Url.Action("CopyMultipleNote", "Document", new { @area="DMS"})?sourceIds=' + ids +'&targetId='+target.key,
                                type: 'POST',
                                data: {},
                                dataType: 'json',
                                success: function (result) {
                                    if (jQuery.isEmptyObject(result)) {
                                        ShowNotification("Copied Successfully", "success");
                                        HideLoader($('.control-section'));
                                        RefreshFileManager();
                                    }
                                    else {
                                        kendo.alert(result["Error"]);
                                        HideLoader($('.control-section'));
                                    }
                                },
                                error: function (ert) {

                                }
                            });
                        }
                        else if (cmd == "cut") {
                            $.ajax({
                                url: '@Url.Action("MoveMultipleNote", "Document", new { @area="DMS"})?sourceIds=' + ids +'&targetId='+target.key,
                                type: 'POST',
                                data: {},
                                dataType: 'json',
                                success: function (result) {
                                    if (jQuery.isEmptyObject(result)) {
                                        ShowNotification("Moved Successfully", "success");
                                        HideLoader($('.control-section'));
                                        RefreshWholeFileManager();
                                    }
                                    else {
                                        kendo.alert(result["Error"]);
                                        HideLoader($('.control-section'));
                                    }
                                },
                                error: function (ert) {

                                }
                            });
                        }
                    }
                }
            }
        }
        else {
            if (cmd == "copy") {
            $.ajax({
                url: '@Url.Action("CopyNote", "Document", new { @area="DMS"})?sourceId=' + source.key +'&targetId='+target.key,
                type: 'POST',
                data: {},
                dataType: 'json',
                success: function (result) {
                    if (jQuery.isEmptyObject(result)) {
                        ShowNotification("Copied Successfully", "success");
                        HideLoader($('.control-section'));
                        RefreshFileManager();
                    }
                    else {
                        kendo.alert(result["Error"]);
                        HideLoader($('.control-section'));
                    }
                },
                error: function (ert) {

                }
            });
        }
        else if (cmd == "cut") {
            $.ajax({
                url: '@Url.Action("MoveNote", "Document", new { @area="DMS"})?sourceId=' + source.key +'&targetId='+target.key,
                type: 'POST',
                data: {},
                dataType: 'json',
                success: function (result) {
                    if (jQuery.isEmptyObject(result)) {
                        ShowNotification("Moved Successfully", "success");
                        HideLoader($('.control-section'));
                        RefreshWholeFileManager();
                    }
                    else {
                        kendo.alert(result["Error"]);
                        HideLoader($('.control-section'));
                    }
                },
                error: function (ert) {

                }
            });
        }
        }
        CLIPBOARD = null;
        return false;
    }
    function OnDropPaste(target) {

        var cmd = CLIPBOARD.mode;
        var source = CLIPBOARD.data;
        var action = CLIPBOARD.action;

            var ids = "";
            if (source.length > 0) {
                for (var i = 0; i < source.length; i++) {
                    ids += source[i].key + ",";
                    if (i == source.length - 1) {

                            $.ajax({
                                url: '@Url.Action("MoveMultipleNote", "Document", new { @area="DMS"})?sourceIds=' + ids +'&targetId='+target.key,
                                type: 'POST',
                                data: {},
                                dataType: 'json',
                                success: function (result) {
                                    if (jQuery.isEmptyObject(result)) {
                                        ShowNotification("Moved Successfully", "success");
                                        HideLoader($('.control-section'));
                                        RefreshFileManager();
                                    }
                                    else {
                                        kendo.alert(result["Error"]);
                                        HideLoader($('.control-section'));
                                    }
                                },
                                error: function (ert) {

                                }
                            });

                    }
                }
            }


        CLIPBOARD = null;
        return false;
    }
    function OnViewChange() {
        //debugger;
        var checked = $("#view-matadata").is(':checked');
        var node = $("#tree").fancytree("getActiveNode");
        if (checked) {
            var newSourceOption = {
                url: node == null ? "/Dms/Document/GetSoureceFolders" : "/Dms/Document/GetChildFoldersAndFiles",
                type: 'POST',
                dataType: "json",
                data: { key: node != null ? node.key:null }
            };
            var tree = $('#treetable').fancytree('getTree');
            tree.reload(newSourceOption);
            localStorage.setItem("viewmode", "file");
        }
        else {
            var newSourceOption = {
                url: node == null ? "/Dms/Document/GetSoureceFolders" : "/Dms/Document/GetChildFoldersAndDocuments",
                type: 'POST',
                dataType: "json",
                data: { key: node != null ? node.key : null }
            };
            var tree = $('#treetable').fancytree('getTree');
            tree.reload(newSourceOption);
            localStorage.setItem("viewmode", "metadata");
        }
    }
    function rename(name,id) {
        $.ajax({
                                    url: '@Url.Action("Rename", "Document", new { @area="DMS"})?name=' + name +'&noteid='+id,
                                    type: 'POST',
                                    data: {},
                                    dataType: 'json',
                                    success: function (result) {
                                        if (result.success) {
                                            return true;
                                        }
                                        else {
                                            return false;
                                        }
                                    },
                                    error: function (ert) {

                                    }
                                });
    }
    var splitter = $('.splitter-container').height(200).split({
        orientation: 'vertical',
        limit: 10,
        position: '25%', // if there is no percentage it interpret it as pixels
        onDrag: function (event) {
            console.log(splitter.position());
        }
    });
    function onSelecAllchange() {
        var checked = $("#btnToggleSelect").is(':checked');
        if (checked) {
            $("#treetable").fancytree("getTree").visit(function (node) {
                node.setSelected(true);
                debugger;
                $(".tree-hidden").show();
                if (node.data.Workspace == true || node.data.CanCopy == false) {
                    $("#filemanager_tb_copy").hide();
                    $("#filemanager_tb_cut").hide();
                }
                if (node.data.Workspace == true || node.data.CanDelete == false || node.data.WorkflowServiceStatus == "service_status_inprogress" || node.data.WorkflowServiceStatus == "service_status_overdue") {
                    $("#filemanager_tb_delete").hide();
                }
                if (node.data.Workspace == true || node.data.CanArchive == false || node.data.WorkflowServiceStatus == "service_status_inprogress" || node.data.WorkflowServiceStatus == "service_status_overdue") {
                    $("#filemanager_tb_archive").hide();
                }
            });
        }
        else {
            $("#treetable").fancytree("getTree").visit(function (node) {
                node.setSelected(false);
                $("#filemanager_tb_archive").show();
                $("#filemanager_tb_delete").show();
                $("#filemanager_tb_copy").show();
                $("#filemanager_tb_cut").show();
                $(".tree-hidden").hide();
            });
        }

    }

    //function minString(value) {
    //    if (value != null) {
    //        //return value.length > 36 ?
    //        //    value.substring(0, 35) + "..." :
    //            value;
    //    } else {
    //        return "";
    //    }
    //}

    //$("#col-name").attr("style", "min-width:300px");
    $(function () {        $("#treetable").addClass("tablesorter");        $("#treetable").tablesorter({
            dateFormat: 'uk',            sortInitialOrder: 'desc',
            theme: 'ice', headers: {
                0: {
                    sorter: false
                },
                5: {
                    sorter: 'shortDate'
                },
                6: {
                    sorter: 'shortDate'
                }
            }});        $("th").resizable();    });
    
</script>










