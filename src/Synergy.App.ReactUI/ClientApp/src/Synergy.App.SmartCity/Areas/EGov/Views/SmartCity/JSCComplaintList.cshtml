@using Synergy.App.ViewModel;
@using Synergy.App.Common;
@model EGovDashboardViewModel
@inject Synergy.App.Common.IUserContext _userContext;

@{
    ViewData["Title"] = "Dashboard";
    Layout = null;

}
<link type="text/css" rel="stylesheet" href="~/css/cms/DashBoard.css" asp-append-version="true" />
<style>
    .summary-card {
        width: 400px;
        margin-right: 100px;
    }

    .summary-card-body {
        width: 400px;
    }

    .border-right {
        border-right: 1px solid #006699 !important;
    }

    .summary-card-header {
        width: 400px;
    }

    a {
        color: dodgerblue;
    }

    .value {
        color: #346cb0;
        text-decoration: underline;
        cursor: pointer;
    }
</style>

<script type="text/javascript">


    function OpenTask(id, tempCode) {

        var portalId = $('#GlobalPortalId').val();
        var url = '/EGov/SmartCity/ManageGrievanceForm?complaintId=' + id;
        var win = GetMainWindow();
        win.iframeOpenUrl = url;
        win.OpenWindow({ Title: 'View Complaint', Width: 1200, Height: 700 });
        return false;
    }



    var columnDefs = [
        {
            headerName: "Complaint No",
            field: "ServiceNo",
            suppressSizeToFit: true,
            cellRenderer: params => {
                var a = "";
                debugger;
                var cnt = params.data.FlagDetails.length;
                for (var i = 0; i < cnt; i++) {
                    if (params.data.FlagDetails[i].LevelUserRole.includes("COMPLAINT_RESOLVER_LEVEL_2")) {
                        a = a + '<span style="color:dodgerblue;padding-left: 2px;font-weight:bold" class="fas fa-flag-pennant" title = "' + params.data.FlagDetails[i].OwnerUserName + '"> 2 </span>';
                    }
                    if (params.data.FlagDetails[i].LevelUserRole.includes("COMPLAINT_RESOLVER_LEVEL_3")) {
                        a = a + '<span style="color:orange;padding-left: 2px" class="fas fa-flag-pennant" title = "' + params.data.FlagDetails[i].OwnerUserName + '"> 3 </span>';
                    }
                    if (params.data.FlagDetails[i].LevelUserRole.includes("COMPLAINT_RESOLVER_LEVEL_4")) {
                        a = a + '<span style="color:red;padding-left: 2px" class="fas fa-flag-pennant" title = "' + params.data.FlagDetails[i].OwnerUserName + '"> 4 </span>';
                    }

                }
                if (params.data.ReopenCount > 0) {
                    a = a + " <span title='Reopened' style='color:blue;cursor:pointer' class='fas fa-rotate-right'></span>";
                }

                if (params.data.GrvStatusCode == null || params.data.GrvStatusCode == "GRV_PENDING") {
                    return a + "<input title='View Details' style='font-weight:bold' type='button' class='btn btn-link' onclick='OpenTask(\"" + params.data.Id + "\",\"" + params.data.TemplateCode + "\" )' value=\"" + params.value + "\" />";
                } else {
                    return a + "<input title='View Details' type='button' class='btn btn-link' onclick='OpenTask(\"" + params.data.Id + "\",\"" + params.data.TemplateCode + "\" )' value=\"" + params.value + "\" />";
                }

            }
        },
        {
            headerName: "Department",
            field: "Department",
            cellRenderer: params => {
                if (params.data.GrvStatusCode == null || params.data.GrvStatusCode == "GRV_PENDING") {
                    return "<span style='font-weight:bold'>" + params.value + "<span/>";
                } else {
                    return params.value;
                }
            }
        },
        {
            headerName: "Complaint Type",
            field: "GrievanceType",
            cellRenderer: params => {
                if (params.data.GrvStatusCode == null || params.data.GrvStatusCode == "GRV_PENDING") {
                    return "<span style='font-weight:bold'>" + params.value + "<span/>";
                } else {
                    return params.value;
                }
            }

        },
        {
            headerName: "Name",
            field: "Name",
            cellRenderer: params => {
                if (params.data.GrvStatusCode == null || params.data.GrvStatusCode == "GRV_PENDING") {
                    return "<span style='font-weight:bold'>" + params.value + "<span/>";
                } else {
                    return params.value;
                }
            }
        },
        {
            headerName: "Complaint Status",
            field: "GrvStatus",
            cellRenderer: params => {
                debugger;
                if (params.data.GrvStatusCode == null || params.data.GrvStatusCode == "GRV_PENDING") { return "<div style='background-color:#f7f5bc;padding-left:10px;font-weight:bold'>  Pending</div>"; }
                if (params.data.GrvStatusCode == "GRV_IN_PROGRESS") { return "<div style='background-color:#DFE9F5;padding-left:10px'>  " + params.value + "</div>"; }
                if (params.data.GrvStatusCode == "GRV_NOT_PERTAINING") { return "<div style='background-color:#FFCD91;padding-left:10px'>   " + params.value + "</div>"; }
                if (params.data.GrvStatusCode == "GRV_DISPOSED") { return "<div style='background-color:#90EE90;padding-left:10px'>   " + params.value + "</div>"; }
                else { return params.value; }
            }
        },
        {
            headerName: "Complaint Date",
            field: "CreatedDate",
            cellRenderer: params => {
                var date = new Date(params.value);

                if (params.data.GrvStatusCode == null || params.data.GrvStatusCode == "GRV_PENDING") {
                    return "<span style='font-weight:bold'>" + datefun(date) + "<span/>";
                } else {
                    return datefun(date);
                }
            }
        },
    ];

    function datefun(d) {
        let h = addZero(d.getHours());
        let m = addZero(d.getMinutes());

        return d.getDate() + "." + (d.getMonth() + 1) + "." + d.getFullYear() + " " + h + ":" + m;
    }

    function addZero(i) {
        if (i < 10) { i = "0" + i }
        return i;
    }


    $(function () {
        getEmployeeDashboardData('');
    });

    $(document).ready(function () {
        document.getElementById("pCnt").innerHTML = '@ViewBag.PendingCount';
        document.getElementById("ipCnt").innerHTML = '@ViewBag.InProgressCount';
        document.getElementById("npCnt").innerHTML = '@ViewBag.NotPertainedCount';
        document.getElementById("dCnt").innerHTML = '@ViewBag.DisposedCount';

    });

    function getEmployeeDashboardData(status) {
        var url = "/EGov/SmartCity/ReadComplaintData";
        document.getElementById("kGridView").innerHTML = "";
        if (status != '') {
            url = "/EGov/SmartCity/ReadComplaintData?status=" + status;
            document.getElementById("showall").style.display = "";
        } else {
            document.getElementById("showall").style.display = "none";
        }

        gridConfig(
            "kGridView",
            url,
            columnDefs,
            false,
            true,
            true,
            true,
            1,
            true,
            10);
    }

    function RefreshComplaintGrid(msg) {
        getEmployeeDashboardData('');
        getComplaintCountByStatus();
        myalert(msg);
    }

    function getComplaintCountByStatus() {
        $.ajax({
            url: '/EGov/SmartCity/GetComplaintCountByStatus',
            type: "Get",
            dataType: "json",
            success: function (result) {
                document.getElementById("pCnt").innerHTML = result.PendingCount;
                document.getElementById("ipCnt").innerHTML = result.InProgressCount;
                document.getElementById("npCnt").innerHTML = result.NotPertainedCount;
                document.getElementById("dCnt").innerHTML = result.DisposedCount;
            }
        });
    }


    function myalert(content) {
        $("<div></div>").kendoAlert({
            title: "Submission Confirmation",
            content: content.msg
        }).data("kendoAlert").open();
    }


</script>



<div class="container col-12" style="padding:10px;margin-top:20px;">
    <h3>Complaints</h3>

    <div class="row" style="padding: 2%;">
        <div class="col">
            <div class="metric metric-bordered">
                <div class="metric-badge">
                    <span class="badge badge-lg badge-success" style="background-color:#f7f5bc;color: black;"><span class="oi oi-media-record pulse mr-1"></span> PENDING</span>
                </div>
                <p class="metric-value h3">
                    <a onclick="getEmployeeDashboardData('GRV_PENDING')"><span  class="value" id="pCnt"></span></a>
                </p>
            </div>
        </div>

        <div class="col">
            <div class="metric metric-bordered">
                <div class="metric-badge">
                    <span class="badge badge-lg badge-success" style="background-color:#DFE9F5;color: black;"><span class="oi oi-media-record pulse mr-1"></span> IN PROGRESS</span>
                </div>
                <p class="metric-value h3">
                    <a onclick="getEmployeeDashboardData('GRV_IN_PROGRESS')"> <span class="value" id="ipCnt"></span></a>
                </p>
            </div>
        </div>

        <div class="col">
            <div class="metric metric-bordered">
                <div class="metric-badge">
                    <span class="badge badge-lg badge-success" style="background-color:#FFCD91;color: black;"><span class="oi oi-media-record pulse mr-1"></span> NOT PERTAINING</span>
                </div>
                <p class="metric-value h3">
                    <a onclick="getEmployeeDashboardData('GRV_NOT_PERTAINING')"> <span class="value" id="npCnt"></span></a>
                </p>
            </div>
        </div>

        <div class="col">
            <div class="metric metric-bordered">
                <div class="metric-badge">
                    <span class="badge badge-lg badge-success" style="background-color:#90EE90;color: black;"><span class="oi oi-media-record pulse mr-1"></span> DISPOSED</span>
                </div>
                <p class="metric-value h3">
                    <a onclick="getEmployeeDashboardData('GRV_DISPOSED')"> <span class="value" id="dCnt"></span></a>
                </p>
            </div>
        </div>
    </div>
    <div style="text-align:end;padding: 1%;"><button id="showall" class="btn btn-primary" onclick="getEmployeeDashboardData('')">Show All</button></div>
    <div class="col-12 p-2">
        <div id="kGridView" style="width: 100%;height:550px" class="ag-theme-alpine"></div>
    </div>
</div>

