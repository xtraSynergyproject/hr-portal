@using Synergy.App.WebUtility;
@*@using Kendo.Mvc.UI;*@
@using Synergy.App.Common;

@model TeamWorkloadViewModel;

@{
    ViewBag.Title = "Project Dashboard";
    //Layout = "~/Areas/CMS/Views/Shared/_LayoutCms.cshtml";
    Layout = null;
}
<link href="~/js/FullCalendar/core/main.css" rel="stylesheet" />
<link href="~/js/FullCalendar/daygrid/main.css" rel="stylesheet" />
<link href="~/js/FullCalendar/timegrid/main.css" rel="stylesheet" />
<link href="~/js/FullCalendar/list/main.css" rel="stylesheet" />
<script src="~/js/FullCalendar/core/main.js"></script>
<script src="~/js/FullCalendar/interaction/main.js"></script>
<script src="~/js/FullCalendar/daygrid/main.js"></script>
<script src="~/js/FullCalendar/timegrid/main.js"></script>
<script src="~/js/FullCalendar/list/main.js"></script>
<style>
    .popper,
    .tooltip {
        position: absolute;
        z-index: 9999;
        background: #FFC107;
        color: black;
        width: 150px;
        border-radius: 3px;
        box-shadow: 0 0 2px rgba(0,0,0,0.5);
        padding: 10px;
        text-align: center;
    }

    .style5 .tooltip {
        background: #1E252B;
        color: #FFFFFF;
        max-width: 200px;
        width: auto;
        font-size: .8rem;
        padding: .5em 1em;
    }

    .popper .popper__arrow,
    .tooltip .tooltip-arrow {
        width: 0;
        height: 0;
        border-style: solid;
        position: absolute;
        margin: 5px;
    }

    .tooltip .tooltip-arrow,
    .popper .popper__arrow {
        border-color: #FFC107;
    }

    .style5 .tooltip .tooltip-arrow {
        border-color: #1E252B;
    }

    .popper[x-placement^="top"],
    .tooltip[x-placement^="top"] {
        margin-bottom: 5px;
    }

        .popper[x-placement^="top"] .popper__arrow,
        .tooltip[x-placement^="top"] .tooltip-arrow {
            border-width: 5px 5px 0 5px;
            border-left-color: transparent;
            border-right-color: transparent;
            border-bottom-color: transparent;
            bottom: -5px;
            left: calc(50% - 5px);
            margin-top: 0;
            margin-bottom: 0;
        }

    .popper[x-placement^="bottom"],
    .tooltip[x-placement^="bottom"] {
        margin-top: 5px;
    }

        .tooltip[x-placement^="bottom"] .tooltip-arrow,
        .popper[x-placement^="bottom"] .popper__arrow {
            border-width: 0 5px 5px 5px;
            border-left-color: transparent;
            border-right-color: transparent;
            border-top-color: transparent;
            top: -5px;
            left: calc(50% - 5px);
            margin-top: 0;
            margin-bottom: 0;
        }

    .tooltip[x-placement^="right"],
    .popper[x-placement^="right"] {
        margin-left: 5px;
    }

        .popper[x-placement^="right"] .popper__arrow,
        .tooltip[x-placement^="right"] .tooltip-arrow {
            border-width: 5px 5px 5px 0;
            border-left-color: transparent;
            border-top-color: transparent;
            border-bottom-color: transparent;
            left: -5px;
            top: calc(50% - 5px);
            margin-left: 0;
            margin-right: 0;
        }

    .popper[x-placement^="left"],
    .tooltip[x-placement^="left"] {
        margin-right: 5px;
    }

        .popper[x-placement^="left"] .popper__arrow,
        .tooltip[x-placement^="left"] .tooltip-arrow {
            border-width: 5px 0 5px 5px;
            border-top-color: transparent;
            border-right-color: transparent;
            border-bottom-color: transparent;
            right: -5px;
            top: calc(50% - 5px);
            margin-left: 0;
            margin-right: 0;
        }
</style>

<script>
    $(document).ready(function () {

        HideLoader($("#global-overlay"));
        var Draggable = FullCalendarInteraction.Draggable;

        var containerEl = document.getElementById('external-events-list');
        new Draggable(containerEl, {
            itemSelector: '.fc-event',
            eventData: function (eventEl) {
                return {
                    title: eventEl.innerText.trim()
                }
            }
        });



        var Calendar = FullCalendar.Calendar;
        var calendarEl = document.getElementById('calendar');
        var calendar = new Calendar(calendarEl, {
            plugins: ['interaction', 'dayGrid', 'timeGrid', 'list'],
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            //eventRender: function (event, element, view) {
            //    return $('<div>' + event.title + '</div>');
            //},
            ////eventRender: function (info) {
            ////    var tooltip = new Tooltip(info.el, {
            ////        title: info.event.extendedProps.description,
            ////        placement: 'top',
            ////        trigger: 'hover',
            ////        container: 'body'
            ////    });
            ////},
            events: '/pjm/project/ReadProjectPlanningTaskData?projectId=@Model.Id',
            editable: true,
            droppable: true, // this allows things to be dropped onto the calendar
            drop: function (arg) {
                var sd = kendo.toString(arg.date, '@ApplicationConstant.DateAndTime.DefaultDateTimeFormatOnly');
                var data = {
                    "Id": arg.draggedEl.id,
                    "StartDate": sd,
                };
                var url = "/pjm/project/UpdateTaskScheduleDate"
                $.ajax({
                    type: "POST",
                    data: data,
                    url: url,
                    dataType: 'json',
                    success: function (res) {

                    },
                    error: function (e) {

                    }
                });
                //
                // is the "remove after drop" checkbox checked?
                //if (document.getElementById('drop-remove').checked) {
                //    arg.draggedEl.parentNode.removeChild(arg.draggedEl);
                //}
            },
            eventDrop: function (e) {
                
                
                    var sd = kendo.toString(e.event.start, '@ApplicationConstant.DateAndTime.DefaultDateTimeFormatOnly');
                    var ed = kendo.toString(e.event.end, '@ApplicationConstant.DateAndTime.DefaultDateTimeFormatOnly');
                    var data = {
                        "Id": e.event.id,
                        "StartDate": sd,
                        "DueDate": ed,
                    };
                    var url = "/pjm/project/UpdateTaskScheduleDate"
                    $.ajax({
                        type: "POST",
                        data: data,
                        url: url,
                        dataType: 'json',
                        success: function (res) {

                        },
                        error: function (e) {

                        }
                    });
                
            },
            eventResize: function (info) {
                alert(info.event.title + " end is now " + info.event.end.toISOString());

                if (!confirm("is this okay?")) {
                    info.revert();
                }
            }
        });
        calendar.render();



    });

    //for random color
    var colors = ['#F08963', '#84B779', '#5BA79F', '#7A8F9D', '#4F67B6', '#5CBBF3'];



    function dataBound() {
        var childDiv = document.getElementsByClassName('fc-event');
        //
        for (var i = 0; i < childDiv.length; i++) {
            childDiv[i].style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        }
    }

    function OnCheck(e)
    {
        alert("Checked");
    }
    function OnNewTask()
    {
         alert("New Task");
    }



</script>
<style>
    #listView-Attach .k-grid-header {
        display: none !important;
    }

    .k-alt {
        background-color: #fff;
    }

    .k-in .k-state-hover {
        background-color: #fff;
        border: none;
    }

    .k-state-focused.k-state-selected {
        box-shadow: none;
    }

    .k-state-hover, .k-state-selected, .k-state-focused {
        background-color: #fff;
        border: none;
        background-image: none;
        box-shadow: none;
    }

    .k-checkbox {
        border-radius: 5px;
    }

    .fc-event {
        background-color: #b1acac;
        color: black;
        border: none;
        min-height: 10px;
    }

        .fc-event:hover {
            color: black;
        }

    .k-treelist-group:hover {
        background-color: #fff;
    }

    .k-widget {
        border: none;
    }

    body {
        @*margin-top: 40px;*@
        font-size: 14px;
        font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
    }

    #wrap {
        /*width: 1100px;*/
        width: 100%;
        margin: 0 auto;
    }

    #external-events {
        float: left;
        /*width: 150px;*/
        width: 100%;
        padding: 0 10px;
        /*border: 1px solid #ccc;
        background: #eee;*/
        text-align: left;
    }

        #external-events h4 {
            font-size: 16px;
            margin-top: 0;
            padding-top: 1em;
        }

        #external-events .fc-event {
            /*margin: 10px 0;*/
            cursor: pointer;
        }

        #external-events p {
            margin: 1.5em 0;
            font-size: 11px;
            color: #666;
        }

            #external-events p input {
                margin: 0;
                vertical-align: middle;
            }

    #calendar {
        float: right;
        /*width: 900px;*/
        width: 100%;
    }

    .k-button {
        border: none;
        color: #dbdbdb;
    }

    .k-state-active {
        border: none;
        color: #dbdbdb;
        background-color: #fff;
    }

    .k-button k-sate-focused {
        border: none;
        color: #dbdbdb;
        background-color: #fff;
    }

    .k-button:hover {
        border: none;
        color: #dbdbdb;
        background-color: #fff;
    }
</style>
<style>
    .banner-item {
        color: #fff;
        height: 60px;
        text-align: left;
    }

        .banner-item:hover {
            color: #fff;
        }

    .banner-item-project {
        background-color: #42ca88;
    }

    .banner-item-date {
        background-color: #f0ad4e;
    }

    .k-dropdown-project .k-input {
        display: none !important;
    }

    .project-dropdown ul {
        list-style-type: none;
        margin-bottom: 0px;
    }

    .TASK_STATUS_DRAFT {
        background-color: #17a2b8;
        color: #fff;
    }

    .TASK_STATUS_PLANNED {
        background-color: #9FC5E8;
        color: #fff;
    }

    .TASK_STATUS_INPROGRESS {
        background-color: #007bff;
        color: #fff;
    }

    .TASK_STATUS_PLANNED_OVERDUE {
        background-color: #FFE083;
        color: #fff;
    }

    .TASK_STATUS_OVERDUE {
        background-color: #ffc107;
        color: #fff;
    }

    .TASK_STATUS_COMPLETE {
        background-color: #28a745;
        color: #fff;
    }

    .TASK_STATUS_REJECT {
        background-color: #dc3545;
        color: #fff;
    }

    .TASK_STATUS_CANCEL {
        background-color: #343a40;
        color: #fff;
    }

</style>

<div class="row hr-pad-top-10" style="margin:-15px;">
    <div class="col-md-6">
        <h4>
            Project Planning View
        </h4>
    </div>
</div>
<br />

    <div id='wrap'>
        <br />
        <div class="row">
            <div class="col-md-3">

                <div id='external-events'>
                    
                        <h4>Tasks</h4>
                        <span class="fas fa-plus-circle" style="cursor:pointer" onclick="OnTask('@Model.Id')"> New Task</span>
                   
                        <div id='external-events-list'>
                            <div class="col-md-12">

                                <br />
                                <table id="listView-Attach" style="width:100%">
                                    <colgroup>
                                        <col width="50">
                                        <col width="50">
                                        <col width="10">
                                    </colgroup>
                                    <thead>
                                        <tr>
                                            <th class="fancytreeheader"><div id="Name"></div></th>
                                            <th class="fancytreeheader"><div id="Subject"></div></th>
                                            <th class="fancytreeheader"><div id="edit"></div></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>


                                            <td class="fancytreebody"></td>
                                            <td class="fancytreebody"></td>
                                            <td class="fancytreebody"></td>


                                        </tr>
                                    </tbody>
                                </table>




                            </div>
                            @*@(Html.Kendo().TreeList<ProjectTaskViewModel>()
                   .Name("listView-Attach")
                   .Height(750)
                    //.tem("templateAttach")
                    //.Checkboxes(true)
                    //.DataTextField("Name")
                    //.Events(e => e.Check("OnCheck"))
                    .Columns(columns =>
                    {
                        columns.Add().Field(e => e.Name).Width(200).TemplateId("templateAttach");

                    })
                   .DataSource(dataSource => dataSource
                   .Read(read => read.Action("ReadProjectsTaskForPlanning", "Project", new { projectId = Model.Id }))
                    .Model(m =>
                    {
                        m.Id(f => f.Id);
                        m.ParentId(f => f.ParentId);
                    })

                 )
        )*@
                            @*@Html.Kendo().Button().Name("NewTask").Content(" + New Task").Events(e => e.Click("OnNewTask"))*@
                        <script>
                                function getTree() {
                                    
                                    $("#listView-Attach").fancytree({
                                        extensions: ["table"],
                                        source: $.ajax({
                                            url: "/Pjm/Project/ReadProjectsTaskForPlanning?projectId=@Model.Id",
                                           
                                            dataType: "json"
                                        }),
                                        lazyLoad: function (event, data) {
                                            var node = data.node;
                                            // Issue an Ajax request to load child nodes
                                            data.result = {
                                                url: "/Pjm/Project/ReadProjectsTaskForPlanning?projectId=@Model.Id",
                                                data: { id: node.key }
                                            }

                                        },
                                        renderNode: function (event, data) {
                                            // Optionally tweak data.node.span
                                            // 
                                            //var node = data.node;
                                            //  node.renderTitle();
                                            var node = data.node,
                                                $tdList = $(node.tr).find(">td");
                                         
                                            var date = new Date(node.data.DueDate);
                                            var formatdate = date.getDate() + "/" + (date.getMonth() + 1) + "/" + date.getFullYear();
                                            $tdList.eq(1).text(formatdate);
                                            $tdList.eq(2).html("<span class='fas fa-plus-circle' onclick='SubTask(\"" + node.data.Id + "\", \"" + node.data.ServiceId +"\")'></span>");
                                        },
                                      
                                        dblclick: function (event, data) {
                                          //  data.node.toggleSelected();
                                        },
                                        select: function (event, data) {
                                            
                                            var node = data.node
                                            var s = data.tree.getSelectedNodes();
                                          //  OnSelectWBSItem(node.data.Id, node.data.ParentId, node.data.Type)
                                        },
                                        contextMenu: {
                                            menu: function (data) {
                                                
                                                return {
                                                }
                                            },
                                            actions: function (node, action, options) {
                                            }
                                        }
                                    });

                                }

                                $(function () {
                                    getTree();

                                   
                                });
                        </script>


                            <script type="text/x-kendo-tmpl" id="templateAttach">
                            <span style="display:inline-flex">
                                <span class='fc-event #=ProjectStatusCode#' id='#:Id#' style="cursor:pointer;width:200px;" onclick="EditTask(#:Id#)">
                                    <span style="font-weight:bold">#:Name#</span>
                                    <br />
                                    <span>#: UserName #</span> -
                                    <span>
                                        #: kendo.toString(, "dd-MMM-yyyy") #
                                    </span>
                                </span>
                                <span class="fas fa-plus-circle" onclick="SubTask('#:Id#','#:ServiceId#')"></span>
                            </span>
                            @*#if(!item.hasChildren){#
                <button> + New Sub Task</button>

                #}#*@

                            </script>
                        </div>

                    @*<p>
                            <input type='checkbox' id='drop-remove' />
                            <label for='drop-remove'>remove after drop</label>
                        </p>*@
                </div>
            </div>
            <div class="col-md-9">
                <div id='calendar'></div>
            </div>


        </div>




        <div style='clear:both'></div>

    </div>



    <script>
        function SubTask(parentId,serviceId) {
         var portalId = $('#GlobalPortalId').val();
           $.ajax({
               url: '/pjm/projecttask/GetSubTaskSequenceOrder',
                type: 'GET',
               data: { parentId: parentId },
                success: function (res) {
                    var prms = encodeURIComponent('parentServiceId=' + serviceId +'&parentTaskId=' + parentId +'&servicePlusId=@Model.Id&sequenceOrder='+res.count);
        // var prms = encodeURIComponent('parentServiceId=@Model.Id&parentTaskId=' + parentTaskId);
         var url = '/Cms/Page?lo=Popup&cbm=OnAfterTaskCreate&source=Create&dataAction=Create&pageName=ProjectTask&portalId=' + portalId + '&prms=' + prms;

                    LoadCmsPartialView(url, 'Task', true, 1200, 650, '@Html.Raw(SharedResource["CreateSubTask"])');
                }
            });

    }
    function OnTask(parentId) {
        var portalId = $('#GlobalPortalId').val();

           $.ajax({
               url: '/pjm/projecttask/GetTaskSequenceOrder',
                type: 'GET',
               data: { parentId: parentId },
                success: function (res) {
                    var prms = encodeURIComponent('parentServiceId=' + parentId +'&servicePlusId=@Model.Id&sequenceOrder='+res.count);

                    var url = '/Cms/Page?lo=Popup&cbm=OnAfterTaskCreate&source=Create&dataAction=Create&pageName=ProjectTask&portalId=' + portalId + '&prms=' + prms;
          var win = GetMainWindow();
          win.iframeOpenUrl = url;
          win.OpenWindow({ Title: '@Html.Raw(SharedResource["CreateTask"])', Width: 1200, Height: 600 });
                }
            });

            return false;
    }
     function EditTask(Id) {
          var portalId = $('#GlobalPortalId').val();
         // var prms = encodeURIComponent('parentServiceId=' + Id);
         var url = '/Cms/Page?lo=Popup&popup=true&cbm=OnAfterTaskCreate&source=View&dataAction=View&pageName=ProjectTask&portalId=' + portalId + '&recordId=' + Id;

         //LoadCmsPartialView(url, 'Task', true, 1200, 650, 'Edit Task');
         var win = GetMainWindow();
         win.iframeOpenUrl = url;
         win.OpenWindow({ Title: '@Html.Raw(SharedResource["ViewTask"])', Width: 1200, Height: 600 });
    }

    </script>

