@using Synergy.App.DataModel
@using Synergy.App.ViewModel
@using Synergy.App.Common;
@*@using Kendo.Mvc.UI*@
@{
    Layout = "~/Areas/Core/Views/Shared/_PopupLayout.cshtml";
    //Layout = null;
}
@model NotificationSearchViewModel


<style>
    .notification-title {
        background-color: #c1972a;
        border-bottom-left-radius: 0px;
        border-bottom-right-radius: 0px;
        height: 40px;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
        display: flex;
        align-content: center;
        text-align: center;
    }
</style>

<style>
    .arrow_box {
        position: relative;
        background: #f2f2f2;
        border: 1px solid #808080;
    }

        .arrow_box:after, .arrow_box:before {
            bottom: 100%;
            left: 50%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }

        .arrow_box:after {
            border-color: rgba(242, 242, 242, 0);
            border-bottom-color: #f2f2f2;
            border-width: 15px;
            margin-left: -15px;
        }

        .arrow_box:before {
            border-color: rgba(128, 128, 128, 0);
            border-bottom-color: #808080;
            border-width: 16px;
            margin-left: -16px;
        }

    .notification-item {
        padding: 0px;
        border-radius: 0px !important;
        border-bottom: none !important;
    }

    .notification-heading {
        padding: 0px !important;
        height: 75px;
        border-left-style: solid;
        border-left-width: 20px;
        border-top-left-radius: 0px;
        border-bottom-left-radius: 0px;
    }

    .notification-user {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        cursor: default;
    }



    #content_popup {
        font-family: "Segoe UI",Verdana,Helvetica,Sans-Serif;
    }

    .panel {
        margin-top: 0px !important;
    }
</style>
@*@if (ViewBag.IframeMode != "Iframe")
    {*@
<div style="margin-top: 5px;padding-left: 20px;padding-right: 20px;width: 100%;">
    <div id="content_popup" style="width:450px;">
        <div class="notification-title">
            <h5 style="width:100%;padding-top:4px;">Notifications</h5>
        </div>
        <div class="panel-group" id="accordion">

            @{
                int counter = 0, flag = 0;
            }
            @if (Model.Notifications != null)
            {
                @foreach (var item in Model.Notifications)
                {
                    counter++;
                    var subj = "";
                    var duedt = "";
                    var body = item.Body;
                    string[] split = body.Split(new string[] { "<p>", "</p>",
"<table cellpadding='5' cellspacing='0' style='width:100%;border:1 solid \\#bfbfbf;border-collapse:collapse;font-family:Verdana;font-size:12px;'><tr><td colspan='2' style='padding:6px;text-align:center;font-weight:bold;background-color:\\#d3d3d3;'>",
"<td style='padding:6px;border:1 solid \\#bfbfbf;text-align:center;font-weight:bold;background-color:\\#d3d3d3;'>", "<tr>", "</tr>", "</td>", "<td>" }, StringSplitOptions.None);
                    foreach (string s in split)
                    {
                        if (s.Trim() != "")
                        {
                            switch (flag)
                            {
                                case 1:
                                    subj = s;
                                    flag = 0;
                                    break;
                                case 2:
                                    duedt = s;
                                    flag = 0;
                                    break;
                                default:
                                    break;
                            }
                            if (s.Trim() == "Subject")
                            {
                                flag = 1;
                            }
                            if (s.Trim() == "Due Date")
                            {
                                flag = 2;
                            }
                        }
                    }

                    <div class="panel notification-item" style="margin:16px;">
                        <div data-toggle="collapse" data-target="#collapse-@counter" id="dynbutton-@counter" class="panel-heading notification-heading row no-gutter" style="border-left-color:@(@item.ReadStatusString == "NotRead" ? "#4CAF50" : "rgba(0,0,0,0.3)");">
                            <div class="col-xs-2" style="height:73px;padding-left:5px;padding-top:5px;">
                                @if (item.PhotoId != null && item.PhotoId != "")
                                {
                                    <img class="notification-user" onerror='OnPhotoError(this,"@item.From");' src="/cms/Document/GetImageMongo?id=@item.PhotoId" />
                                }
                                else
                                {
                                    <img class="notification-user" src="~/images/profile.jpg" style="text-align: center;">
                                }

                            </div>
                            <div class="col-10 row" style="height:73px;padding-top:5px;">
                                @*<div class="row">*@
                                <div class="col-12" style="font-size:.7eM;">Reference: @item.ReferenceTypeNo</div>
                                @*<div class="col-4" style="font-size:.9eM;">

                                    </div>*@
                                @*</div>*@
                                <div class="col-12" style="font-size:.7eM;">From : @item.From</div>
                                <div class="col-12" style="font-size:.7eM;">Subject : @item.Subject @*@(@subj != "" ? @subj : @item.Subject)*@</div>
                            </div>
                        </div>
                        <div id="collapse-@counter" class="panel-collapse collapse">
                            <div class="panel-body" style="font-size:0.7em;">
                                <p> From : @item.From</p>
                                <p> Date : @item.CreatedDate</p>
                                <p> Subject : @item.Subject</p>
                                <p> Description : @Html.Raw(@item.Body)</p>
                                @*<a href="/Recruitment/notification/UpdateReadNotification?Id=@item.Id" onclick="return TakeActionClick();">Take Action</a>*@
                            </div>
                        </div>
                    </div>

                }
            }


            <div class="list-group-item" style="text-align:center;">
                @*<a style="font: bolder" title="View All" href="#" onclick="showNotification(); return false;">
                        Go to Inbox
                    </a>*@
                <a @*style="font: bolder; margin-left:50%"*@ style="font: bolder;" title="View All" href="#" onclick="clearAllNotification(); return false;">
                    Clear All
                </a>
            </div>

            @*<div class="notification-item list-group-item row no-gutter" style="padding:0px;height:70px;">
                    <div class="col-xs-2" style="height:68px;border-left:15px solid yellow;padding-left:5px;padding-top:5px;">
                        <img class="task-user-photo" onerror='OnPhotoError(this,"D");' src="/general/file/photo?@(Constant.QueryStringVersionParam)" />
                    </div>
                    <div class="col-xs-10" style="height:68px;padding-left:10px;padding-top:5px;">
                        <div>Reference</div>
                        <div>Text</div>
                        <div>User</div>
                    </div>
                </div>
                <div class="notification-item list-group-item row no-gutter" style="padding:0px;height:70px;">
                    <div class="col-xs-2" style="height:68px;border-left:15px solid yellow;padding-left:5px;padding-top:5px;">
                        <img class="task-user-photo" onerror='OnPhotoError(this,"E");' src="/general/file/photo?@(Constant.QueryStringVersionParam)" />
                    </div>
                    <div class="col-xs-10" style="height:68px;padding-left:10px;padding-top:5px;">
                        <div>Reference</div>
                        <div>Text</div>
                        <div>User</div>
                    </div>
                </div>*@

        </div>

    </div>
</div>

<script type="text/javascript">

    function TakeActionClick(e)
    {
        showLoader();
        localStorage.setItem("openAgain", true);
    }
    function hideLoader() {
        document.getElementById('speach-load').style.display = "none";
    }

    function showLoader() {
        document.getElementById('speach-load').style.display = "unset";
        document.getElementById('speech-srch').innerText = "Loading...";
        $(".main-menu").css("z-index", '2');
        $(".skitt-ui").css("z-index", '2');
    }
    function UpdateNotification(id) {
        $.ajax({
            url: "/Recruitment/notification/UpdateReadNotification?Id=" + id,
            contentType: "application/json",
            cache: false,
            success: function (result) {
            },
            error: function (xhr, textStatus, errorThrown) {
                // alert(errorThrown);
            }
        });
    }

    function loadCollapsible() {
        var coll = document.getElementsByClassName("collapsible");
        var i;

        for (i = 0; i < coll.length; i++) {
            coll[i].addEventListener("click", function () {
                this.classList.toggle("active");
                var content = this.nextElementSibling;
                if (content.style.display === "block") {
                    content.style.display = "none";
                } else {
                    content.style.display = "block";
                }
            });
        }
        if (i < 10) {
            $('#content_popup').removeClass('slide_scroll');
        }
    }
    function showNotification() {
        window.location.href = "/general/notification/index?layout=@ViewBag.Layout";
    }

    function showNotificationParent() {

        window.parent.location.href = "/general/notification/";
    }

    $(document).ready(function () {
        //loadCollapsible();
        //$('.panel-body').find('a').attr('target', '_blank');
    });
    function clearAllNotification() {
        $.ajax({
            url: "/cms/UpdateAllReadNotification",
            contentType: "application/json",
            cache: false,
            success: function (result) {
                RefreshNotification();
                
                var win = GetMainWindow();
                win.CloseWindow();
                return false;
            },
            error: function (xhr, textStatus, errorThrown) {
                // alert(errorThrown);
            }
        });
        }
        function openNotificationAction(url)
        {
            window.parent.iframeOpenUrl = url;
               var win = GetMainWindow();
               win.OpenWindow({ Title: 'Notifications', Width: 1200, Height: 1200 });
    }
    function RefreshNotification() {
        var win = GetMainWindow().GetParentWindow();
        win.RefreshNotification();
    }
</script>

