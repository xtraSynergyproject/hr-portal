@using Synergy.App.ViewModel;
@using Synergy.App.Common;
@{
    ViewData["Title"] = "My Complaints";
    Layout = null;
}

<div style="padding:2%">
    <br>
    <h3>My Complaints</h3>
    <br />
    <button class="btn btn-primary" onclick="onCreateService()">Lodge New Complaint</button>
    <br>
    <br>
    <div id="grievance" style="width: 100%;height:550px" class="ag-theme-alpine"></div>
</div>
<script>


    var columnDefs = [
        {
            headerName: "Complaint No",
            field: "ServiceNo",
            //cellRenderer: params => {
            //    return "<input title='View Details' type='button' class='btn btn-link' onclick='OpenService(\"" + params.data.Id + "\",\"" + params.data.TemplateCode + "\" )' value=\"" + params.value + "\" />";
            //}
            cellRenderer: params => {
                var a ="";
                //if (params.data.IsFlag) {
                //    a = "<span title='Flagged' style='color:red;cursor:pointer' class='fas fa-flag'></span>";
                //} 
                //if (params.data.ReopenCount > 0) {
                //    a = a + " <span title='Reopened' style='color:blue;cursor:pointer' class='fas fa-rotate-right'></span>";
                //} else {
                //}
                return a + "<input title='View Details' type='button' class='btn btn-link' onclick='OpenService(\"" + params.data.Id + "\",\"" + params.data.TemplateCode + "\" )' value=\"" + params.value + "\" />";

            }
        },
        {
            headerName: "Department",
            field: "Department",
        },
        {
            headerName: "Complaint Type",
            field: "GrievanceType",

        },
         {
            headerName: "Complaint Status",
            field: "GrvStatus",
            cellRenderer: params => {
                if (params.data.GrvStatusCode == null || params.data.GrvStatusCode == "GRV_PENDING") { return "<div style='background-color:#f7f5bc;padding-left:10px'>  Pending</div>"; }
                if (params.data.GrvStatusCode == "GRV_IN_PROGRESS") { return "<div style='background-color:#DFE9F5;padding-left:10px'>  " + params.value + "</div>"; }
                if (params.data.GrvStatusCode == "GRV_NOT_PERTAINING") { return "<div style='background-color:#FFCD91;padding-left:10px'>   " + params.value + "</div>"; }
                if (params.data.GrvStatusCode == "GRV_DISPOSED") { return "<div style='background-color:#90EE90;padding-left:10px'>   " + params.value + "</div>"; }
                else { return params.value; }
            }
        },
        {
            headerName: "Complaint Date",
            field: "CreatedDate",
            cellRenderer: params => {
                var date = new Date(params.value);
                return datefun(date);
            }
        },

    ];
        getGrievanceData();


    function getGrievanceData() {
        gridConfig(
            "grievance",
            "/EGov/SmartCity/GetJSCMyComplaint",
            columnDefs,
            false,
            true,
            true,
            true,
            1,
            true,
            10);
    }

    function datefun(d) {
        let h = addZero(d.getHours());
        let m = addZero(d.getMinutes());

        return d.getDate() + "-" + (d.getMonth() + 1) + "-" + d.getFullYear() + " " + h + ":" + m;
    }

    function addZero(i) {
        if (i < 10) { i = "0" + i }
        return i;
    }

    function OpenService(serviceId) {

           var portalId = $('#GlobalPortalId').val();
        var url = '/EGov/SmartCity/ManageGrievanceForm?complaintId=' + serviceId;
        var win = GetMainWindow();
        win.iframeOpenUrl = url;
        win.OpenWindow({ Title: 'View Complaint', Width: 1200, Height: 700 });
        return false;
    }

    function onCreateService(serviceId) {

        var portalId = $('#GlobalPortalId').val();
        var url = '/EGov/SmartCity/ManageGrievanceForm';
        var win = GetMainWindow();
        win.iframeOpenUrl = url;
        win.OpenWindow({ Title: 'New Complaint', Width: 1200, Height: 700 });
        return false;
    }


    function OpenTask(taskId, tempCode) {

        var id = taskId;
        var source = '@RequestSourceEnum.Edit.ToString()';
        var action = '@DataActionEnum.Edit.ToString()';

        var portalId = $('#GlobalPortalId').val();

        var url = '/Cms/Page?lo=Popup&pageType=Task&cbm=OnAfterService&source=' + source + '&dataAction=' + action + '&templateCodes=' + tempCode + '&portalId=' + portalId + '&recordId=' + id;
        var win = GetMainWindow();
        win.iframeOpenUrl = url;
        win.OpenWindow({ Title: "Task", Width: 1200, Height: 600 });
        return false;
    }

    function OnAfterService() {
        getGrievanceData();
    }

    function RefreshComplaintGrid(msg) {
        debugger;
        getGrievanceData();
        myalert(msg);
    }


    function myalert(content) {
        debugger;
        $("<div></div>").kendoAlert({
            title: "Submission Confirmation",
            content: content.msg
        }).data("kendoAlert").open();
    }

</script>