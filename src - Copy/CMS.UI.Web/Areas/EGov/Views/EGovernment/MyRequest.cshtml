@using CMS.UI.ViewModel;
@using CMS.Common;
@using Kendo.Mvc.UI;
@using Newtonsoft.Json;
@{
    Layout = null;
}
@model CustomIndexPageTemplateViewModel

<link href="~/css/EGOV/MyRequest.css" rel="stylesheet" asp-append-version="true" />
<link href="~/css/EGOV/DashBoardStyles.css" rel="stylesheet" asp-append-version="true" />
<link href="~/css/EGOV/Dashboard-Navigation-with-Button.css" rel="stylesheet" asp-append-version="true" />
<script>

    $(document).ready(function () {
            $("#status").kendoMultiSelect({
            dataTextField: "Name",
            dataValueField: "Id",
            dataSource: new kendo.data.DataSource({
                transport: {
                    read: {
                        url: "/CMS/LOV/GetLOVIdNameList?lovType=LOV_SERVICE_STATUS",
                        dataType: "json"
                    }
                },
            }),
            autoClose: false,
            placeholder: "--All--",
            value: @Html.Raw(JsonConvert.SerializeObject(Model.Status)),
            valuePrimitive: true,
            serverFiltering: true,
            filter: '@FilterType.Contains',
            });

        $("#templates").kendoMultiSelect({
            dataTextField: "DisplayName",
            dataValueField: "Id",
            dataSource: new kendo.data.DataSource({
                transport: {
                    read: {
                        url: "/Cms/Template/ReadTemplateListByCategoryCodes?categoryCodes=@Model.CategoryCodes",
                        dataType: "json"
                    }
                },
            }),
            autoClose: false,
            placeholder: "--All--",
            value: @Html.Raw(JsonConvert.SerializeObject(Model.Status)),
            valuePrimitive: true,
            serverFiltering: true,
            filter: '@FilterType.Contains',
        });

        $("#FromDate").kendoDatePicker();
        $("#ToDate").kendoDatePicker();
    });

    function OnDatabound(e) {
        $("#kgrid_AllServices tbody tr").each(function () {
            var currentDataItem = $("#kgrid_AllServices").data("kendoGrid").dataItem($(this));
            if (currentDataItem.ServiceStatusCode !== 'SERVICE_STATUS_DRAFT') {
                var del = $(this).find(".action-delete");
                del.hide();
            }
        });
    }

    @*function ReloadIndexPage(res) {
        var id = '@Model.Page.Id';
        var type = '@Model.Page.PageType.ToString()';
        var source = '@RequestSourceEnum.View.ToString()';
        var action = '@DataActionEnum.View.ToString()';
        LoadPageById(id, type, source, action);
    }*@
        function OnServiceCreate() {
            var portalId = '@Model.PortalId';
            var url = '@Url.Action("SelectServiceTemplate", "NtsService",new {area="Cms" })?cbm=ReloadIndexPage&templateCode=@Model.TemplateCodes&categoryCode=@Model.CategoryCodes&userId=' + '@ViewBag.UserId';
            var win = GetMainWindow();
            win.iframeOpenUrl = url;
            win.OpenWindow({ Title: '@Model.TemplateSelectionPopupDefaultTitle', Width: 1200, Height: 650 });
            return false;
    }
    function OnView(serId, tempCode, stcode, temName) {
        debugger;
        //var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        var source = '@RequestSourceEnum.View.ToString()';
        var action = '@DataActionEnum.View.ToString()';
        if (stcode === 'SERVICE_STATUS_DRAFT') {
        source = "Edit";
        action = "Edit";
        }
        var title = temName;
        var portalId = '@Model.PortalId';
        var url = '/Cms/Page?lo=Popup&pageType=Service&cbm=ReloadIndexPage&source=' + source + '&dataAction=' + action + '&templateCodes=' + tempCode + '&portalId=' + portalId + '&recordId=' + serId;
        var win = GetMainWindow();
        win.iframeOpenUrl = url;
        win.OpenWindow({ Title: title, Width: 1200, Height: 600 });
        return false;
    }
    function OnEdit(serId, tempCode, temName) {
        debugger;
       // var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        var source = '@RequestSourceEnum.Edit.ToString()';
        var action = '@DataActionEnum.Edit.ToString()';
        var portalId = '@Model.PortalId';
        var title = temName;
        var url = '/Cms/Page?lo=Popup&pageType=Service&cbm=ReloadIndexPage&source=' + source + '&dataAction=' + action + '&templateCodes=' + tempCode + '&portalId=' + portalId + '&recordId=' + serId;
        var win = GetMainWindow();
        win.iframeOpenUrl = url;
        win.OpenWindow({ Title: title , Width: 1200, Height: 600 });
        return false;
    }

    var deleteEvent = null;
    function OnDelete(ServiceId) {
        @*if ('@Model.EnableDeleteConfirmation'==='True')
        {
            deleteEvent = ServiceId;
            $('#confirmDelete').data("kendoDialog").open();
        }
        else
        {
            DeleteItem(ServiceId);
        }*@
        var flag = confirm('Do you really want to delete the service?');

        if (flag) {
            $.ajax({
                url: '@Url.Action("DeleteService", "NtsService", new { @area="Cms"})?serviceId=' + ServiceId,
                type: 'POST',
                data: {},
                dataType: 'json',
                success: function (result) {

                    if (result.success) {
                        GetData_kgrid_AllServices();
                        ShowNotification("Service Deleted Successfully", "success");
                    }
                },
                error: function (ert) {
                    ShowNotification(ert, "error");
                }
            });
            return false;
        }
    }

    function ConfirmDelete() {
        $('#confirmDelete').data("kendoDialog").close();
        DeleteItem(deleteEvent);
    }

    @*function DeleteItem(ServiceId) {
       // var dataItem = $("#kgrid_OwnerOrRequester").data("kendoGrid").dataItem($(e.currentTarget).closest("tr"));
        var id = '@Model.Page.Id';
        var type = '@Model.Page.PageType.ToString()';
        var source = '@RequestSourceEnum.Post.ToString()';
        var action = '@RequestSourceEnum.Delete.ToString()';
        LoadPageById(id, type, source, action, ServiceId);
        return false;
    }*@

    function onFilter() {
        var statusIds = $("#status").data("kendoMultiSelect").value();
        var templateIds = $("#templates").data("kendoMultiSelect").value();
        var fromDate = kendo.toString($("#FromDate").data("kendoDatePicker").value(), 'yyyy/MM/dd');
        var toDate = kendo.toString($("#ToDate").data("kendoDatePicker").value(), 'yyyy/MM/dd');
        var serno = $("#srchtext").val();

        var newurl = "/EGov/EGovernment/GetMyRequestList?showAllOwnersService=@Model.ShowAllOwnersService&moduleCodes=@Model.ModuleCodes&templateCodes =@Model.TemplateCodes&categoryCodes=@Model.CategoryCodes&statusIds=" + statusIds + "&templateIds=" + templateIds + "&From=" + fromDate + "&To=" + toDate + "&search=" + serno;
        GetData_kgrid_AllServices(newurl);
    }

    function onFilterReset() {
        $("#status").data("kendoMultiSelect").value("");
        $("#templates").data("kendoMultiSelect").value("");
        $("#FromDate").data("kendoDatePicker").value("");
        $("#ToDate").data("kendoDatePicker").value("");
        $("#srchtext").val("");
        GetData_kgrid_AllServices();
        }
        $('#left').click(function (event) {
            debugger;
            event.preventDefault();
            $('#paymentdues').animate({
                scrollLeft: "-=1075px"
            }, "slow");
        });

        $('#right').click(function (event) {
            debugger;
            event.preventDefault();
            $('#paymentdues').animate({
                scrollLeft: "+=1075px"
            }, "slow");
        });

        $('#reqleft').click(function (event) {
            debugger;
            event.preventDefault();
            $('#services').animate({
                scrollLeft: "-=1075px"
            }, "slow");
        });

        $('#reqright').click(function () {
            debugger;
            event.preventDefault();
            $('#services').animate({
                scrollLeft: "+=1075px"
            }, "slow");

        });

        function CreateService(templatecode) {
            var portalId = $('#GlobalPortalId').val();

            var url = '/Cms/Page?lo=Popup&source=Create&dataAction=Create&templateCodes=' + templatecode + '&portalId=' + portalId;
            var win = GetMainWindow();
            win.iframeOpenUrl = url;
            win.OpenWindow({ Title: 'Create Request', Width: 1200, Height: 700 });
            return false;
        }

        function OnViewServiceList(status, tempCode) {
            debugger;
            if (status == "SERVICE_STATUS_INPROGRESS") {
                status = "SERVICE_STATUS_INPROGRESS,SERVICE_STATUS_OVERDUE";
            } else if (status == "SERVICE_STATUS_REJECT") {
                status = "SERVICE_STATUS_REJECT,SERVICE_STATUS_CANCEL";
            }
            var url = '/EGov/EGovernment/ServiceList?statusCodes=' + status + "&templateCode=" + tempCode;
            var win = GetMainWindow();
            win.iframeOpenUrl = url;
            win.OpenWindow({ Title: 'Service List', Width: 1200, Height: 600 });
            return false;
        }
</script>

    <div><br/>
        <div class="row" style="margin-top:10px;">
            <div class="col-6">
                <h4 class="listheading">MY REQUESTS</h4>
            </div>
            <div class="col-6">
                <button style="float:right" id="reqright" class="scrollbtn"><i class="fas fa-chevron-right"></i></button>
                <button style="float:right" id="reqleft" class="scrollbtn"><i class="fas fa-chevron-left"></i></button>

            </div>
        </div>

        <div class="d-flex flex-row flex-nowrap overflow-hidden" id="services">
            <div class="box" style=" overflow: unset; display: flex;">
                @foreach (var item in Model.ServiceList)
                {
                    <div class="box indiv-block-bg">
                        <div class="row tempheader">
                            <div class="col">
                                <div class="title-bg"><label>@item.ServiceName</label></div>
                            </div>
                        </div>
                        <div class="row sercount">
                            <div class="col text-primary" style="text-align:center;" onclick="OnViewServiceList('SERVICE_STATUS_INPROGRESS','@item.TemplateCode')">
                                <label class="amount">@item.InProgressCount</label>
                                <br />
                                <label style="font-size:14px;font-weight:500">Pending</label>
                                <!--<div>
                                <div class="L-block">-->
                                @*<img class="service-img" src="assets/img/ico-property-tax.png">*@
                                <!--</div>
                                    <div class="R-block"></div>
                                </div>-->
                            </div>
                            <div class="col text-success" style="text-align:center;" onclick="OnViewServiceList('SERVICE_STATUS_COMPLETE','@item.TemplateCode')">
                                <label class="amount">@item.CompletedCount</label>
                                <br />
                                <label style="font-size:14px;font-weight:500">Completed</label>
                                <!--<div>
                                <div class="L-block">-->
                                @*<img class="service-img" src="assets/img/ico-property-tax.png">*@
                                <!--</div>
                                    <div class="R-block"></div>
                                </div>-->
                            </div>
                            <div class="col text-danger" style="text-align:center;" onclick="OnViewServiceList('SERVICE_STATUS_REJECT','@item.TemplateCode')">
                                <label class="amount">@item.RejectedCount</label>
                                <br />
                                <label style="font-size:14px;font-weight:500">Rejected</label>
                                <!--<div>
                                <div class="L-block">-->
                                @*<img class="service-img" src="assets/img/ico-property-tax.png">*@
                                <!--</div>
                                    <div class="R-block"><label class="amount">@item.RejectedCount</label></div>
                                </div>-->
                            </div>
                        </div>

                        @*<div class="row">
                                <div class="col">
                                    <div class="dates-block">
                                        <div class="row">
                                            <div class="col-4">
                                                <div class="bill-date"><label class="sub-lable">Requested Date</label><label class="field-value">@item.BillDate</label></div>
                                            </div>
                                            <div class="col-4">
                                                <div class="due-date"><label class="sub-lable">Due Date</label><label class="field-value">@item.DueDate<br></label></div>
                                            </div>
                                            <div class="col-4">
                                                <div class="status"><label>@item.Status</label></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>*@
                    </div>
                }

            </div>
        </div>

    </div><br/>
    <div class="row no-gutters">
        @if (Model.EnableCreateButton)
        {
            <div class="col-12 pb-2">
                <button type="button" class="btn btn-primary" onclick="return OnServiceCreate();"><i class="fa fa-plus pr-1"></i>Create Service</button>
            </div>
        }
        <div class="container col-12">
            <script>
                        var columnDefs = [
                            {
                                headerName: "Actions",
                                field: "ServiceId",
                                cellRenderer: params => {
                                    return "<div class='btn-group grid-menu' id='tree-mrnu' data-idvalue='" + params.value + "' data-tempcode='" + params.data.TemplateCode + "' data-sscode='" + params.data.ServiceStatusCode + "' data-tename='" + params.data.TemplateDisplayName+ "'><i class='fas fa-ellipsis-v'></i></div>"
                                }
                            },
                            //{
                            //    headerName: "Complaint Title",
                            //    field: "ServiceSubject",
                            //},
                            {
                                headerName: "Request No",
                                field: "ServiceNo",
                            },
                            {
                                headerName: "Request Type",
                                field: "TemplateDisplayName",
                            },
                            {
                                headerName: "Requested Date",
                                field: "CreatedDate",
                                cellRenderer: params => {
                                    var date = new Date(params.value);
                                    var d = new Date(date),
                                        month = '' + (d.getMonth() + 1),
                                        day = '' + d.getDate(),
                                        year = d.getFullYear();

                                    if (month.length < 2)
                                        month = '0' + month;
                                    if (day.length < 2)
                                        day = '0' + day;

                                    return [day, month, year].join('.');
                                }
                            },
                            {
                                headerName: "Request Status",
                                field: "ServiceStatusName",
                            },

                        ];
                        $(function () {
                            GetData_kgrid_AllServices();
                             $.contextMenu({
                                selector: '#tree-mrnu',
                                trigger: 'left',
                                build: function ($trigger, e) {

                                    var id = $trigger.data('idvalue');
                                    var tcode = $trigger.data('tempcode');
                                    var scode = $trigger.data('sscode');
                                    var tpname = $trigger.data('tename');
                                    switch (scode) {
                                        case "SERVICE_STATUS_DRAFT":
                                            return {
                                                callback: function (key, options) {
                                                    switch (key) {
                                                        case 'edit':
                                                            OnEdit(id, tcode, tpname);
                                                            break;
                                                        case 'view':
                                                            OnView(id, tcode, scode, tpname);
                                                            break;
                                                        case 'delete':
                                                            OnDelete(id);
                                                            break;
                                                        default:
                                                    }
                                                },
                                                items: {
                                                    "edit": { name: "Edit", icon: "fas fa-edit" },
                                                    "view": { name: "View", icon: "fas fa-eye" },
                                                    "delete": { name: "Delete", icon: "fas fa-trash" },
                                                }
                                            };
                                        default:
                                            return {
                                                callback: function (key, options) {
                                                    switch (key) {
                                                        case 'edit':
                                                            OnEdit(id, tcode, tpname);
                                                            break;
                                                        case 'view':
                                                            OnView(id, tcode, scode, tpname);
                                                            break;
                                                        default:
                                                    }
                                                },
                                            items: {
                                                    "edit": { name: "Edit", icon: "fas fa-edit" },
                                                    "view": { name: "View", icon: "fas fa-eye" },
                                                }
                                            };
                                    }
                                }
                            });
                        });

                        function GetData_kgrid_AllServices(url) {
                            document.getElementById("kgrid_AllServices").innerHTML = "";
                            var Url = "";
                            if (url != null && url != "") {
                                Url = url;
                            } else {
                                Url = "/EGov/EGovernment/GetMyRequestList?showAllOwnersService=@Model.ShowAllOwnersService&moduleCodes=@Model.ModuleCodes&templateCodes =@Model.TemplateCodes&categoryCodes=@Model.CategoryCodes";
                            }

                            gridConfig(
                                "kgrid_AllServices",
                                Url,
                                columnDefs,
                                false,
                                true,
                                true,
                                true,
                                1,
                                true,
                                10);
                        }
            </script>

            <div class="row" style="padding-top:10px;">
                <div class="col-12">
                    <div class="panel panel-filter">
                        <div class="panel-heading">Filter</div>
                        <div class="panel-body">
                            <div class="row" style="padding:5px;">
                                <div class="col-6">
                                    Request Type<br />
                                    <select id="templates" data-placeholder="--All--" style="width:85%;"></select>
                                </div>
                                <div class="col-6">
                                    Request Status<br />
                                    <select id="status" data-placeholder="--All--" class="srchitem"></select>
                                </div>

                            </div>
                            <div class="row" style="padding:5px;">
                                <div class="col-3">
                                    From<br />
                                    <input id="FromDate" class="datefield" />
                                </div>
                                <div class="col-3">
                                    To<br />
                                    <input id="ToDate" class="datefield" />
                                </div>
                                <div class="col-3">
                                    Service No
                                    <input type="text" class="form-control srchitem" id="srchtext" placeholder="Service No" />
                                </div>
                                <div class="col-3 filter-btngrp">
                                    <br />
                                    <button class="btn btn-light" style="cursor:pointer" onclick="onFilterReset()" title="Reset Filter">Reset</button>
                                    <button class="btn btn-primary" style="cursor:pointer" onclick="onFilter()" title="Filter">Filter</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="kgrid_AllServices" class="ag-theme-alpine gridReq"></div>

            @*@(Html.Kendo().Dialog()
            .Name("confirmDelete")
            .Title("Confirm Delete")
            .Content(Model.DeleteConfirmationMessage)
            .Width(400)
            .Modal(true)
            .Visible(false)
            .Actions(actions =>
            {
                actions.Add().Text("Cancel");
                actions.Add().Text("Continue Delete").Primary(true).Action("ConfirmDelete");
            }))*@
        </div>
    </div>

